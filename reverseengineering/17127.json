{
    "title": "How to reverse engineer a Windows 10 UWP app?",
    "link": "https://reverseengineering.stackexchange.com/questions/17127/how-to-reverse-engineer-a-windows-10-uwp-app",
    "content": "<div class=\"s-prose js-post-body\" itemprop=\"text\">\n<p>I wanted to see what Microsoft are doing when you click \"Restart now\" button in their Settings -&gt; Update window on Windows 10:</p>\n<p><a href=\"https://i.sstatic.net/YitFy.png\" rel=\"noreferrer\"><img alt=\"enter image description here\" src=\"https://i.sstatic.net/YitFy.png\"/></a></p>\n<p>Somehow the results are not the same what is available via <code>InitiateSystemShutdownEx</code> or <code>InitiateShutdown</code> WinAPIs, especially concerning installation of updates.</p>\n<p>So I wanted to look into the code they use for that <code>Restart</code> button. Usually I would use Spy++ to look up a parent window's <code>WndProc</code> and then load the process in IDA Pro and put a breakpoint on it. Then trap a condition for the <code>BM_CLICK</code> message.</p>\n<p>In this case though, the whole settings is a window of its own. The button does not appear in Spy++:</p>\n<p><a href=\"https://i.sstatic.net/eECa5.png\" rel=\"noreferrer\"><img alt=\"enter image description here\" src=\"https://i.sstatic.net/eECa5.png\"/></a></p>\n<p>Any ideas how do I proceed from there?</p>\n</div>",
    "votes": "35",
    "answers": 4,
    "views": "17k",
    "tags": [
        "ida",
        "debugging",
        "windows-10"
    ],
    "user": "c00000fd",
    "time": "Jan 5, 2018 at 22:54",
    "comments": [
        {
            "user": "dsasmblr",
            "text": "<span class=\"comment-copy\">I'd love to see someone offer an approach to this. Maybe consider starting a bounty at this point to garner more interest from the heavy-hitters?</span>",
            "time": null
        },
        {
            "user": "c00000fd",
            "text": "<span class=\"comment-copy\">@dsasmblr: Here you go. Wiped out on the points. Hopefully someone can answer it.</span>",
            "time": null
        }
    ],
    "answers_data": [
        {
            "content": "<div class=\"s-prose js-post-body\" itemprop=\"text\">\n<p>I have thought carefully before adding this as \"<em>Another Answer</em>\" rather than editing my existing answer that I posted above this morning.</p>\n<p>I feel that this answer deserves another post of its own as it's not just a simple continuation of the material posted in my answer above.</p>\n<p>I have spent over 2 hours on this post to avoid just <em>cutting and pasting</em> content from other sites.\nWhat I have focussed on rather, is on the point that I only include content in this post here, such that this answer  would still remain relevant even if the original websites (from where this content is taken from) would ever go down in the future.</p>\n<p>I am  trying to focus on the essentials that would enable us to hook and modify the code  in  UWP Apps, as asked by the OP.  </p>\n<h1><strong>Hacking and Modding Windows Universal Apps :</strong></h1>\n<p>DLL-Injection and Function-Hooking, work perfectly fine in UWP-Apps with most, if not all, injection and hooking techniques.</p>\n<p><strong>A couple of main differences regarding Function Hooking and Dll Injection, between the UWP apps and the \"standard\" Win32 apps :</strong></p>\n<p><strong>First:</strong><br/>\nThe Window, in which the UWP app renders its content, is not owned by the Apps\nexecutable.\nInstead “<strong>ApplicationFrameHost</strong>” does,and so you should not target the Window but rather the process itself.<br/>\nNote: Because of this, you cannot create new windows, like message boxes for example, when injected in a UWP-App.</p>\n<p><strong>Second:</strong><br/>\nThe DLL you want to inject has to have “Read, Execute” as well as the “Read” permissions\nset for the “ALL APPLICATION PACKAGES”-Group.\nYou can set this via the properties tab of the DLL-file but the name may differ depending on\nyour system language.</p>\n<p>You could also just use the following little code snippet  from\n<a href=\"http://stackoverflow.com/questions/17761826/assigning-folder-permissions-to-all-application-packages-group\">StackOverflow</a> (so don’t mind the “goto”s) to set the permissions programmatically.</p>\n<p><strong>Code-Snippet</strong></p>\n<pre><code>DWORD SetPermissions(std::wstring wstrFilePath) {\n    PACL pOldDACL = NULL, pNewDACL = NULL;\n    PSECURITY_DESCRIPTOR pSD = NULL;\n    EXPLICIT_ACCESS eaAccess;\n    SECURITY_INFORMATION siInfo = DACL_SECURITY_INFORMATION;\n    DWORD dwResult = ERROR_SUCCESS;\n    PSID pSID;\n    // Get a pointer to the existing DACL\n    dwResult = GetNamedSecurityInfo(wstrFilePath.c_str(), SE_FILE_OBJECT, DACL_SECURITY_INFORMATION, NULL, NULL, &amp; pOldDACL, NULL, &amp; pSD);\n    if (dwResult != ERROR_SUCCESS)\n        goto Cleanup;\n    // Get the SID for ALL APPLICATION PACKAGES using its SID string\n    ConvertStringSidToSid(L\"S-1-15-2-1\", &amp; pSID);\n    if (pSID == NULL)\n        goto Cleanup;\n    ZeroMemory( &amp; eaAccess, sizeof(EXPLICIT_ACCESS));\n    eaAccess.grfAccessPermissions = GENERIC_READ | GENERIC_EXECUTE;\n    eaAccess.grfAccessMode = SET_ACCESS;\n    eaAccess.grfInheritance = SUB_CONTAINERS_AND_OBJECTS_INHERIT;\n    eaAccess.Trustee.TrusteeForm = TRUSTEE_IS_SID;\n    eaAccess.Trustee.TrusteeType = TRUSTEE_IS_WELL_KNOWN_GROUP;\n    eaAccess.Trustee.ptstrName = (LPWSTR) pSID;\n    // Create a new ACL that merges the new ACE into the existing DACL\n    dwResult = SetEntriesInAcl(1, &amp; eaAccess, pOldDACL, &amp; pNewDACL);\n    if (ERROR_SUCCESS != dwResult)\n        goto Cleanup;\n    // Attach the new ACL as the object's DACL\n    dwResult = SetNamedSecurityInfo((LPWSTR) wstrFilePath.c_str(), SE_FILE_OBJECT, siInfo, NULL, NULL, pNewDACL, NULL);\n    if (ERROR_SUCCESS != dwResult)\n        goto Cleanup;\nCleanup:\n    if (pSD != NULL)\n        LocalFree((HLOCAL) pSD);\n    if (pNewDACL != NULL)\n        LocalFree((HLOCAL) pNewDACL);\n    return dwResult;\n}\n</code></pre>\n<p>Afterward, inject your DLL with your preferred injector/method, and your DLLs code will\nmagically function.<br/>\nSince UWP-Apps use the Win32 API under the hood, you can expect KernelBase.dll,\nKernel32.dll, ntdll.dll, and user32.dll to be loaded in them. You will also find d2d1.dll and\neither d3d11.dll or d3d12.dll (used in a handful of apps) loaded in all UWP apps, including\nthe new UWP calculator app.</p>\n<p>For function hooking, as you might now expect, it works the same way it does for Win32 Programs.</p>\n<p><strong>Taking control over the (hidden) “C:\\Program Files\\WindowsApps\\” directory :</strong><br/>\nWithout taking control over the (hidden) “C:\\Program Files\\WindowsApps\\” directory, or\nwherever you might have it, you cannot access the files of UWP-Apps.<br/>\nBut you can just take\ncontrol of this, and any subdirectories and its files without any problems.  </p>\n<p>You could also always just <a href=\"https://mikehowells.wordpress.com/2011/02/12/running-a-command-prompt-as-nt-authoritysystem/\" rel=\"noreferrer\">open up a shell as NT-Authority</a> and access them that way.<br/>\nIf you just wanted to mod a simple config file or something you should be fine.\nHowever, some Apps, not all of them, check if their files were tampered with. But that’s\neasily circumvented.  </p>\n<p>All you have to do is Hook the “CreateFileW“-Method in “KernelBase.dll“, monitor the file\naccess and then reroute those access requests to load your modified version from some\ndirectory you can access just fine.</p>\n<p>Here’s an example that does exactly what just described, using the previously mentioned MinHook library.  </p>\n<p><strong>Code-Snippet :</strong></p>\n<pre><code>#include &lt;Windows.h&gt;\n#include &lt;atlbase.h&gt;\n#include &lt;Shlobj.h&gt;\n#include &lt;string&gt;\n#include \"MinHook.h\"\n// Path to modified game files store in AppData\nstd::wstring MOD_FILES_PATH;\n// Path to the apps protected resources in WindowsApps\n// Don't use the full path name, just keep the Publisher.AppName part\nstd::wstring APP_LOCATION(L\"C:\\\\ProgramFiles\\\\WindowsApps\\\\Publisher.AppName\");\n// Sets a hook on the function at origAddress function and provides a trampoline to the original function\nBOOL setHook(LPVOID * origAddress, LPVOID * hookFunction, LPVOID * trampFunction);\n// Attaches a hook on a function given the name of the owning module and the name of the function\nBOOL attach(LPWSTR wstrModule, LPCSTR strFunction, LPVOID * hook, LPVOID * original);\n// Basic hook setup for CreateFileW\ntypedef HANDLE(WINAPI * PfnCreateFileW)(LPCWSTR lpFilename, DWORD dwAccess,\n    DWORD dwSharing, LPSECURITY_ATTRIBUTES saAttributes, DWORD dwCreation,\n    DWORD dwAttributes, HANDLE hTemplate);\nPfnCreateFileW pfnCreateFileW = NULL; // Will hold the trampoline to the original CreateFileW function\n// CreateFileW hook function\nHANDLE WINAPI HfnCreateFileW(LPCWSTR lpFilename, DWORD dwAccess, DWORD dwSharing, LPSECURITY_ATTRIBUTES saAttributes, DWORD dwCreation, DWORD dwAttributes, HANDLE hTemplate) {\n    std::wstring filePath(lpFilename);\n    // Check if the app is accessing protected resources\n    if (filePath.find(APP_LOCATION) != filePath.npos) {\n        std::wstring newPath(MOD_FILES_PATH);\n        // Windows provides the app the location of the WindowsApps directory, so the first half the file path will use back slashes\n        // After that, some apps will use back slashes while others use forward slashes so be aware of what the app uses\n        newPath += filePath.substr(filePath.find(L\"\\\\\", APP_LOCATION.size()) + 1,\n            filePath.size());\n        // Check if the file being accessed exists at the new path and reroute access to that file\n        // Don't reroute directories as bad things can happen such as directories being ghost locked\n        if (PathFileExists(newPath.c_str()) &amp;&amp; !PathIsDirectory(newPath.c_str()))\n            return pfnCreateFileW(newPath.c_str(), dwAccess, dwSharing, saAttributes,\n                dwCreation, dwAttributes, hTemplate);\n    }\n    // Let the app load other files normally\n    return pfnCreateFileW(lpFilename, dwAccess, dwSharing, saAttributes,\n        dwCreation, dwAttributes, hTemplate);\n}\nBOOL Initialize() {\n    // Initialize MinHook\n    if (MH_Initialize() != MH_OK)\n        return FALSE;\n    // Get the path to the apps AppData folder\n    // When inside a UWP app, CSIDL_LOCAL_APPDATA returns the location of the apps AC folder in AppData\n    TCHAR szPath[MAX_PATH];\n    if (SUCCEEDED(SHGetFolderPath(NULL, CSIDL_LOCAL_APPDATA, NULL, 0, szPath))) {\n        // Get the path to the mod files folder\n        std::wstring appData(szPath);\n        appData = appData.substr(0, appData.rfind(L\"AC\")); // Get the base directory\n        appData += L\"LocalState\\\\ModFiles\\\\\"; // Get the location of any new files you want the app to use\n        MOD_FILES_PATH = appData;\n    } else\n        return FALSE;\n    // Attach a hook on CreateProcessW and return the status of the hook\n    BOOL hook = TRUE;\n    hook &amp;= attach(L\"KernelBase.dll\", \"CreateFileW\", (LPVOID * ) &amp; HfnCreateFileW,\n        (LPVOID * ) &amp; pfnCreateFileW);\n    return hook;\n}\nBOOL Uninitialize() {\n    // Uninitialize MinHook\n    if (MH_Uninitialize() != MH_OK)\n        return FALSE; // This status will end up being ignored\n    return TRUE;\n}\nBOOL APIENTRY DllMain(HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved) {\n    switch (ul_reason_for_call) {\n    case DLL_PROCESS_ATTACH:\n        return Initialize(); // If initialization failed, the DLL will detach\n        break;\n    case DLL_THREAD_ATTACH:\n        break;\n    case DLL_THREAD_DETACH:\n        break;\n    case DLL_PROCESS_DETACH:\n        Uninitialize(); // Return value doesn't matter when detaching\n        break;\n    }\n    return TRUE;\n}\nBOOL setHook(LPVOID * origAddress, LPVOID * hookFunction, LPVOID * trampFunction) {\n    if (MH_CreateHook(origAddress, hookFunction,\n            reinterpret_cast &lt; LPVOID * &gt; (trampFunction)) != MH_OK)\n        return FALSE;\n    if (MH_EnableHook(origAddress) != MH_OK)\n        return FALSE;\n    return TRUE;\n}\nBOOL attach(LPWSTR wstrModule, LPCSTR strFunction, LPVOID * hook, LPVOID * original) {\n    HMODULE hModule = GetModuleHandle(wstrModule);\n    if (hModule == NULL)\n        return FALSE;\n    FARPROC hFunction = GetProcAddress(hModule, strFunction);\n    if (hFunction == NULL)\n        return FALSE;\n    return setHook((LPVOID * ) hFunction, hook, original);\n}\n</code></pre>\n<p><strong>A few more things:</strong><br/>\nYou can’t just launch a UWP-App like a regular Win32 Program using CreateProcess.\nLuckily for us, M$ has provided us with the <a href=\"https://msdn.microsoft.com/en-us/library/windows/desktop/hh706902(v=vs.85).aspx\" rel=\"noreferrer\">IApplicationActivationManager</a> interface which\nlets developers launch UWP apps from regular Win32 programs.</p>\n<p>If we want to do something to an App before it is launched, we can suspend it before that using the code below.</p>\n<p><strong>Code Snippet :</strong></p>\n<pre><code>// Gets the current application's UserModelId and PackageId from the registry\n// Substitute your own methods in place of these\nstd::wstring appName = GetApplicationUserModelId();\nstd::wstring appFullName = GetApplicationPackageId();\n\nHRESULT hResult = S_OK;\n\n// Create a new instance of IPackageDebugSettings\nATL::CComQIPtr debugSettings;\nhResult = debugSettings.CoCreateInstance(CLSID_PackageDebugSettings, NULL, CLSCTX_ALL);\nif(hResult != S_OK) return hResult;\n\n// Enable debugging\nhResult = debugSettings-&gt;EnableDebugging(appFullName.c_str(), NULL, NULL);\nif(hResult != S_OK) return hResult;\n\n// Launch the application using the function discussed above\nDWORD dwProcessId = 0;\nhResult = LaunchApplication(appName, &amp;dwProcessId);\nif(hResult != S_OK) return hResult;\n\n/* Do more stuff after the app has been resumed */\n\n// Stop debugging the application so it can run as normal\nhResult = debugSettings-&gt;DisableDebugging(appFullName.c_str());\nif(hResult != S_OK) return hResult;\n</code></pre>\n<p>Using the code above, your program will hang until the app is resumed as it is waiting on the app to reply back to the IApplicationActivationManager on its launch status. To resume the app, you can simply specify the path to your executable file when enabling debugging:</p>\n<p><strong>Code Snippet:</strong></p>\n<pre><code>// Enable Debugging with a custom debugger executable\nhResult = debugSettings-&gt;EnableDebugging(appFullName.c_str(), pathToExecutable.c_str(), NULL);\nif(hResult != S_OK) return hResult;\n</code></pre>\n<p>Windows will pass the process ID for the app process to the executable acting as the debugger using the command line argument -p followed by the process ID. From the debugger executable, you can do whatever you want to while the app is suspended such as injecting mods, and finally resume the app using NtResumeProcess.</p>\n<pre><code>#define IMPORT extern __declspec(dllimport)\n\nIMPORT int __argc;\nIMPORT char** __argv;\n//IMPORT wchar_t** __wargv;\n\n// Turning this into a normal Windows program so it's invisible when run\nint CALLBACK WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nShowCmd)\n{\n    DWORD dwProcessId = 0;\n\n    // Process the arguments passed to the debugger\n    for (int i = 1; i &lt; __argc; i += 2)\n    {\n        std::string arg(__argv[i]);\n        if (arg == \"-p\")\n            dwProcessId = atoi(__argv[i + 1]);\n    }\n\n    if(dwProcessId == 0)\n        return E_FAIL;\n\n    // Can do additional error checking to make sure the app is active and not tombstoned\n\n    ModLoader::InjectMods(dwProcessId);\n    ProcessUtils::ResumeProcess(dwProcessId); // Uses NtResumeProcess\n\n    return S_OK;\n}\n</code></pre>\n<p><strong>Important note:</strong> Call</p>\n<pre><code>// Initialize COM objects, only need to do this once per thread\nDWORD hresult = CoInitializeEx(NULL, COINIT_APARTMENTTHREADED);\nif (!SUCCEEDED(hresult)) return hresult;\n</code></pre>\n<p>Before you launch an App or do anything call this afterward:</p>\n<pre><code>CoUninitialize();\n</code></pre>\n<p><strong>References:</strong><br/>\n(1) <a href=\"https://www.unknowncheats.me/forum/general-programming-and-reversing/177183-basic-intermediate-techniques-uwp-app-modding.html\" rel=\"noreferrer\">Basic and Intermediate Techniques of UWP App Modding</a><br/>\n(2) <a href=\"https://behind.flatspot.pictures/hacking-windows-universal-apps-uwp/\" rel=\"noreferrer\">Hacking and Modding Windows Universal Apps</a></p>\n<p>I sincerely hope that these two answers of mine would be helpful to anyone searching SE in future on the topics of UWP App hooking/modification.</p>\n</div>",
            "votes": "32",
            "user": "Paul",
            "time": "May 9, 2020 at 0:09",
            "is_accepted": true,
            "comments": [
                {
                    "user": "barnaby-b",
                    "text": "<span class=\"comment-copy\">Great answer! I'll make sure to review the code examples and references - kudos.</span>",
                    "time": null
                },
                {
                    "user": "c00000fd",
                    "text": "<span class=\"comment-copy\">Yes, thank you. This answer is closer to answering my original question. (Your other answer is about global hooks. Unfortunately in this case you won't be able to do much with them. I can as well find a click on the UWP app's window, i.e <code>Windows.UI.Core.CoreWindow</code> by trapping a mouse click event in its WndProc with IDA. Unfortunately, it's not easy to proceed further on from that point. Or how to get to <a href=\"https://docs.microsoft.com/en-us/uwp/api/windows.ui.core.corewindow\" rel=\"nofollow noreferrer\">this class</a> that can help route the call further from a button click.)</span>",
                    "time": null
                },
                {
                    "user": "c00000fd",
                    "text": "<span class=\"comment-copy\">I'll mark it as the answer so that you can receive the bounty for your work. I just want to point out that there's more to it left to be done. Can you contact me <a href=\"https://reverseengineering.stackexchange.com/users/14864/c00000fd?tab=profile\">via email</a>? I'll post an update here when I get it resolved.</span>",
                    "time": null
                },
                {
                    "user": "TechLord",
                    "text": "<span class=\"comment-copy\">Thank you <b>c00000fd</b> ! Had been working overtime a lot these few days (working even this weekend) and hence did not have time to work on the actual \"Restart\" button in the Windows Update that you were mentioning. Hopefully in the next few days I will be able to create a solution for that exact \"Restart\" button issue and update it here. Will also email you as requested.  @barnaby-b - Thank you for the compliment!</span>",
                    "time": null
                },
                {
                    "user": "dsasmblr",
                    "text": "<span class=\"comment-copy\">Awesome job, TechLord, and great feedback and attitude towards this whole thing, c00000fd! I hope to see you follow through with that Restart button solution, TechLord. Also, would quite enjoy an update from you as well once you get things pinned down, c00000fd. Thanks, both of you!</span>",
                    "time": null
                }
            ]
        },
        {
            "content": "<div class=\"s-prose js-post-body\" itemprop=\"text\">\n<p>As promised, I am back to post a <strong>more specific answer</strong> to the question that was asked by the OP.  </p>\n<p>Decided to write this as a separate answer as I believe that this content stands out on its own and would not properly fit in with either of the two answers that I posted above.</p>\n<p><strong>Addressing his first issue :</strong></p>\n<blockquote>\n<p>In this case though, the whole settings is a window of its own. The\n  button does not appear in Spy++</p>\n</blockquote>\n<p>Well, the button <em>does</em> appear when using tools other than Spy++.<br/>\nI am pasting  screenshots of 2 tools with the help of which the properties of the RESTART button can be discovered.</p>\n<p><strong>Using the <a href=\"https://msdn.microsoft.com/en-us/library/dd318521(v=vs.85).aspx\" rel=\"noreferrer\">INSPECT TOOL</a> that is a part of the Microsoft SDK :</strong></p>\n<p><a href=\"https://i.sstatic.net/Vp51s.png\" rel=\"noreferrer\"><img alt=\"INSPECT Tool showing Properties of the Button\" src=\"https://i.sstatic.net/Vp51s.png\"/></a> </p>\n<p>and also using the <a href=\"https://msdn.microsoft.com/en-us/library/ms727247(v=vs.100).aspx\" rel=\"noreferrer\">UI Spy Tool</a> (Please note that <a href=\"https://msdn.microsoft.com/en-us/library/dd373661(v=vs.110).aspx\" rel=\"noreferrer\">many other tools</a> can also be used) for this purpose ...</p>\n<p><a href=\"https://i.sstatic.net/3aUwY.png\" rel=\"noreferrer\"><img alt=\"Properties of the RESTART Button using the UI Spy Tool\" src=\"https://i.sstatic.net/3aUwY.png\"/></a></p>\n<p>Now we will see what code we BREAK ON when we click the RESTART button :</p>\n<p>Firstly, Run the <strong>System Settings Manager</strong> (<strong>SystemSettings.exe</strong> would be seen in the Task Manager).<br/>\n\"<strong>Attach</strong>\" to the <em>SystemSettings.exe</em> process with a debugger (I used the [excellent] x64dbg Debugger for this purpose).<br/>\nMake sure that you tick the <em>Break on DLL Load</em> in the Debugger Settings as shown below :</p>\n<p><a href=\"https://i.sstatic.net/zPUtC.png\" rel=\"noreferrer\"><img alt=\"DLL Load\" src=\"https://i.sstatic.net/zPUtC.png\"/></a> </p>\n<p>Now we *click on the <em>RESTART NOW</em> button* (of the <em>Windows Settings</em> Window). We will break in the debugger as the \"<strong>SettingsHandlers_nt.dll</strong>\" gets loaded into the process.    </p>\n<p><strong>This is the main dll that handles the events (clicks etc) of the Settings Window.</strong> </p>\n<p><a href=\"https://i.sstatic.net/yVLFg.png\" rel=\"noreferrer\"><img alt=\"SettingsHandlers_nt.dll Loaded\" src=\"https://i.sstatic.net/yVLFg.png\"/></a> </p>\n<p><a href=\"https://i.sstatic.net/WNZmn.png\" rel=\"noreferrer\"><img alt=\"We land here in the SettingsHandlers_nt.dll module\" src=\"https://i.sstatic.net/WNZmn.png\"/></a> </p>\n<p>This is a part of the Control Flow Graph that actually takes the  decision to \ngo for a restart :</p>\n<p><a href=\"https://i.sstatic.net/5fiwQ.png\" rel=\"noreferrer\"><img alt=\"Restarts as Single User Mode\" src=\"https://i.sstatic.net/5fiwQ.png\"/></a> </p>\n<blockquote>\n<p>Somehow the results are not the same what is available via\n  InitiateSystemShutdownEx or InitiateShutdown WinAPIs, especially\n  concerning installation of updates.</p>\n</blockquote>\n<p>The OP is right .<br/>\nThe <strong><em>actual Decision-Making Part for the  [Automatic] Restarts after Microsoft Updates</em></strong> is  handled by the <strong>MusUpdateHandlers.dll</strong> as can be seen below: </p>\n<p><a href=\"https://i.sstatic.net/74pQF.png\" rel=\"noreferrer\"><img alt=\"CFG of Forced Reboots after Updates\" src=\"https://i.sstatic.net/74pQF.png\"/></a></p>\n<p>and also here :</p>\n<p><a href=\"https://i.sstatic.net/T9gad.png\" rel=\"noreferrer\"><img alt=\"Code View for Reboots after UPDATES\" src=\"https://i.sstatic.net/T9gad.png\"/></a></p>\n<p>I have added the last 2 screenshots as the OP had wanted to know what API are invoked when the system restarts after an UPDATE...</p>\n<p>I hope that this now concludes the answer to what @c00000fd wanted to know...</p>\n</div>",
            "votes": "22",
            "user": "TechLord",
            "time": "Feb 6, 2018 at 14:34",
            "is_accepted": false,
            "comments": [
                {
                    "user": "Shayan",
                    "text": "<span class=\"comment-copy\">Hello TechLord, can you help with my question: <a href=\"https://reverseengineering.stackexchange.com/questions/23454/reverse-engineer-listen-to-this-device-on-windows-reverse-engineer-windows-whe\" title=\"reverse engineer listen to this device on windows reverse engineer windows whe\">reverseengineering.stackexchange.com/questions/23454/…</a> Thanks very much :)</span>",
                    "time": null
                }
            ]
        },
        {
            "content": "<div class=\"s-prose js-post-body\" itemprop=\"text\">\n<blockquote>\n<p>\"I'd like to see details on how to hook and step into the function\n  that processes a button click event in a UWP app.\"</p>\n</blockquote>\n<p>I would suggest using the <strong>EventHook Library</strong> which is intended to hook global windows user events.This is available as a <a href=\"https://www.nuget.org/packages/EventHook\" rel=\"noreferrer\">Nuget Package</a>.</p>\n<p>The Project Repo (named as <strong>Windows User Action Hook</strong>)  is available on Github and my fork can be accessed <a href=\"https://github.com/TechLord-Forever/Windows-User-Action-Hook\" rel=\"noreferrer\">here</a>. This is for the same Library (EventHook Library) that I mentioned above. You can visit the Github repo  if you want to get hold of the source code.</p>\n<p>From the <a href=\"https://github.com/TechLord-Forever/Windows-User-Action-Hook/blob/develop/README.md\" rel=\"noreferrer\">Github Project's README page</a>, just let me excerpt a few details :</p>\n<p><strong>Supported Events :</strong> (These are the events that you can hook <em>globally</em>)</p>\n<blockquote>\n<ul>\n<li>Keyboard Events    </li>\n<li>Mouse Events       </li>\n<li>Clipboard Events      </li>\n<li>Application events    </li>\n<li>Print events</li>\n</ul>\n</blockquote>\n<p><strong>Usage - Install by nuget</strong> </p>\n<blockquote>\n<p>Install-Package EventHook</p>\n</blockquote>\n<p><strong>SAMPLE CODE:</strong> </p>\n<pre><code>KeyboardWatcher.Start();  \nKeyboardWatcher.OnKeyInput += (s, e) =&gt;  \n{  \n    Console.WriteLine(string.Format(\"Key {0} event of key {1}\", e.KeyData.EventType, e.KeyData.Keyname));  \n};  \n\nMouseWatcher.Start();  \nMouseWatcher.OnMouseInput += (s, e) =&gt;  \n{  \n    Console.WriteLine(string.Format(\"Mouse event {0} at point {1},{2}\", e.Message.ToString(), e.Point.x, e.Point.y));    \n};  \n\nClipboardWatcher.Start();  \nClipboardWatcher.OnClipboardModified += (s, e) =&gt;  \n{  \n    Console.WriteLine(string.Format(\"Clipboard updated with data '{0}' of format {1}\", e.Data, e.DataFormat.ToString()));  \n};  \n\nApplicationWatcher.Start();  \nApplicationWatcher.OnApplicationWindowChange += (s, e) =&gt;  \n{  \n    Console.WriteLine(string.Format(\"Application window of '{0}' with the title '{1}' was {2}\", e.ApplicationData.AppName, e.ApplicationData.AppTitle, e.Event));    \n};  \n\nPrintWatcher.Start();  \nPrintWatcher.OnPrintEvent += (s, e) =&gt;  \n{  \n    Console.WriteLine(string.Format(\"Printer '{0}' currently printing {1} pages.\", e.EventData.PrinterName, e.EventData.Pages));    \n};  \n\nConsole.Read();  \nKeyboardWatcher.Stop();  \nMouseWatcher.Stop();  \nClipboardWatcher.Stop();  \n\nApplicationWatcher.Stop();  \nPrintWatcher.Stop();  \n</code></pre>\n<p>Sample Output (Screenshot) :</p>\n<p><a href=\"https://i.sstatic.net/044uM.png\" rel=\"noreferrer\"><img alt=\"https://raw.githubusercontent.com/justcoding121/Windows-User-Action-Hook/stable/EventHook.Examples/EventHook.ConsoleApp.Example/Capture.PNG\" src=\"https://i.sstatic.net/044uM.png\"/></a></p>\n<p>I am sure that once you can see how we are able to <em>globally</em> hook various Windows User Events.\nIn your case, using this library, we'd be able to code a tiny C# program for example, which would hook the mouse-press event for the \"<strong>Restart Now</strong>\" button and thus allow us to take control of the subsequent events. </p>\n<p>Since this question was about hooking <strong>UWP Apps</strong>, I would like to give an example where this library was used to <em>specifically</em> hook UWP apps so that the code from that repo can be used as an example if required. \nPlease note that I am not excerpting anything directly from that repo as I only wanted to show that this library works very well with UWP Apps as well.  You can visit my fork of the <a href=\"https://github.com/TechLord-Forever/UWPHook\" rel=\"noreferrer\">Github Repo UWPHook here</a>.</p>\n</div>",
            "votes": "9",
            "user": "TechLord",
            "time": "Jan 14, 2018 at 19:38",
            "is_accepted": false,
            "comments": []
        },
        {
            "content": "<div class=\"s-prose js-post-body\" itemprop=\"text\">\n<p>I searched in the System32 folder inside every file named SystemSettting*.* for the word Shutdown. I used Total Commander as it can search with multiple encodings such as ASCII and Unicode:\n<a href=\"https://i.sstatic.net/RHXfr.png\" rel=\"noreferrer\"><img alt=\"Total Commander | Find Files\" src=\"https://i.sstatic.net/RHXfr.png\"/></a></p>\n<p>Then builtin viewer showed a reference to <code>InitiateSystemShutdownExW</code>:\n<a href=\"https://i.sstatic.net/eXwnZ.png\" rel=\"noreferrer\"><img alt=\"Total Commander Lister\" src=\"https://i.sstatic.net/eXwnZ.png\"/></a>.</p>\n<p>From MSDN:</p>\n<blockquote>\n<p><strong>InitiateSystemShutdownEx function</strong> Initiates a shutdown and optional restart of the specified computer, and optionally records the\n  reason for the shutdown.</p>\n</blockquote>\n<pre><code>BOOL WINAPI InitiateSystemShutdownEx(\n  _In_opt_ LPTSTR lpMachineName,\n  _In_opt_ LPTSTR lpMessage,\n  _In_     DWORD  dwTimeout,\n  _In_     BOOL   bForceAppsClosed,\n  _In_     BOOL   bRebootAfterShutdown,\n  _In_     DWORD  dwReason\n);\n</code></pre>\n<p>To verify, a next step would be to set a breakpoint on this API using a tool like Ida Pro or API Monitor. </p>\n</div>",
            "votes": "5",
            "user": "Remko",
            "time": "Jan 9, 2018 at 18:50",
            "is_accepted": false,
            "comments": [
                {
                    "user": "c00000fd",
                    "text": "<span class=\"comment-copy\">I'm not sure if <code>SystemSettingsThresholdAdminFlowUI.dll</code> is even mapped into <code>C:\\Windows\\ImmersiveControlPanel\\SystemSettings.exe</code> process at the time.</span>",
                    "time": null
                },
                {
                    "user": "Remko",
                    "text": "<span class=\"comment-copy\">You can check that with e.g. Process Explorer but you could be right that it's calling this api in another way.</span>",
                    "time": null
                },
                {
                    "user": "mrexodia",
                    "text": "<span class=\"comment-copy\">Do debug a UWP app you will have to use PLMDebug, you can use windbg or x64dbg for that.</span>",
                    "time": null
                },
                {
                    "user": "c00000fd",
                    "text": "<span class=\"comment-copy\">@mrexodia: Well, yeah, obviously you need to use PLMDebug to turn off <code>Process Lifetime Management</code> on UWP app. In other words, so that it doesn't get suspended by the broker when it's in the background. But you don't debug with it, per se. It's not a debugger.</span>",
                    "time": null
                }
            ]
        }
    ]
}