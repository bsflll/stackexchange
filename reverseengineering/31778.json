{
    "title": "How to extract the firmware from the flash chip of the router?",
    "link": "https://reverseengineering.stackexchange.com/questions/31778/how-to-extract-the-firmware-from-the-flash-chip-of-the-router",
    "content": "<div class=\"s-prose js-post-body\" itemprop=\"text\">\n<p><strong>Hi, I've been struggling with a subject since 2 weeks.<br/><br/>\nI have MSS5004W model router from RicherLink. The board is RL-S4005ef. This device has OpenWrt installed but it's not normally supported by that OS. So I think they ported OpenWrt for this device so there are no known firmware on the internet for this device.<br/><br/>\nI extracted the content of the flash chip into firmware.bin, flash is gd25q127c nor flash.<br/><br/>\nAccording to U-Boot output of the router, I have this memory mapping:</strong></p>\n<p>Creating 11 MTD partitions on \"spi0.0\":<br/>\n0x000000000000-0x000000030000 : \"u-boot\"<br/>\n0x000000030000-0x000000040000 : \"u-boot-env\"<br/>\n0x000000040000-0x000000050000 : \"Factory\"<br/>\n0x000000050000-0x000000150000 : \"kernel\"<br/>\n0x000000150000-0x000000720000 : \"rootfs\"<br/>\nmtd: root_zone=0<br/>\nmtd: partition \"rootfs\" set to be root filesystem<br/>\n0x000000720000-0x000000820000 : \"kernel2\"<br/>\n0x000000820000-0x000000df0000 : \"rootfs2\"<br/>\n0x000000df0000-0x000000ff0000 : \"rootfs_data\"<br/>\n0x000000ff0000-0x000001000000 : \"vendor\"<br/>\n0x000000050000-0x000000720000 : \"firmware\"<br/>\n0x000000720000-0x000000df0000 : \"firmware2\"<br/></p>\n<p><strong>When I binwalk the .bin file, I get this output:</strong></p>\n<p>DECIMAL       HEXADECIMAL     DESCRIPTION<br/>\n----------------------------------------------------------------------------------------------------------------------------------<br/>\n73680         0x11FD0         U-Boot version string, \"U-Boot 1.1.3 (Sep 18 2018 - 16:47:56)\"<br/>\n327696        0x50010         uImage header, header size: 64 bytes, header CRC: 0x41E8CEF2, created: 2018-10-30 04:57:02, image\nsize: 965681 bytes, Data Address: 0x88000000, Entry Point: 0x88000000, data CRC: 0x94204675, OS:\nLinux, CPU: MIPS, image type: OS Kernel Image, compression type: lzma, image name: \"MIPS OpenWrt\nLinux-2.6.32.27\"\n<br/>\n327760        0x50050         LZMA compressed data, properties: 0x6D, dictionary size: 8388608 bytes, uncompressed size: 2837756\nbytes\n<br/>\n1376256       0x150000        Squashfs filesystem, little endian, version 4.0, compression:lzma, size: 3359661 bytes, 1572\ninodes, blocksize: 131072 bytes, created: 2018-10-30 04:56:57\n<br/>\n7471120       0x720010        uImage header, header size: 64 bytes, header CRC: 0x41E8CEF2, created: 2018-10-30 04:57:02, image\nsize: 965681 bytes, Data Address: 0x88000000, Entry Point: 0x88000000, data CRC: 0x94204675, OS:\nLinux, CPU: MIPS, image type: OS Kernel Image, compression type: lzma, image name: \"MIPS OpenWrt\nLinux-2.6.32.27\"\n<br/>\n7471184       0x720050        LZMA compressed data, properties: 0x6D, dictionary size: 8388608 bytes, uncompressed size: 2837756\nbytes\n<br/>\n8519680       0x820000        Squashfs filesystem, little endian, version 4.0, compression:lzma, size: 3359661 bytes, 1572\ninodes, blocksize: 131072 bytes, created: 2018-10-30 04:56:57\n<br/>\n14614528      0xDF0000        JFFS2 filesystem, little endian\n<br/>\n16711680      0xFF0000        Squashfs filesystem, little endian, version 4.0, compression:lzma, size: 17055 bytes, 33 inodes,\nblocksize: 131072 bytes, created: 2017-04-25 08:44:25</p>\n<p><strong>It seems like there are 2 firmwares installed, I can confirm this by checking the U-boot output:</strong></p>\n<p>U-Boot 1.1.3 (Sep 18 2018 - 16:47:56)<br/>\nBoard: Ralink APSoC DRAM:  64 MB<br/>\nrelocate_code Pointer at: 83fb8000<br/>\nenable ephy clock...done. rf reg 29 = 5<br/>\nSSC disabled.<br/>\nspi_wait_nsec: 29 <br/>\nspi device id: c8 40 18 c8 40 (4018c840)<br/>\nfind flash: GD25Q127C<br/>\nraspi_read: from:30000 len:1000 <br/>\nraspi_read: from:30000 len:1000 <br/>\n============================================ <br/>\nRalink UBoot Version: 4.2.1.0 r18163<br/>\n-------------------------------------------- <br/>\nASIC 7620_MP (Port5&lt;-&gt;None)<br/>\nDRAM component: 512 Mbits DDR, width 16<br/>\nDRAM bus: 16 bit<br/>\nTotal memory: 64 MBytes<br/>\nFlash component: 16 MBytes NOR Flash<br/>\nDate:Sep 18 2018  Time:16:47:56<br/>\n============================================ <br/>\nicache: sets:512, ways:4, linesz:32 ,total:65536<br/>\ndcache: sets:256, ways:4, linesz:32 ,total:32768 <br/>\nThe CPU freq = 580 MHZ <br/>\nestimate memory size =64 Mbytes<br/>\nraspi_read: from:50010 len:40 <br/>\nraspi_read: from:720010 len:40 <br/>\n=================================================<br/>\nCheck image validation:<br/>\nImage1 Header Magic Number --&gt; OK<br/>\nImage2 Header Magic Number --&gt; OK<br/>\nImage1 Header Checksum --&gt; OK<br/>\nImage2 Header Checksum --&gt; OK<br/>\nImage1 Data Checksum --&gt; raspi_read: from:50050 len:ebc31 <br/>\nOK<br/>\nImage2 Data Checksum --&gt; raspi_read: from:720050 len:ebc31 <br/>\nOK<br/>\nImage1 Stable Flag --&gt; Stable<br/>\nImage1 Try Counter --&gt; 0<br/>\nImage2 Stable Flag --&gt; Not stable<br/>\nImage2 Try Counter --&gt; 0<br/>\nImage1: OK Image2: OK root_zone: 0<br/></p>\n<p><strong>I tried to extract each firmware with dd by taking uImage, LZMA compressed data and Squashfs folder and created .bin files out of them. But to no avail I get \"invalid model\" error by doing tftp boot, openwrt sysupgrade from root file system or using the web interface to flash the firmware.</strong></p>\n<p><strong>Does anybody know how can I extract the firmware out of this flash file system? I need urgent help.</strong></p>\n</div>",
    "votes": "2",
    "answers": 0,
    "views": "695",
    "tags": [
        "embedded",
        "firmware-analysis",
        "router"
    ],
    "user": "SwordLion",
    "time": "Apr 14, 2023 at 11:32",
    "comments": [
        {
            "user": "secfren",
            "text": "<span class=\"comment-copy\">How did you dump the firmware? \"I tried to extract each firmware ...\" Was that successful?  What do you want to do? Modify firmware? Why/which parts? How does the new bin file look compared to the old one? If you have serial access and can flash via hardware you could maybe see where and why it fails. Or look for \"invalid model\" in the firmware and see what is checked.</span>",
            "time": null
        },
        {
            "user": "SwordLion",
            "text": "<span class=\"comment-copy\">Thanks for the answer.  I dumped the firmware using a CH341a spi flash programmer by connecting to the flash rom. Extracting firmwares were successful but I get a lzma compressed file that when I used binwalk it says 'data' and unlzma decompression results in errors.   That's correct, I want to modify the firmware, pack it back and push into the router again. I have serial access though UART and with usb to uart converter I have, that's how I got the bootloader printout. \"invalid model\" error doesn't show me the reason. It tries to boot the image and throws \"invalid model\".</span>",
            "time": null
        },
        {
            "user": "secfren",
            "text": "<span class=\"comment-copy\">\" Extracting firmwares were successful\" contradicts \"unlzma decompression results in errors\". Or is dumping=extraction in your case? What part do you wan't to modify and why? There might be easier ways when you have serial access.</span>",
            "time": null
        },
        {
            "user": "SwordLion",
            "text": "<span class=\"comment-copy\">Well, to be more clear; I dumped the flash rom to a .bin file. And from this .bin file, I extracted parts that I thought were firmwares, first was image header + lzma compressed data + squashfs file system. I used the dd command to carve the data in the specific address range that the binwalk command shows. I tried extracting into .bin, bin.lzma, lzma, .img. But all of them fails when I try to decompress with \"unlzma\" or \"lzma -d\" commands. I also tried flashing them with the tftp flash commands of the U-boot, from the Openwrt sysupgrade or from the interface of the router. None worked so far.</span>",
            "time": null
        }
    ],
    "answers_data": []
}