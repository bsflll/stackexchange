{
    "title": "strange arm construct in objective-c application",
    "link": "https://reverseengineering.stackexchange.com/questions/30620/strange-arm-construct-in-objective-c-application",
    "content": "<div class=\"s-prose js-post-body\" itemprop=\"text\">\n<p>I was reversing the objective-c application and stumbled upon an assembler construction that I don't understand:</p>\n<p>This is call of some function with SP register (+ 0x18 offset) as parameter. (Picture1).</p>\n<p><a href=\"https://i.sstatic.net/b6lOP.png\" rel=\"nofollow noreferrer\"><img alt=\"Picture1\" src=\"https://i.sstatic.net/b6lOP.png\"/></a></p>\n<p>This is part of that(sub_10015B4C8) function. X0 register is using for some calculations(which using for next jump) (Picture2).\n<a href=\"https://i.sstatic.net/tcsbR.png\" rel=\"nofollow noreferrer\"><img alt=\"Picture2\" src=\"https://i.sstatic.net/tcsbR.png\"/></a></p>\n<p>Picture3 shows the pseudo code generated by ida. As I said above there is jumpout that is calculated dinamycally. v0 shown by ida as x22 which as you can see in the last picture gets the value from the x0 register.</p>\n<p><a href=\"https://i.sstatic.net/aAkeI.png\" rel=\"nofollow noreferrer\"><img alt=\"Picture3\" src=\"https://i.sstatic.net/aAkeI.png\"/></a></p>\n<p>The question is the following:</p>\n<p>There are two options either x0 register is equal to SP + 0x18 or __chkstk_darwin changed the x0 register value (But I did not find any documentation for this function). With the first option it's hard for me to understand how the jump is calculated if x0 depends by the SP register?</p>\n<p>Picture4 is end of function(with jump).\n<a href=\"https://i.sstatic.net/M6x3h.png\" rel=\"nofollow noreferrer\"><img alt=\"Picture4\" src=\"https://i.sstatic.net/M6x3h.png\"/></a></p>\n</div>",
    "votes": "2",
    "answers": 1,
    "views": "152",
    "tags": [
        "ios",
        "arm64"
    ],
    "user": "CABAL",
    "time": "Jul 12, 2022 at 15:08",
    "comments": [],
    "answers_data": [
        {
            "content": "<div class=\"s-prose js-post-body\" itemprop=\"text\">\n<p>The problem is the call to <code>_chkstk_darwin</code>. It is an internal compiler helper which probes the stack to make sure there’s enough space for local variables and does not modify <code>X0</code>, however IDA currently does not know that and assumes that <code>X0</code> is the return value as for any normal function.</p>\n<p>If you modify the prototype of <code>_chkstk_darwin</code> to specify <code>void</code> return type and an empty spoiled registers list (<code>__spoiled&lt;&gt;</code>), then X0 should be properly preserved across the call.</p>\n</div>",
            "votes": "1",
            "user": "Igor Skochinsky",
            "time": "Jul 15, 2022 at 9:45",
            "is_accepted": false,
            "comments": [
                {
                    "user": "CABAL",
                    "text": "<span class=\"comment-copy\">Then the X0 register depends by the SP register which is even weirder</span>",
                    "time": null
                },
                {
                    "user": "Igor Skochinsky",
                    "text": "<span class=\"comment-copy\">That’s not weird. Looks like it’s used to take an address of a local variable.</span>",
                    "time": null
                },
                {
                    "user": "CABAL",
                    "text": "<span class=\"comment-copy\">Yes, but v2 using v1 which using v0(X0) by value so is jump dependent by localvar address?</span>",
                    "time": null
                }
            ]
        }
    ]
}