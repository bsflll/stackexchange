{
    "title": "Compression format used for various data (images, text, etc.) in a 1997 video game",
    "link": "https://reverseengineering.stackexchange.com/questions/31185/compression-format-used-for-various-data-images-text-etc-in-a-1997-video-ga",
    "content": "<div class=\"s-prose js-post-body\" itemprop=\"text\">\n<p>I've been trying to reverse engineer the format of data files from the 1997 video game <a href=\"https://en.wikipedia.org/wiki/Helicops_(video_game)\" rel=\"nofollow noreferrer\">Helicops</a>. I have experience reverse engineering binary files from games of this period but limited exposure to compression schemes.</p>\n<p>I've been able to figure out the header format (which I've documented <a href=\"https://github.com/CahootsMalone/helicops-stuff/blob/main/file-format-dat.md#header\" rel=\"nofollow noreferrer\">here</a>; it uses an <a href=\"https://en.wikipedia.org/wiki/XOR_cipher\" rel=\"nofollow noreferrer\">XOR \"cipher\"</a> with the key <code>0xAA</code>), but the individual data blocks within each file use a form of compression I haven't been able to figure out.</p>\n<p>I'm certain the data are compressed: the header in each DAT file contains a table listing each data block's name, starting offset, and two values: one is the length of the data block in the DAT file and the other appears to be the data block's uncompressed length (notably, it's 768 for multiple data blocks that appear to be colour tables; 768 = 256 colours * 3 bytes/colour and these data blocks have names that end with \"ACT\", i.e., Adobe Color Table, and some include obvious grayscale ramps).</p>\n<p>My full notes on the compression scheme are <a href=\"https://github.com/CahootsMalone/helicops-stuff/blob/main/file-format-dat.md#compression\" rel=\"nofollow noreferrer\">here</a>, but I haven't been able to figure out much. Here's a summary:</p>\n<ul>\n<li>In multiple data files, <code>0xFF</code> is followed by 8 uncompressed bytes. This is consistent across multiple files containing different types of recognizable data (ASCII text and colour palettes), so it seems likely that all the game's data files use the same type of compression.</li>\n<li>Currently, I have no idea how <code>0xFF</code> translates to \"the next 8 bytes are uncompressed data\". Since the header uses an XOR cipher, I've tried XORing it with various values (<code>0xAA</code> since that's the key for the header data, <code>0xF7</code> since that gives <code>0x08</code>, etc.) but I haven't come up with any that make sense for <code>0xFF</code> and some of the other values that are clearly compression-related. My guess is that ranges of bits within each byte contain different compression-related info, but that the bytes need to be altered in some way first.</li>\n<li>Based on bytes that are evidently uncompressed data, it's clear that there are many sequences of bytes related to data compression (see examples in the sample data below), but I haven't been able to figure out how to decode them.</li>\n<li>I suspect the compression scheme uses some form of <a href=\"https://en.wikipedia.org/wiki/Run-length_encoding\" rel=\"nofollow noreferrer\">run-length encoding</a> and/or something along the lines of <a href=\"https://en.wikipedia.org/wiki/LZ77_and_LZ78\" rel=\"nofollow noreferrer\">LZ77</a> where references to sequences elsewhere in the data are used to reduce overall size.</li>\n</ul>\n<p>I've uploaded a sample DAT file, <code>PIC.DAT</code>, <a href=\"https://github.com/CahootsMalone/helicops-stuff/blob/main/PIC.DAT\" rel=\"nofollow noreferrer\">here</a>. It contains substantial quantities of ASCII text that make identifying compression-related bytes fairly easy. A list of its data blocks (parsed from its header) is <a href=\"https://github.com/CahootsMalone/helicops-stuff/blob/main/scripts/helicops-file-summary.md#picdat\" rel=\"nofollow noreferrer\">here</a>.</p>\n<p>Here are some sample data from the data block starting at offset 184456 in <code>PIC.DAT</code> (<code>PIC.DAT</code>'s header identifies this block as being associated with the third mission set, \"Data Space Demon\", and the first mission in that set, \"Tower Attack\"; note that these strings appear in the data below):</p>\n<div class=\"s-table-container\">\n<table class=\"s-table\">\n<thead>\n<tr>\n<th>Bytes</th>\n<th>Notes/ASCII</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>FF</td>\n<td></td>\n</tr>\n<tr>\n<td>52 45 4D 20 4D 69 73 73</td>\n<td>\"REM Miss\"</td>\n</tr>\n<tr>\n<td>FF</td>\n<td></td>\n</tr>\n<tr>\n<td>33 31 2E 50 49 43 20 2D</td>\n<td>\"31.PIC -\"</td>\n</tr>\n<tr>\n<td>FE FD F4</td>\n<td></td>\n</tr>\n<tr>\n<td>20 54 6F 77 65 72 20</td>\n<td>\" Tower \"</td>\n</tr>\n<tr>\n<td>BF 28</td>\n<td>BF = 191/-65, 28 = 40/40</td>\n</tr>\n<tr>\n<td>54 6F 6B 79 6F</td>\n<td>\"Tokyo\" (not part of level name)</td>\n</tr>\n<tr>\n<td>05 03 29 FB 0D 0A EE F1</td>\n<td></td>\n</tr>\n<tr>\n<td>44 61 74 61 20</td>\n<td>\"Data \"</td>\n</tr>\n<tr>\n<td>FF</td>\n<td></td>\n</tr>\n<tr>\n<td>53 70 61 63 65 20 44 65</td>\n<td>\"Space De\"</td>\n</tr>\n<tr>\n<td>EF</td>\n<td>239/-17</td>\n</tr>\n<tr>\n<td>6D 6F 6E</td>\n<td>\"mon\"</td>\n</tr>\n<tr>\n<td>2C 05 04</td>\n<td></td>\n</tr>\n<tr>\n<td>41 74 74</td>\n<td>\"Att\"</td>\n</tr>\n<tr>\n<td>F7</td>\n<td>247/-9</td>\n</tr>\n<tr>\n<td>61 63 6B</td>\n<td>\"ack\"</td>\n</tr>\n<tr>\n<td>19 03</td>\n<td></td>\n</tr>\n<tr>\n<td>43 6F 70 69</td>\n<td>\"Copi\"</td>\n</tr>\n<tr>\n<td>FF</td>\n<td></td>\n</tr>\n<tr>\n<td>65 64 20 66 72 6F 6D 20</td>\n<td>\"ed from \"</td>\n</tr>\n<tr>\n<td>7F</td>\n<td></td>\n</tr>\n<tr>\n<td>48 43 5F 57 6F 72 6B</td>\n<td>\"HC_Work\"</td>\n</tr>\n<tr>\n<td>FC F6 FE 5E 0E</td>\n<td></td>\n</tr>\n<tr>\n<td>20 20 31 2D 32 33 2D</td>\n<td>\"  1-23-\"</td>\n</tr>\n<tr>\n<td>7F</td>\n<td></td>\n</tr>\n<tr>\n<td>39 37 20 44 42 0D 0A</td>\n<td>\"97 DB\\r\\n\"</td>\n</tr>\n<tr>\n<td>19 03 F1 2A 84 0F 8A 02 19 03</td>\n<td></td>\n</tr>\n<tr>\n<td>[remaining bytes follow]</td>\n<td></td>\n</tr>\n</tbody>\n</table>\n</div>\n<p>There are additional sample data <a href=\"https://github.com/CahootsMalone/helicops-stuff/blob/main/file-format-dat.md#sample-data\" rel=\"nofollow noreferrer\">here</a>, including colour palettes (some of which appear to be minimally-compressed).</p>\n<p>I'd appreciate any suggestions regarding how this compression format might work! I'll credit any assistance in the file format documentation I'm writing.</p>\n</div>",
    "votes": "2",
    "answers": 2,
    "views": "246",
    "tags": [
        "decompress"
    ],
    "user": "Reign of Error",
    "time": "Nov 27, 2022 at 0:40",
    "comments": [],
    "answers_data": [
        {
            "content": "<div class=\"s-prose js-post-body\" itemprop=\"text\">\n<p>It's a very similar compression method to that used in\n<a href=\"https://reverseengineering.stackexchange.com/questions/21981/what-compression-type-has-been-used-here/22017\">this question</a>.</p>\n<p>Specifically, the compressed data begins with a flag byte. Each bit of this in turn (from bit 0 to bit 7) indicates that the next decompressed byte(s) are generated by -</p>\n<ul>\n<li>(when the flag bit is 1) copying a single literal byte from the compressed data stream or</li>\n<li>(when the flag bit is 0) copying between N bytes from elsewhere in the decompressed data stream. The length and location of these bytes are encoded in  the following 2 bytes in the compressed data stream.</li>\n</ul>\n<p>Hence <code>0xFF</code> is 8x <code>1</code>s and represents 8 uncompressed bytes.</p>\n<p>Your example file begins with 2 of these, as you identified.</p>\n<p>These are then followed by an <code>FE</code> = <code>0b11111110</code>\nSo this is followed by -</p>\n<ul>\n<li>1 compressed byte-pair <code>FD F4</code>, and</li>\n<li>7 uncompressed literal bytes <code>20 54 6F 77 65 72 20</code></li>\n</ul>\n<p>I think the length part of the compressed byte pair is likely given by 3 + the last nibble (in this case 3+4=7.)\nI haven't quite found an interpretation for the offset/location part of these 2 bytes that works consistently yet though.</p>\n</div>",
            "votes": "2",
            "user": "Ian Cook",
            "time": "Jan 5, 2023 at 15:37",
            "is_accepted": false,
            "comments": [
                {
                    "user": "Reign of Error",
                    "text": "<span class=\"comment-copy\">Thanks, this is very helpful! Knowing this I'm going to take another look at the color palettes (some of which are <a href=\"https://github.com/CahootsMalone/helicops-stuff/blob/main/file-format-dat.md#sample-data\" rel=\"nofollow noreferrer\">here</a>); given the relative simplicity of their data, they should help to narrow down the meaning of the compressed byte pairs.</span>",
                    "time": null
                }
            ]
        },
        {
            "content": "<div class=\"s-prose js-post-body\" itemprop=\"text\">\n<p>The mix of readable text fragments and high byte values makes me suspect LZSS but it may also be some simple RLE-like algorithm. To be completely sure youâ€™d need to find the code which decompresses this data in the executable code.</p>\n</div>",
            "votes": "0",
            "user": "Igor Skochinsky",
            "time": "Dec 4, 2022 at 23:40",
            "is_accepted": false,
            "comments": []
        }
    ]
}