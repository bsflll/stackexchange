{
    "title": "Question about Windows-Functions in malware [closed]",
    "link": "https://reverseengineering.stackexchange.com/questions/6165/question-about-windows-functions-in-malware",
    "content": "<div class=\"s-prose js-post-body\" itemprop=\"text\">\n<div>\n<aside class=\"s-notice s-notice__info post-notice js-post-notice mb16\" role=\"status\">\n<div class=\"d-flex fd-column fw-nowrap\">\n<div class=\"d-flex fw-nowrap\">\n<div class=\"flex--item wmn0 fl1 lh-lg\">\n<div class=\"flex--item fl1 lh-lg\">\n<div>\n<b>Closed.</b> This question is <a href=\"/help/closed-questions\">off-topic</a>. It is not currently accepting answers.\n                                \n                            </div>\n</div>\n</div>\n</div>\n</div>\n<hr class=\"my12 outline-none baw0 bb bc-blue-400\"/>\n<div class=\"fw-nowrap fc-black-500\">\n<div class=\"d-flex fd-column lh-md\">\n<div class=\"mb0 d-flex\">\n<div class=\"flex--item mr8\">\n<svg aria-hidden=\"true\" class=\"svg-icon iconLightbulb\" height=\"18\" viewbox=\"0 0 18 18\" width=\"18\"><path d=\"M15 6.38A6.5 6.5 0 0 0 7.78.04h-.02A6.5 6.5 0 0 0 2.05 5.6a6.3 6.3 0 0 0 2.39 5.75c.49.39.76.93.76 1.5v.24c0 1.07.89 1.9 1.92 1.9h2.75c1.04 0 1.92-.83 1.92-1.9v-.2c0-.6.26-1.15.7-1.48A6.3 6.3 0 0 0 15 6.37M4.03 5.85A4.5 4.5 0 0 1 8 2.02a4.5 4.5 0 0 1 5 4.36 4.3 4.3 0 0 1-1.72 3.44c-.98.74-1.5 1.9-1.5 3.08v.1H7.2v-.14c0-1.23-.6-2.34-1.53-3.07a4.3 4.3 0 0 1-1.64-3.94M10 18a1 1 0 0 0 0-2H7a1 1 0 1 0 0 2z\"></path></svg>\n</div>\n<p> Questions on <b>software development</b> are off-topic here, but can be asked on <a href=\"http://stackoverflow.com/about\">Stack Overflow</a>.</p>\n</div>\n<div class=\"mb0 mt6 d-flex\">\n<p class=\"ml24 pl2\">Closed <span class=\"relativetime\" title=\"2014-09-08 15:27:07Z\">10 years ago</span>.</p>\n</div>\n<div class=\"ml24 pl2\">\n</div>\n</div>\n</div>\n<div class=\"mt24 d-flex gsx gs8\">\n<a class=\"s-btn s-btn__outlined flex--item js-post-notice-edit-post\" href=\"/posts/6165/edit\">\n                        Improve this question\n                    </a>\n</div>\n</aside>\n</div>\n<p>I try to analyze malware since a few months and by examining the assembly code of a trojan for example, I see sometimes windows functions like <code>ws2_32.send</code> which is the <code>send()</code>-function, etc. That is not a problem to understand, I can go to: </p>\n<p><a href=\"http://msdn.microsoft.com/de-de/library/windows/desktop/ms740149%28v=vs.85%29.aspx\" rel=\"nofollow\">http://msdn.microsoft.com/de-de/library/windows/desktop/ms740149%28v=vs.85%29.aspx</a></p>\n<p>and read that, everything is okay. </p>\n<p>But I ask myself, how the people who writes that code put that function in their code. I mean, can you for example write in a C code the function </p>\n<pre><code>  int send(\n     __in  SOCKET s,\n     __in  const char *buf,\n     __in  int len,\n     __in  int flags);\n</code></pre>\n<p>and is it then so that the C compiler understands it ?\nThere are some other functions like <code>CopyFileA</code> for example which looks like:</p>\n<pre><code>  BOOL WINAPI CopyFile(\n  _In_  LPCTSTR lpExistingFileName,\n  _In_  LPCTSTR lpNewFileName,\n  _In_  BOOL bFailIfExists\n  );\n</code></pre>\n<p>Here I ask myself how the compiler understand the word <code>\"WINAPI\"</code> for example and so on.</p>\n<p>In general, if the people try to write such code to create a trojan, how they make clear that it should be a windows function? </p>\n</div>",
    "votes": "0",
    "answers": 2,
    "views": "326",
    "tags": [
        "assembly"
    ],
    "user": "user3097712",
    "time": "10 years ago",
    "comments": [
        {
            "user": "Jongware",
            "text": "<span class=\"comment-copy\">\"WINAPI\" specifies a certain <i>calling convention</i>. See <a href=\"http://stackoverflow.com/questions/13463346/what-does-winapi-stand-for\" title=\"what does winapi stand for\">stackoverflow.com/questions/13463346/what-does-winapi-stand-for</a> for more information.</span>",
            "time": null
        }
    ],
    "answers_data": [
        {
            "content": "<div class=\"s-prose js-post-body\" itemprop=\"text\">\n<p>You're misunderstanding the use of the keyword. As the comment on your questions said, WINAPI is the calling convention for a function. WINAPI is #define'd to __stdcall which specifies how the stack is managed in relation to that function, which you can see documented on MSDN <a href=\"http://msdn.microsoft.com/en-us/library/zxk0tw93.aspx\" rel=\"nofollow\">here</a>. That article gives you a good overview of what it does and how it would get used in the header file. </p>\n<p>It's common for the calling convention to not be explicitly stated for CRT functions on Windows; but that's just in the documentation and doesn't mean the calling convention doesn't need to be declared similarly. Most functions (on x86) will use __stdcall. The most common exception is the printf() family of functions which use the cdecl calling convention. This has more to do with the history of how x86 was developed than any particular design choices.</p>\n<p>Most constants, WINAPI et al, can be found somewhere on MSDN or if you have Visual Studio by hitting F12.</p>\n<p>Now as far as a more general answer to what I take your question to be, as far as how/why you might see certain function calls in a particular sample, the short answer is that Windows provides both the standard C library calls and its own versions of the APIs. In this case, the send() function is defined in Winsock2.h and the function itself is in Ws2_32.lib (also available on that MSDN page you linked). However, what you might call the \"Windows API version\" of this function is also found in the same .h and .lib file: WSASend(), which is documented <a href=\"http://msdn.microsoft.com/en-us/library/windows/desktop/ms742203(v=vs.85).aspx\" rel=\"nofollow\">here</a>.</p>\n<p>You can see by the two articles on MSDN these functions are almost identical, and if you look at the disassmebly for both of them you'd see that WSASend() and send() are almost the exact same function. But Windows supports both so if you learn on Unix or just using the standard C library you can write the same code on windows.</p>\n<p>Most of the other CRT functions (fopen, fread, printf) are implemented in the C Runtime Library, msvcrt.dll. They're mostly independent (compared to socket functions all being in Ws2_32.lib).</p>\n</div>",
            "votes": "4",
            "user": "Fewmitz",
            "time": "Sep 4, 2014 at 3:18",
            "is_accepted": true,
            "comments": []
        },
        {
            "content": "<div class=\"s-prose js-post-body\" itemprop=\"text\">\n<p><code>WINAPI</code> is a declaration in the <code>.h</code> files for <code>__stdcall</code>... \n(<em>ie.</em> standard call type declaration parameters passed on stack and function is expected to balance the stack as opposed to the <code>__cdecl</code> format, or <code>__fastcall</code>).</p>\n<p>And, the compiler does the work for you on the imports:</p>\n<pre><code>BOOL WINAPI CopyFile(\n_In_  LPCTSTR lpExistingFileName,\n_In_  LPCTSTR lpNewFileName,\n_In_  BOOL bFailIfExists\n);\n\npush TRUE ; assume the `bFailIfExists` is set to `true` - compiler looks up\n          ; the equate for true which is typically 01 \n          ; (unless you're coding in Delphi, then its strange).\n\npush offset lpNewFilename ; compiler sets this as a unique address, linker fixes it up.\n\npush offset lpExistingFileName ; same as above\n\ncall [__imp__CopyFile] ; linker fixes this up to the address in the import table\n</code></pre>\n<p>Oh, in asm ; is a comment like // in c. asm example... params are pushed in the opposite order.</p>\n<p>Put simply, regardless of the coding language various things equate to a value, which the compiler knows or sees that its set in the code, the compiler makes the obj files which are compiled code, but addresses are set in a sort of lookup table format, uniquely, imports are declared, but again, name or ordinal style table.</p>\n<p>Then, the linker does the task of putting everything together for the final executable, further stuff is done if its a DLL, like reloc tables and such</p>\n<p>actually its declared here.. look at the <code>#declare WINAPI</code> line near the bottom</p>\n<p><a href=\"http://msdn.microsoft.com/en-us/library/zxk0tw93.aspx\" rel=\"nofollow\">http://msdn.microsoft.com/en-us/library/zxk0tw93.aspx</a></p>\n</div>",
            "votes": "2",
            "user": "perror",
            "time": "Sep 4, 2014 at 6:50",
            "is_accepted": false,
            "comments": []
        }
    ]
}