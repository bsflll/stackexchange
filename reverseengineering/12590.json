{
    "title": "Multiple vendors Misfortune Cookie Router Authentication Bypass Exploit",
    "link": "https://reverseengineering.stackexchange.com/questions/12590/multiple-vendors-misfortune-cookie-router-authentication-bypass-exploit",
    "content": "<div class=\"s-prose js-post-body\" itemprop=\"text\">\n<p>I am working on an exploit over a month now I have a problem and cannot go further.</p>\n<p>here is the link of the exploit:</p>\n<p><a href=\"https://gist.github.com/doorbash/f454c698f192a0e5d1bf4da9c6869b67\" rel=\"nofollow noreferrer\">https://gist.github.com/doorbash/f454c698f192a0e5d1bf4da9c6869b67</a></p>\n<p><a href=\"https://www.exploit-db.com/exploits/39739\" rel=\"nofollow noreferrer\">https://www.exploit-db.com/exploits/39739</a></p>\n<h1>Description:</h1>\n<p>Misfortune Cookie is a critical vulnerability that allows an intruder to remotely take over an Internet router and use it to attack home and business networks.With a few magic cookies added to your request you bypass any authentication and browse the configuration interface as admin, from any open port.</p>\n<p>‌By sending <strong><code>Cxxx=yyy</code></strong> cookie to the router web interface <strong><code>yyy</code></strong> will be saved at memory address <strong><code>xxx * 0x28 + Offset</code></strong>.If we find <strong><code>Authentication Enable/Disable boolean address</code></strong> and <strong><code>offset</code></strong> we can add data for this firmware to the exploit's target list and bypass the authentication by sending the right cookie.</p>\n<h1>How I analyzed the firmwares:</h1>\n<p>The firmware I analyzed at first is <strong>TP-Link 8901G V3 3.0.1 Build 100901 Rel.23594</strong>. <a href=\"http://dl.2dclp.ir/doorbash.ir/mce/3.0.1%20Build%20100901%20Rel.23594\" rel=\"nofollow noreferrer\">download it here</a> and run <code>binwalk -e V3 3.0.1 Build 100901 Rel.23594</code> then open the largest file in extracted directory using IDA by selecting <code>mipsb</code> as the cpu architecture and <code>0x80020000</code> for base address.</p>\n<p>If you search for <strong>Do not need</strong> string using Alt+T keys you will find a <strong>sb XXXX($gp)</strong>\nat the very first lines of the code you realize the <strong>li $gp,YYYYY</strong> instruction. the authentication address will be located by adding <strong>XXXX and YYYYY</strong> which in this case will be <strong>0x803E1829</strong></p>\n<p>Now we must discover how <code>Cookie: CNNNN=MMM;</code> alter memory contents:\nif you search for \"soapaction\" using Alt+T you will find this:</p>\n<p><a href=\"https://i.sstatic.net/rDv05.jpg\" rel=\"nofollow noreferrer\"><img alt=\"\" src=\"https://i.sstatic.net/rDv05.jpg\"/></a></p>\n<p>Go to the sub process highlighted by red color.</p>\n<p><a href=\"https://i.sstatic.net/bBWLw.jpg\" rel=\"nofollow noreferrer\"><img alt=\"\" src=\"https://i.sstatic.net/bBWLw.jpg\"/></a></p>\n<p>Now consider the number 0x6b28 as <strong><code>A = 0x6B28</code></strong></p>\n<p>Now back and toward up:</p>\n<p><a href=\"https://i.sstatic.net/7DReD.jpg\" rel=\"nofollow noreferrer\"><img alt=\"\" src=\"https://i.sstatic.net/7DReD.jpg\"/></a></p>\n<p>Now go to the top sub process:</p>\n<p><a href=\"https://i.sstatic.net/99wie.jpg\" rel=\"nofollow noreferrer\"><img alt=\"\" src=\"https://i.sstatic.net/99wie.jpg\"/></a></p>\n<p>you will find this:</p>\n<p><a href=\"https://i.sstatic.net/O8nNw.jpg\" rel=\"nofollow noreferrer\"><img alt=\"\" src=\"https://i.sstatic.net/O8nNw.jpg\"/></a></p>\n<p>now <strong><code>B = 0xA44</code></strong>, <strong><code>C = 0x1887C</code></strong> and <strong><code>D = 0x8041877C</code></strong>.</p>\n<p>and <strong><code>MAGIC_NUMBER = 0x16B88</code></strong> (I don't have any idea why but it works)</p>\n<p>Now <strong><code>OFFSET = A - B + C + D - MAGIC_NUMBER = 0x80420554</code></strong></p>\n<p>now call <strong><code>info(calc(0x8041877C,0x1887c,0xa44,0x6B28,0x16b88),0x803E1829)</code></strong> or <strong><code>info(0x80420554,0x803E1829)</code></strong> in <a href=\"http://dl.2dclp.ir/doorbash.ir/mce/util.py\" rel=\"nofollow noreferrer\">util.py</a> I attached the output is <strong><code>,107367749,13</code></strong> which is the data we need for this firmware in the exploit.</p>\n<p>the process is very similar (and different and also easier in the <strong>TP-Link W8961ND V3 120830</strong> <a href=\"http://dl.2dclp.ir/doorbash.ir/mce/TD-W8961ND_V3_120830_FI\" rel=\"nofollow noreferrer\">download it here</a></p>\n<p><a href=\"https://i.sstatic.net/iXovp.jpg\" rel=\"nofollow noreferrer\"><img alt=\"\" src=\"https://i.sstatic.net/iXovp.jpg\"/></a></p>\n<pre><code>AuthenticationAddress = 0x803605B4\nA = 0x6B28\nB = 0x0 (move    $a0, $s1)\nC = 0x17E38\nD = 0x804234C8\nMAGIC_NUMBER = 0x16B88\nOFFSET = A-B+C+D-MAGIC_NUMBER = 0x8042B2A0\n</code></pre>\n<p>We call <strong><code>info(0x8042B2A0,0x803605B4)</code></strong> in <a href=\"http://dl.2dclp.ir/doorbash.ir/mce/util.py\" rel=\"nofollow noreferrer\">util.py</a> and output is <strong><code>,107353414,36</code></strong> which is tested on real device and works.</p>\n<h1>THE PROBLEM IS:</h1>\n<p>for <strong>TD_W961ND_V3_140305</strong> <a href=\"http://dl.2dclp.ir/doorbash.ir/mce/TD-W8961ND_V3_140305\" rel=\"nofollow noreferrer\">download it here</a> the firmware has <strong>\"Do not need\"</strong> and <strong>\"soapacation\"</strong> texts but IDA cannot find the pointing addresses to these strings.I could not find out why.</p>\n<p>The modifications and bug fixes for this according to <a href=\"http://www.tp-link.com/en/download/TD-W8961ND_V3.html#Firmware\" rel=\"nofollow noreferrer\">here</a> is :</p>\n<ol>\n<li><p><strong>Add the security mechanism.</strong></p></li>\n<li><p>Fixed the problem router's time can't synchronize from PC successfully.</p></li>\n<li><p>Banned accessing the firmware upgrading page from WAN.</p></li>\n<li><p>Fixed the problem that router failed to upload rom-0(Backup configuration).</p></li>\n<li><p>Solved the problem that the login interface can't save the password correctly in Chrome and Firefox.</p></li>\n<li><p>Solved the problem that we can’t visit CPE using “IP:Port” after we set up Virtual Server.</p></li>\n<li><p>Forbidden access to the device through <a href=\"http://wan/lan\" rel=\"nofollow noreferrer\">http://wan/lan</a> ip/ or <a href=\"http://wan/lan\" rel=\"nofollow noreferrer\">http://wan/lan</a> ip/xxx.htm.</p></li>\n<li><p>Fixed other bugs and problems.</p></li>\n</ol>\n<p>I am not sure if the security mechanism (#1) is what is making this issue or not.</p>\n<p>I also tried to compare 100901, 120830 and 140305 using binwalk entropy:</p>\n<h1>binwalk -E -J 120830 140305 100901</h1>\n<h1>100901:</h1>\n<p><a href=\"https://i.sstatic.net/FEcZb.png\" rel=\"nofollow noreferrer\"><img alt=\"\" src=\"https://i.sstatic.net/FEcZb.png\"/></a></p>\n<h1>120830:</h1>\n<p><a href=\"https://i.sstatic.net/XnGjQ.png\" rel=\"nofollow noreferrer\"><img alt=\"\" src=\"https://i.sstatic.net/XnGjQ.png\"/></a></p>\n<h1>140305:</h1>\n<p><a href=\"https://i.sstatic.net/KRDUz.png\" rel=\"nofollow noreferrer\"><img alt=\"\" src=\"https://i.sstatic.net/KRDUz.png\"/></a></p>\n<p>I know somethings wrong with <strong>140305</strong> (unusual wave forms at left) but could not come across any findings.</p>\n<h1>Update 1:</h1>\n<p>Here is how memory address <code>0x800D53BC</code> looks like in my IDA:</p>\n<p><a href=\"https://i.sstatic.net/WHYi9.jpg\" rel=\"nofollow noreferrer\"><img alt=\"\" src=\"https://i.sstatic.net/WHYi9.jpg\"/></a></p>\n<p>Any idea or tip about how to fix this mess?</p>\n<p><a href=\"https://i.sstatic.net/hlmok.jpg\" rel=\"nofollow noreferrer\"><img alt=\"\" src=\"https://i.sstatic.net/hlmok.jpg\"/></a></p>\n</div>",
    "votes": "4",
    "answers": 1,
    "views": "737",
    "tags": [
        "ida",
        "disassembly",
        "firmware"
    ],
    "user": "doorbash",
    "time": "Feb 25, 2018 at 9:34",
    "comments": [],
    "answers_data": [
        {
            "content": "<div class=\"s-prose js-post-body\" itemprop=\"text\">\n<p>According to <a href=\"http://www.tp-link.com/en/download/TD-W8961ND_V3.html#Firmware\" rel=\"nofollow noreferrer\">TP-LINK</a> the misfortune cookie was fixed only in firmware version TD-W8961ND_V3_150707. So, the TD_W961ND_V3_140305 is also vulnerable.</p>\n<p>Since it is a binary file you may not analyse the code part dealing with the <code>soapaction</code> string, but here is what I found for firmware 140305:</p>\n<p><a href=\"https://i.sstatic.net/kEFxG.png\" rel=\"nofollow noreferrer\"><img alt=\"enter image description here\" src=\"https://i.sstatic.net/kEFxG.png\"/></a></p>\n<p>UPDATE!</p>\n<p>You can find the \"Do not need\" string at <code>0x801a015a</code>. For some reasons it is mips16 code and was referenced only from the command table as the <code>pswauthen</code> command handler. So, you have to change the code representation to mips16 with <code>alt+g</code> at the start of the handler and then press <code>c</code>.</p>\n<p><a href=\"https://i.sstatic.net/swtf7.png\" rel=\"nofollow noreferrer\"><img alt=\"enter image description here\" src=\"https://i.sstatic.net/swtf7.png\"/></a></p>\n</div>",
            "votes": "2",
            "user": "ebux",
            "time": "May 5, 2016 at 8:37",
            "is_accepted": true,
            "comments": [
                {
                    "user": "doorbash",
                    "text": "<span class=\"comment-copy\">Please see Update 1 in the question. thanks.</span>",
                    "time": null
                },
                {
                    "user": "ebux",
                    "text": "<span class=\"comment-copy\">I don't know why IDA could not found ASCII in your case, but you can use 'a' (create ASCII) to create strings or you may create a simple script, which does this job.</span>",
                    "time": null
                },
                {
                    "user": "doorbash",
                    "text": "<span class=\"comment-copy\">Thanks, what about \"Do not need\" string? any idea why there is no pointing address to it?</span>",
                    "time": null
                },
                {
                    "user": "ebux",
                    "text": "<span class=\"comment-copy\">See the update in my answer.</span>",
                    "time": null
                },
                {
                    "user": "doorbash",
                    "text": "<span class=\"comment-copy\">I saw it unfortunately I could not do what you did in update. IDA 6.8 still shows garbage, but well done I will set it as best answer when I worked on it again and managed to do it, thanks for your time. What version of IDA you got?</span>",
                    "time": null
                }
            ]
        }
    ]
}