{
    "title": "Strange exception thrown while debugging in Win10, but not Win7",
    "link": "https://reverseengineering.stackexchange.com/questions/29727/strange-exception-thrown-while-debugging-in-win10-but-not-win7",
    "content": "<div class=\"s-prose js-post-body\" itemprop=\"text\">\n<p>I am disassembling a <em>legacy</em> 32-bit (x86) application using IDA Home (7.6) (for x86 disassembly) in a 64-bit Windows 10 environment running in a virtual machine (VMWare Fusion for Mac). The application executes without issue when outside a debugger, however, when running the application using the \"Local Windows Debugger\" in IDA (loaded as a <strong>MetaPC</strong> project), an \"<em>unknown exception code 6A6</em>\" is thrown:</p>\n<p>                                       \n<a href=\"https://i.sstatic.net/Ddgsa.png\" rel=\"nofollow noreferrer\"><img alt=\"IDA Error Exception Message\" src=\"https://i.sstatic.net/Ddgsa.png\"/></a></p>\n<p>This exception occurs shortly after the application execution has begun in the debugger (i.e. without any application user input).</p>\n<p>To eliminate a possible issue with IDA, I tested using the <a href=\"https://x64dbg.com/#start\" rel=\"nofollow noreferrer\">x32dbg</a> debugger and the <a href=\"https://www.ollydbg.de/\" rel=\"nofollow noreferrer\">Ollydbg</a> debugger. Both debuggers throw the <strong>same</strong> raised exception, namely the <a href=\"https://efmsoft.com/what-is/?code=1702\" rel=\"nofollow noreferrer\"><code>RPC_S_INVALID_BINDING</code></a> (<code>0x000006A6</code>) error:</p>\n<p>                       \n<a href=\"https://i.sstatic.net/Qp6iE.png\" rel=\"nofollow noreferrer\"><img alt=\"x32dbg Raised Exception\" src=\"https://i.sstatic.net/Qp6iE.png\"/></a></p>\n<p>I spent some time thinking about why I am facing issues running the application inside a debugger and I came up with a few possible reasons:</p>\n<ol>\n<li>Anti-debugger techniques.</li>\n<li>64-bit debuggers are loading the wrong DLLs (i.e. they're loading the 64-bit DLL when it should be loading the 32-bit DLL located in <code>C:\\WINDOWS\\SysWOW64\\</code>).\n<ul>\n<li>Reference(s):\n<ul>\n<li><a href=\"https://reverseengineering.stackexchange.com/questions/12194/ida-pro-64-bit-disassembly-error-for-system-dlls\">IDA Pro 64 bit disassembly error for system DLLs</a></li>\n<li><a href=\"https://lucasg.github.io/2016/05/30/Do-not-load-dll-from-System32-directly-into-IDA/\" rel=\"nofollow noreferrer\">Do not load dll from System32 directly into IDA</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li><em>Something else</em> (??)</li>\n</ol>\n<p>I am able to disprove that both #1 and #2 are <strong>not</strong> the issues after setting up a 64-bit  Windows 7 with Service Pack 1 environment. I am able to debug the application in IDA <strong>without</strong> issue while in this Windows 7 environment (i.e. the <code>6A6</code> exception is <strong>not</strong> thrown).</p>\n<p>So, this leads me to #3 - a head scratching moment. I did some research into the <a href=\"https://efmsoft.com/what-is/?code=1702\" rel=\"nofollow noreferrer\"><code>RPC_S_INVALID_BINDING</code></a> (<code>0x000006A6</code>) error and came across <a href=\"https://stackoverflow.com/questions/13987610/qt-in-separate-thread-gives-first-chance-exception-at-0x74f2c41f-infoo-exe-0x\">this StackOverflow question</a>. Naming, the accepted answer notes the following:</p>\n<blockquote>\n<p>Explaining 'The Binding Handle Is Invalid'<br/><br/>\nToday I want to try to give more insight into the 'Binding Handle Is Invalid' problem that a number of people have reported with the VS 2005 debugger.<br/><br/>\nFirst, if all you care about is how to solve the problem: Enable the 'Terminal Services' service and reboot. If you want to know more, read on.</p>\n</blockquote>\n<p>I tried enabling the <code>Terminal Services</code> (now named <code>Remote Desktop Services</code> on Windows 10 [<a href=\"https://docs.microsoft.com/en-us/windows/win32/termserv/terminal-services-is-now-remote-desktop-services\" rel=\"nofollow noreferrer\">reference</a>]), however, this doesn't solve the issue and I still get an \"<em>unknown exception code 6A6</em>\" error. The <a href=\"https://efmsoft.com/what-is/?code=1702\" rel=\"nofollow noreferrer\"><code>RPC_S_INVALID_BINDING</code></a> (<code>0x000006A6</code>) error confuses me quite a bit.</p>\n<p>There clearly appears to be something wrong with my environment setup with Windows 10 that isn't allowing me to specifically debug this application. Something changed from Windows 7 that is causing this issue and I'm at a loss here.</p>\n<p><strong>Does anyone know what might be the issue here?</strong></p>\n<br/>\n<p>Environment Detail(s):</p>\n<ul>\n<li>OSes Tested in VMWare Fusion (12.2.1 (18811640)):\n<ul>\n<li><strong>[❌ - Issue]</strong> Windows 10 (x64) - Build 19042 (20H2 / 20H2)</li>\n<li><strong>[❌ - Issue]</strong> Windows 10 (x64) - Build 15063 (1703 / Redstone 2)</li>\n<li><strong>[❌ - Issue]</strong> Windows 10 (x64) - Build 14393 (1607 / Redstone 1)</li>\n<li><strong>[✅ - No Issue]</strong> Windows 7 Ultimate (x64) - Build 7601 (Service Pack 1)</li>\n</ul>\n</li>\n<li>Tools Used (<em>launched as Administrator</em>):\n<ul>\n<li>IDA Home 7.6 (v7.6.210427) (x64)</li>\n<li>x32dbg (Release \"July 1 2021, 23:09:08\") (x64)</li>\n<li>Ollydbg (v2.01) (x86)</li>\n</ul>\n</li>\n</ul>\n<h2>Update #1:</h2>\n<p>As requested, here is the call stack (a.k.a. stack trace) when the exception occurs:</p>\n<p><a href=\"https://i.sstatic.net/WVzBB.png\" rel=\"nofollow noreferrer\"><img alt=\"Call stack at the point of the exception\" src=\"https://i.sstatic.net/WVzBB.png\"/></a></p>\n<p>The application appears to be checking the DirectX9 environment and whether it is supported or not. Although, this is a guess on my part from the name of the DLL, <code>DX9EnvChk.dll</code>, which is included alongside the application in question. I can't find much information about this DLL through a normal web search, but it appears to be present with other applications of the era. This DLL (nor accompanying header file) was <strong>not</strong> part of the <a href=\"https://www.microsoft.com/en-us/download/details.aspx?id=6812\" rel=\"nofollow noreferrer\">Microsoft DirectX SDK (June 2010)</a> from what I can see.</p>\n</div>",
    "votes": "2",
    "answers": 0,
    "views": "424",
    "tags": [
        "ida",
        "debugging",
        "x64dbg",
        "exception"
    ],
    "user": "Dannon",
    "time": "Dec 19, 2021 at 3:53",
    "comments": [
        {
            "user": "0xC0000022L",
            "text": "<span class=\"comment-copy\">Hi and welcome to RE.SE. Have you looked at what <a href=\"https://www.geoffchappell.com/studies/windows/win32/apphelp/history/index.htm?tx=88\" rel=\"nofollow noreferrer\">shims</a> get applied? You stress the fact it's a legacy application <i>and</i> we already know it would get to run inside WOW64 on all your tested OSs. Other things I'd look at are 1.) anti-malware solutions, 2.) active mitigations 3.) the event log (oftentimes RPC and COM issues will be logged). Also, have you looked at the call stack at the time of the exception?</span>",
            "time": null
        },
        {
            "user": "Dannon",
            "text": "<span class=\"comment-copy\">@0xC0000022L - There are no custom shims installed along side this application. I verified no custom shims were applied by checking <code>HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\AppCompatFlags\\InstalledSDB</code> - at the time of installation, this key didn't exist. The app likewise doesn't need to be run in a compatibility mode (when running outside a debugger). I also checked the Event Viewer logs for any RPC/COM logs (3), but nothing is logged. Lastly, I just updated my answer with the call stack. The exception in the debugger appears to be happening during the DirectX9 environment check.</span>",
            "time": null
        },
        {
            "user": "Dannon",
            "text": "<span class=\"comment-copy\">@0xC0000022L - Can you provide some more insights on #1 and #2 you listed as \"things [to] look at?\" Let me also know if you think of any more insight from the updated information I provided in my comment above. I should also note that I am running these OSes in a virtual machine (i.e. VMWare Fusion on Mac). I updated my post above to reflect this.</span>",
            "time": null
        },
        {
            "user": "0xC0000022L",
            "text": "<span class=\"comment-copy\">Thanks for the update. Question 1 was geared at solutions that try to preempt exploits (and since Windows 8 or so more often than not subvert the built-in mechanisms WIndows has gained). If you use Windows Defender, you probably needn't care. Active mitigations come in a number of shapes. I suggest you use Process Explorer and look at the various columns you can activate in the main view as well as the Properties dialog for the process. It's unlikely that mitigations are activated for an old executable image, though. How many functions does the <code>DX9EnvChk.dll</code> export?</span>",
            "time": null
        }
    ],
    "answers_data": []
}