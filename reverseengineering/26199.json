{
    "title": "How to find \"RawAddress\" of a \"VirtualAddress\"?",
    "link": "https://reverseengineering.stackexchange.com/questions/26199/how-to-find-rawaddress-of-a-virtualaddress",
    "content": "<div class=\"s-prose js-post-body\" itemprop=\"text\">\n<p>I'm trying to parse a PE file manually as below:</p>\n<pre><code>    1 ### DOS Header\n    2 \n    3 00000000: 4d5a 9000 0300 0000 0400 0000 ffff 0000  MZ..............\n    4 00000010: b800 0000 0000 0000 4000 0000 0000 0000  ........@.......\n    5 00000020: 0000 0000 0000 0000 0000 0000 0000 0000  ................\n    6 00000030: 0000 0000 0000 0000 0000 0000 8000 0000  ................   // e_lfanew = 0x00000080\n    7 \n    8     - DOS Stub\n    9 00000040: 0e1f ba0e 00b4 09cd 21b8 014c cd21 5468  ........!..L.!Th\n   10 00000050: 6973 2070 726f 6772 616d 2063 616e 6e6f  is program canno\n   11 00000060: 7420 6265 2072 756e 2069 6e20 444f 5320  t be run in DOS\n   12 00000070: 6d6f 6465 2e0d 0d0a 2400 0000 0000 0000  mode....$.......\n   13 \n   14 -------------------------------------------------------------------\n   15 \n   16 ### NT Header\n   17 \n   18     - Magic\n   19 00000080: 5045 0000\n   20 \n   21     - File Header\n   22                     4c01 0f00 3f55 785e 0088 0400  PE..L...?Ux^....   // NumberOfSections = 0x000f = 15\n   23 00000090: a705 0000 e000 0701                                         // SizeOfOptionalHeader = 0x000e = 14 * 16\n   24 \n   25     - Optional Header\n   26                               0b01 0221 0022 0000  ...........!.\"..\n   27 000000a0: 003a 0000 0006 0000 c014 0000 0010 0000  .:..............   // EntryPoint = 0x000014c0 &amp; BaseOfCode = 0x00001000\n   28 000000b0: 0040 0000 0000 4000 0010 0000 0002 0000  .@....@.........   // BaseOfData = 0x00004000 &amp; ImageBase = 0x00400000 &amp; SectionAlignment = 0x00001000 &amp; FileAlignment = 0x00000200\n   29 000000c0: 0400 0000 0100 0000 0400 0000 0000 0000  ................\n   30 000000d0: 0030 0500 0004 0000 3004 0500 0300 4001  .0......0.....@.\n   31 000000e0: 0000 2000 0010 0000 0000 1000 0010 0000  .. .............\n   32 000000f0: 0000 0000 1000 0000\n   33 \n   34         - Data Directories\n   35                               0000 0000 0000 0000  ................\n   36 00000100: 0070 0000 5c07 0000 0000 0000 0000 0000  .p..\\...........   // ImportDirectory: VirtualAddress = 0x00007000 &amp; Size = 0x0000075c\n   37 00000110: 0000 0000 0000 0000 0000 0000 0000 0000  ................\n   38 00000120: 0000 0000 0000 0000 0000 0000 0000 0000  ................\n   39 00000130: 0000 0000 0000 0000 0000 0000 0000 0000  ................\n   40 00000140: 5052 0000 1800 0000 0000 0000 0000 0000  PR..............\n   41 00000150: 0000 0000 0000 0000 6871 0000 0401 0000  ........hq......\n   42 00000160: 0000 0000 0000 0000 0000 0000 0000 0000  ................\n   43 00000170: 0000 0000 0000 0000\n   44 \n   45 -------------------------------------------------\n   46 \n   47 ### Section Headers\n   48 \n   49                               2e74 6578 7400 0000  .........text...\n   50 00000180: 6421 0000 0010 0000 0022 0000 0004 0000  d!.......\"......\n   51 00000190: 0000 0000 0000 0000 0000 0000 6000 5060  ............`.P`\n   52 \n   53 000001a0: 2e64 6174 6100 0000 3400 0000 0040 0000  .data...4....@..\n   54 000001b0: 0002 0000 0026 0000 0000 0000 0000 0000  .....&amp;..........\n   55 000001c0: 0000 0000 4000 30c0\n   56                               2e72 6461 7461 0000  <a class=\"__cf_email__\" data-cfemail=\"694747474729475947471b0d081d08\" href=\"/cdn-cgi/l/email-protection\">[email protected]</a>..\n   57 000001d0: 6c08 0000 0050 0000 000a 0000 0028 0000  l....P.......(..\n   58 000001e0: 0000 0000 0000 0000 0000 0000 4000 3040  <a class=\"__cf_email__\" data-cfemail=\"95bbbbbbbbbbbbbbbbbbbbbbbbd5bba5\" href=\"/cdn-cgi/l/email-protection\">[email protected]</a>@\n   59 \n   60 000001f0: 2e62 7373 0000 0000 0c04 0000 0060 0000  .bss.........`..\n   61 00000200: 0000 0000 0000 0000 0000 0000 0000 0000  ................\n   62 00000210: 0000 0000 8000 60c0\n   63                               2e69 6461 7461 0000  ......`..idata..   // .idata section header\n   64 00000220: 5c07 0000 0070 0000 0008 0000 0032 0000  \\....p.......2..   // VirtualSize = 0x0000075c &amp; VirtualAddress = 0x00000700\n   65 00000230: 0000 0000 0000 0000 0000 0000 4000 30c0  <a class=\"__cf_email__\" data-cfemail=\"715f5f5f5f5f5f5f5f5f5f5f5f315f41\" href=\"/cdn-cgi/l/email-protection\">[email protected]</a>.\n   66 \n   67 00000240: 2e43 5254 0000 0000 3400 0000 0080 0000  .CRT....4.......\n   68 00000250: 0002 0000 003a 0000 0000 0000 0000 0000  .....:..........\n   69 00000260: 0000 0000 4000 30c0\n   70                               2e74 6c73 0000 0000  <a class=\"__cf_email__\" data-cfemail=\"96b8b8b8b8d6b8a6b8b8e2fae5\" href=\"/cdn-cgi/l/email-protection\">[email protected]</a>....\n   71 00000270: 0800 0000 0090 0000 0002 0000 003c 0000  .............&lt;..\n   72 00000280: 0000 0000 0000 0000 0000 0000 4000 30c0  <a class=\"__cf_email__\" data-cfemail=\"fcd2d2d2d2d2d2d2d2d2d2d2d2bcd2cc\" href=\"/cdn-cgi/l/email-protection\">[email protected]</a>.\n   73 \n   74 00000290: 2f34 0000 0000 0000 e002 0000 00a0 0000  /4..............\n   75 000002a0: 0004 0000 003e 0000 0000 0000 0000 0000  .....&gt;..........\n   76 000002b0: 0000 0000 4000 1042\n   77                               2f31 3900 0000 0000  <a class=\"__cf_email__\" data-cfemail=\"2e000000006e00006c\" href=\"/cdn-cgi/l/email-protection\">[email protected]</a>/19.....\n   78 000002c0: efb8 0300 00b0 0000 00ba 0300 0042 0000  .............B..\n   79 000002d0: 0000 0000 0000 0000 0000 0000 4000 1042  <a class=\"__cf_email__\" data-cfemail=\"7b5555555555555555555555553b555539\" href=\"/cdn-cgi/l/email-protection\">[email protected]</a>\n   80 \n   81 000002e0: 2f33 3100 0000 0000 dd25 0000 0070 0400  /31......%...p..\n   82 000002f0: 0026 0000 00fc 0300 0000 0000 0000 0000  .&amp;..............\n   83 00000300: 0000 0000 4000 1042\n   84                               2f34 3500 0000 0000  <a class=\"__cf_email__\" data-cfemail=\"a886868686e88686ea\" href=\"/cdn-cgi/l/email-protection\">[email protected]</a>/45.....\n   85 00000310: 9d34 0000 00a0 0400 0036 0000 0022 0400  .4.......6...\"..\n   86 00000320: 0000 0000 0000 0000 0000 0000 4000 1042  <a class=\"__cf_email__\" data-cfemail=\"1c3232323232323232323232325c32325e\" href=\"/cdn-cgi/l/email-protection\">[email protected]</a>\n   87 \n   88 00000330: 2f35 3700 0000 0000 1c09 0000 00e0 0400  /57.............\n   89 00000340: 000a 0000 0058 0400 0000 0000 0000 0000  .....X..........\n   90 00000350: 0000 0000 4000 3042\n   91 \n   92                               2f37 3000 0000 0000  <a class=\"__cf_email__\" data-cfemail=\"d6f8f8f8f896f8e694\" href=\"/cdn-cgi/l/email-protection\">[email protected]</a>/70.....\n   93 00000360: 1e05 0000 00f0 0400 0006 0000 0062 0400  .............b..\n   94 00000370: 0000 0000 0000 0000 0000 0000 4000 1042  <a class=\"__cf_email__\" data-cfemail=\"fed0d0d0d0d0d0d0d0d0d0d0d0bed0d0bc\" href=\"/cdn-cgi/l/email-protection\">[email protected]</a>\n   95 \n   96 00000380: 2f38 3100 0000 0000 601a 0000 0000 0500  /81.....`.......\n   97 00000390: 001c 0000 0068 0400 0000 0000 0000 0000  .....h..........\n   98 000003a0: 0000 0000 4000 1042\n   99 \n  100                               2f39 3200 0000 0000  <a class=\"__cf_email__\" data-cfemail=\"85ababababc5ababc7\" href=\"/cdn-cgi/l/email-protection\">[email protected]</a>/92.....\n  101 000003b0: 4003 0000 0020 0500 0004 0000 0084 0400  @.... ..........\n  102 000003c0: 0000 0000 0000 0000 0000 0000 4000 1042  <a class=\"__cf_email__\" data-cfemail=\"a48a8a8a8a8a8a8a8a8a8a8a8ae48a8ae6\" href=\"/cdn-cgi/l/email-protection\">[email protected]</a>\n  103 \n  104 -------------------------------------------------\n  105 \n  106     - Padding for FileAlignment?\n  107 \n  108 000003d0: 0000 0000 0000 0000 0000 0000 0000 0000  ................\n  109 000003e0: 0000 0000 0000 0000 0000 0000 0000 0000  ................\n  110 000003f0: 0000 0000 0000 0000 0000 0000 0000 0000  ................\n  111 \n  112 ------------------------------------------------\n  113 \n  114 ### Sections\n  115 \n  116 00000400: c38d b426 0000 0000 8db4 2600 0000 0090  ...&amp;......&amp;.....\n  117 00000410: 83ec 1c31 c066 813d 0000 4000 4d5a c705  <a class=\"__cf_email__\" data-cfemail=\"cfe1e1e1fee1a9e1f2e1e18fe18295\" href=\"/cdn-cgi/l/email-protection\">[email protected]</a>..\n  118 00000420: 8c63 4000 0100 0000 c705 8863 4000 0100  <a class=\"__cf_email__\" data-cfemail=\"9eb0fddeb0b0b0b0b0b0b0b0fd\" href=\"/cdn-cgi/l/email-protection\">[email protected]</a>@...\n  119 00000430: 0000 c705 8463 4000 0100 0000 c705 3060  <a class=\"__cf_email__\" data-cfemail=\"dff1f1f1f1f1bc9ff1f1f1f1f1f1f1ef\" href=\"/cdn-cgi/l/email-protection\">[email protected]</a>`\n  120 00000440: 4000 0100 0000 7518 8b15 3c00 4000 81ba  @.....u...&lt;.@...\n  121 00000450: 0000 4000 5045 0000 8d8a 0000 4000 7450  <a class=\"__cf_email__\" data-cfemail=\"e5cbcba5cbb5a0\" href=\"/cdn-cgi/l/email-protection\">[email protected]</a><a class=\"__cf_email__\" data-cfemail=\"5a7474747474741a742e0a\" href=\"/cdn-cgi/l/email-protection\">[email protected]</a>\n  122 00000460: a30c 6040 00a1 9463 4000 85c0 7532 c704  ..`@<a class=\"__cf_email__\" data-cfemail=\"381616165b781616164d0a\" href=\"/cdn-cgi/l/email-protection\">[email protected]</a>..\n  123 00000470: 2401 0000 00e8 0220 0000 e805 2000 008b  $...... .... ...\n  124 00000480: 15a8 6340 0089 10e8 d40f 0000 833d 1c40  ..c@.........=.@\n  125 00000490: 4000 0174 4b31 c083 c41c c38d 7426 0090  @..tK1......t&amp;..\n  126 000004a0: c704 2402 0000 00e8 d01f 0000 ebcc 6690  ..$...........f.\n  127 000004b0: 0fb7 5118 6681 fa0b 0174 3d66 81fa 0b02  ..Q.f....t=f....\n         ...           .... Truncated .....                   ...\n</code></pre>\n<p>My questions:</p>\n<ol>\n<li>As you see above, in the line #36, we have <code>virtualAddress</code> related to import libraries. How can I find the corresponding rawAddress of those data in the file content? I mean, how can I convert virtualAddresses to rawAddresses?</li>\n<li>As you see above, we have virtualAddress and Size fields in second index of DataDirectory in optionalHeader (Line #36) and also in .idata sectionHeader (Line #64). And both have equal values. Why? Isn't that redundant? Do we have some cases which these fields have different values?</li>\n<li>As far as I know, .text section contains the program's assembly code. So why EntryPoint field in the OptionalHeader doesn't have the address of beginning of .text section?</li>\n</ol>\n</div>",
    "votes": "2",
    "answers": 1,
    "views": "419",
    "tags": [
        "pe",
        "entry-point",
        "pe32",
        "virtual-memory"
    ],
    "user": "Ebrahim Ghasemi",
    "time": "Oct 30, 2020 at 11:44",
    "comments": [],
    "answers_data": [
        {
            "content": "<div class=\"s-prose js-post-body\" itemprop=\"text\">\n<ol>\n<li><p>you need to parse the section table, figure out to which section your address belongs (using their VirtualAddress and VirtualSize), then calculate the offset from the section start and add it to the section's physical offset. E.g.:</p>\n<p><code>SectionOffset = addr - section[i].VirtualAddress</code><br/>\n<code>offset = SectionOffset + section[i].PointerToRawData</code></p>\n</li>\n<li><p>A directory does not necessarily match a whole section. It may be a small part of a section or (in theory) even cross a section boundary. Note that in practice the OS loader may ignore the size field but use e.g. a NULL terminator to detect the end of data.</p>\n</li>\n<li><p>entry point  is not necessarily at the start of <code>.text</code>. This was common in <code>a.out</code> binaries but is pretty rare nowadays both for PE and ELF. Usually there are other functions (e.g. library code) and/or read-only data at the beginning.</p>\n</li>\n</ol>\n</div>",
            "votes": "2",
            "user": "Igor Skochinsky",
            "time": "Oct 30, 2020 at 20:19",
            "is_accepted": true,
            "comments": []
        }
    ]
}