{
    "title": "Unpack IpCam firmware - Binwalk extraction issue",
    "link": "https://reverseengineering.stackexchange.com/questions/11791/unpack-ipcam-firmware-binwalk-extraction-issue",
    "content": "<div class=\"s-prose js-post-body\" itemprop=\"text\">\n<p>I'm trying to use Binwalk to extract an IpCam bin firmware. I did it successfully for the WebUI, but I can't on the firmware itself.</p>\n<ul>\n<li>Hardware : Vstarcam C7824WIP</li>\n<li>Firmware : <a href=\"http://cd.gocam.so/FM/system/CH-sys-48.53.64.67.zip\" rel=\"noreferrer\">CH-sys-48.53.64.67.zip</a></li>\n<li>WebUI : <a href=\"http://cd.gocam.so/FM/vstarcam/CH-app-EN53.8.1.13_VSTARCAM.zip\" rel=\"noreferrer\">CH-app-EN53.8.1.13_VSTARCAM.zip</a></li>\n</ul>\n<p>Problem : It's only extracting \"sysversion.txt, a bit light :).</p>\n<p>Files :</p>\n<pre><code>ron@vpsXXXXXX:~/firmware$ ls\nCH-sys-48.53.64.67.zip\n</code></pre>\n<p>Verification and extraction :</p>\n<pre><code>ron@vpsXXXXXX:~/firmware$ binwalk CH-sys-48.53.64.67.zip\n\nDECIMAL       HEXADECIMAL     DESCRIPTION\n--------------------------------------------------------------------------------\n0             0x0             Zip archive data, at least v2.0 to extract, compressed size: 605571, uncompressed size: 612699, name: CH-sys-48.53.64.67.bin\n605717        0x93E15         End of Zip archive\n\nron@vpsXXXXXX:~/firmware$ file CH-sys-48.53.64.67.zip\nCH-sys-48.53.64.67.zip: Zip archive data, at least v2.0 to extract\nron@vpsXXXXXX:~/firmware$ unzip CH-sys-48.53.64.67.zip\nArchive:  CH-sys-48.53.64.67.zip\n  inflating: CH-sys-48.53.64.67.bin\n</code></pre>\n<p>Binwalk without extracting :</p>\n<pre><code>ron@vpsXXXXXX:~/firmware$ binwalk CH-sys-48.53.64.67.bin\n\nDECIMAL       HEXADECIMAL     DESCRIPTION\n--------------------------------------------------------------------------------\n172           0xAC            Zip archive data, at least v2.0 to extract, compressed size: 8969, uncompressed size: 19091, name: system/system/lib/libsns_gc1004.so\n9337          0x2479          End of Zip archive\n9499          0x251B          Zip archive data, at least v2.0 to extract, compressed size: 7813, uncompressed size: 16341, name: system/system/lib/libsns_ov9712_plus.so\n17518         0x446E          End of Zip archive\n17680         0x4510          Zip archive data, at least v2.0 to extract, compressed size: 90121, uncompressed size: 353248, name: system/system/lib/libOnvif.so\n107987        0x1A5D3         End of Zip archive\n108149        0x1A675         Zip archive data, at least v2.0 to extract, compressed size: 43603, uncompressed size: 84480, name: system/system/lib/libvoice_arm.so\n151946        0x2518A         End of Zip archive\n152108        0x2522C         Zip archive data, at least v2.0 to extract, compressed size: 130, uncompressed size: 227, name: system/init/ipcam.sh\n152406        0x25356         End of Zip archive\n152568        0x253F8         Zip archive data, at least v2.0 to extract, compressed size: 402383, uncompressed size: 886168, name: system/system/bin/encoder\n555129        0x87879         End of Zip archive\n555291        0x8791B         Zip archive data, at least v2.0 to extract, compressed size: 35394, uncompressed size: 74200, name: system/system/bin/wifidaemon\n590869        0x90415         End of Zip archive\n591031        0x904B7         Zip archive data, at least v2.0 to extract, compressed size: 1852, uncompressed size: 9692, name: system/system/bin/grade.sh\n593063        0x90CA7         End of Zip archive\n593225        0x90D49         Zip archive data, at least v2.0 to extract, compressed size: 8704, uncompressed size: 20212, name: system/system/bin/updata\n602105        0x92FF9         End of Zip archive\n602267        0x9309B         Zip archive data, at least v2.0 to extract, compressed size: 1874, uncompressed size: 4522, name: system/system/bin/gpio_aplink.ko\n604333        0x938AD         End of Zip archive\n604495        0x9394F         Zip archive data, at least v2.0 to extract, compressed size: 7241, uncompressed size: 16802, name: system/system/bin/motogpio.ko\n611922        0x95652         End of Zip archive\n612084        0x956F4         Zip archive data, at least v1.0 to extract, compressed size: 8, uncompressed size: 8, name: system/system/bin/fwversion.bin\n612282        0x957BA         End of Zip archive\n612444        0x9585C         Zip archive data, at least v1.0 to extract, compressed size: 9, uncompressed size: 9, name: system/system/bin/sysversion.txt\n612645        0x95925         End of Zip archive\n</code></pre>\n<p>Binwalk extraction : </p>\n<pre><code>ron@vpsXXXXXX:~/firmware$ binwalk -Mer CH-sys-48.53.64.67.bin\n\nScan Time:     2016-01-19 00:36:12\nTarget File:   /home/ron/firmware/CH-sys-48.53.64.67.bin\nMD5 Checksum:  58df9214226cfe46760215bfca0c496c\nSignatures:    344\n\nDECIMAL       HEXADECIMAL     DESCRIPTION\n--------------------------------------------------------------------------------\n172           0xAC            Zip archive data, at least v2.0 to extract, compressed size: 8969, uncompressed size: 19091, name: system/system/lib/libsns_gc1004.so\n9337          0x2479          End of Zip archive\n9499          0x251B          Zip archive data, at least v2.0 to extract, compressed size: 7813, uncompressed size: 16341, name: system/system/lib/libsns_ov9712_plus.so\n17518         0x446E          End of Zip archive\n17680         0x4510          Zip archive data, at least v2.0 to extract, compressed size: 90121, uncompressed size: 353248, name: system/system/lib/libOnvif.so\n107987        0x1A5D3         End of Zip archive\n108149        0x1A675         Zip archive data, at least v2.0 to extract, compressed size: 43603, uncompressed size: 84480, name: system/system/lib/libvoice_arm.so\n151946        0x2518A         End of Zip archive\n152108        0x2522C         Zip archive data, at least v2.0 to extract, compressed size: 130, uncompressed size: 227, name: system/init/ipcam.sh\n152406        0x25356         End of Zip archive\n152568        0x253F8         Zip archive data, at least v2.0 to extract, compressed size: 402383, uncompressed size: 886168, name: system/system/bin/encoder\n555129        0x87879         End of Zip archive\n555291        0x8791B         Zip archive data, at least v2.0 to extract, compressed size: 35394, uncompressed size: 74200, name: system/system/bin/wifidaemon\n590869        0x90415         End of Zip archive\n591031        0x904B7         Zip archive data, at least v2.0 to extract, compressed size: 1852, uncompressed size: 9692, name: system/system/bin/grade.sh\n593063        0x90CA7         End of Zip archive\n593225        0x90D49         Zip archive data, at least v2.0 to extract, compressed size: 8704, uncompressed size: 20212, name: system/system/bin/updata\n602105        0x92FF9         End of Zip archive\n602267        0x9309B         Zip archive data, at least v2.0 to extract, compressed size: 1874, uncompressed size: 4522, name: system/system/bin/gpio_aplink.ko\n604333        0x938AD         End of Zip archive\n604495        0x9394F         Zip archive data, at least v2.0 to extract, compressed size: 7241, uncompressed size: 16802, name: system/system/bin/motogpio.ko\n611922        0x95652         End of Zip archive\n612084        0x956F4         Zip archive data, at least v1.0 to extract, compressed size: 8, uncompressed size: 8, name: system/system/bin/fwversion.bin\n612282        0x957BA         End of Zip archive\n612444        0x9585C         Zip archive data, at least v1.0 to extract, compressed size: 9, uncompressed size: 9, name: system/system/bin/sysversion.txt\n612645        0x95925         End of Zip archive\n\n\nScan Time:     2016-01-19 00:36:12\nTarget File:   /home/ron/firmware/_CH-sys-48.53.64.67.bin.extracted/system/system/bin/sysversion.txt\nMD5 Checksum:  3e98d83fbced8eb62c79542f5df5a14f\nSignatures:    344\n\nDECIMAL       HEXADECIMAL     DESCRIPTION\n--------------------------------------------------------------------------------\n</code></pre>\n<p>Only one target file extracted...</p>\n<p>A quick look to headers :</p>\n<pre><code>ron@vpsXXXXXX:~/firmware$ head -n1 CH-sys-48.53.64.67.bin | hexdump -C\n00000000  77 77 77 2e 6f 62 6a 65  63 74 2d 63 61 6d 65 72  |www.object-camer|\n00000010  61 2e 63 6f 6d 2e 62 79  2e 68 6f 6e 67 7a 78 2e  |a.com.by.hongzx.|\n00000020  73 79 73 74 65 6d 2f 73  79 73 74 65 6d 2f 6c 69  |system/system/li|\n00000030  62 2f 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |b/..............|\n00000040  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n*\n00000060  6c 69 62 73 6e 73 5f 67  63 31 30 30 34 2e 73 6f  |libsns_gc1004.so|\n00000070  2e 7a 69 70 00 00 00 00  00 00 00 00 00 00 00 00  |.zip............|\n00000080  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n*\n000000a0  e3 23 00 00 43 40 35 30  00 00 00 00 50 4b 03 04  |.#<a class=\"__cf_email__\" data-cfemail=\"b59b9bf6f580859b9b9b9be5fe\" href=\"/cdn-cgi/l/email-protection\">[emailÂ protected]</a>..|\n000000b0  14 00 00 00 08 00 fa 8b  5d 47 89 42 30 43 09 23  |........]G.B0C.#|\n000000c0  00 00 93 4a 00 00 22 00  1c 00 73 79 73 74 65 6d  |...J..\"...system|\n000000d0  2f 73 79 73 74 65 6d 2f  6c 69 62 2f 6c 69 62 73  |/system/lib/libs|\n000000e0  6e 73 5f 67 63 31 30 30  34 2e 73 6f 55 54 09 00  |ns_gc1004.soUT..|\n000000f0  03 88 e7 31 56 88 e7 31  56 75 78 0b 00 01 04 ed  |...1V..1Vux.....|\n00000100  03 00 00 04 ed 03 00 00  e5 7c 0b 78 53 55 d6 f6  |.........|.xSU..|\n00000110  3e b9 b4 69 9a cb 69 cf  29 96 8b 92 0a           |&gt;..i..i.)....|\n0000011d\n</code></pre>\n<p>Any idea why I'm not able to extract everything ? </p>\n<p>Thank you !</p>\n<p>Ronan</p>\n</div>",
    "votes": "7",
    "answers": 1,
    "views": "4k",
    "tags": [
        "binary-analysis",
        "binary"
    ],
    "user": "Ronan",
    "time": "Jan 19, 2016 at 0:24",
    "comments": [],
    "answers_data": [
        {
            "content": "<div class=\"s-prose js-post-body\" itemprop=\"text\">\n<p>Although my binwalk version extracted the files correctly to the <code>system</code> folder along with the zip files containing only the <code>sysversion.txt</code>, I shortly describe why you see only the <code>sysversion.txt</code> in the archive files.\nIt is because the firmware file contain multiple PKZIP archives and the binwalk does not know the exact size of these files. So, it can identify the start of the PKZIP file correctly based on the PK magic, but without knowing the correct file size, it extracts the remaining bytes to the created ZIP file. Because the central directory structure in PKZIP format stored at the end of the ZIP file, after the compressed data and the extracted ZIP file ends with the <code>sysversion.txt.zip</code>, the file viewer or decompressor may found the central directory of the last ZIP file.</p>\n<p>To solve this problem, you may check the system folder in the same folder you found the ZIP files, or you can extract the files manually.<br/>\nIf you take a look at the start of the <code>CH-sys-48.53.64.67.bin</code> file, you will find that it has a simple structure. It starts with a magic string (marked with blue in the picture). The next element is a 0x40 bytes long directory name (marked with yellow) followed by a 0x40 bytes long file name entry (marked with green). After the file name you will find the size of the file (marked with purple), some flags and the binary content (start of the binary file marked with grey).</p>\n<p><a href=\"https://i.sstatic.net/u3KtS.png\" rel=\"noreferrer\"><img alt=\"enter image description here\" src=\"https://i.sstatic.net/u3KtS.png\"/></a></p>\n<p>Based on these information you can write a simple script, which extracts the files correctly, for example:</p>\n<pre><code>import sys\nimport struct\n\nif (len(sys.argv) &lt; 2):\n    print 'usage: parse binary'\n    sys.exit(1)\n\nb = open(sys.argv[1], 'rb').read()\no = 0x20\nwhile(o &lt; len(b)-0x20):\n    dir = b[o:o+0x40].strip('\\x00')\n    fname = b[o+0x40:o+0x80].strip('\\x00')\n    size = struct.unpack('L', b[o+0x80:o+0x84])[0]\n    unk1 = struct.unpack('L', b[o+0x84:o+0x88])[0]\n    unk2 = struct.unpack('L', b[o+0x88:o+0x8c])[0]\n    print '%x, %s, %s: %x, %x, %x'%(o, dir, fname, size, unk1, unk2)\n    open(fname, 'wb').write(b[o+0x8c:o+0x8c+size])\n    o += 0x8c+size\n</code></pre>\n</div>",
            "votes": "6",
            "user": "ebux",
            "time": "Jan 19, 2016 at 10:22",
            "is_accepted": true,
            "comments": [
                {
                    "user": "Ronan",
                    "text": "<span class=\"comment-copy\">Binwalk 2.0.0 did the job perfectly where the 2.1.1 fails.</span>",
                    "time": null
                },
                {
                    "user": "redcodefinal",
                    "text": "<span class=\"comment-copy\">Hi, just want to say that I use Binwalk 2.1.1 to extract similar firmware and it worked just fine, only oddity was that it added a bunch of hexadecimal named zip files that have nothing in them, and are actually just the header to each of the packed zip files. Thank you for reversing the header though, very helpful!</span>",
                    "time": null
                }
            ]
        }
    ]
}