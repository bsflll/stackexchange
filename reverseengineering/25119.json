{
    "title": "Find the caption of VB5/6 Form Object in Memory Dump",
    "link": "https://reverseengineering.stackexchange.com/questions/25119/find-the-caption-of-vb5-6-form-object-in-memory-dump",
    "content": "<div class=\"s-prose js-post-body\" itemprop=\"text\">\n<p>I'm looking at a problem with app that has lost source code and the app crashes shortly after calling code that appears to be <strong><em>[Global Variable representing Form Object]</em></strong>.<strong>ZOrder 0</strong> (i.e. trying to make the form visible)\nThere are multiple forms so I am trying to work out specifically which form is being accessed.\nTo work this out I made some sample code like this:</p>\n<pre><code>Public gFormToActivate As Form\n\nPrivate Sub cmddoDo_Click()\n    gsCurrentLine = \"START: Set gFormToActivate = FormDoDo\"\n    Set gFormToActivate = FormDoDo\n    gsCurrentLine = \"END: Set gFormToActivate = FormDoDo\"\n    gsCurrentLine = \"START: Me.Hide\"\n    Me.Hide\n    gsCurrentLine = \"END: Me.Hide\"\nEnd Sub\n</code></pre>\n<p>The ZOrder is later set using code like this:</p>\n<pre><code>Private Sub Command1_Click()\n    FormDoDo.Show\n    FormDada.Show\n    Form2.Show vbModal\n    gsCurrentLine = \"START: gFormToActivate.ZOrder 0\"\n    gFormToActivate.ZOrder 0\n    gsCurrentLine = \"END: gFormToActivate.ZOrder 0\"\nEnd Sub\n</code></pre>\n<p>Using IDA Pro I look at the disassembly:</p>\n<pre><code>    .text:00403674 C7 45 D4 18 2B 40 00                                            mov     dword ptr [ebp-2Ch], offset aStartSetGformt ; \"START: Set gFormToActivate = FormDoDo\"\n    .text:0040367B C7 45 CC 08 00 00 00                                            mov     dword ptr [ebp-34h], 8\n    .text:00403682 FF D7                                                           call    edi ; __vbaVarCopy\n    .text:00403684 A1 24 40 40 00                                                  mov     eax, dword_404024\n    .text:00403689 85 C0                                                           test    eax, eax\n    .text:0040368B 75 10                                                           jnz     short loc_40369D\n    .text:0040368D 68 24 40 40 00                                                  push    offset dword_404024\n    .text:00403692 68 60 15 40 00                                                  push    offset dword_401560\n    .text:00403697 FF 15 4C 71 40 00                                               call    ds:__vbaNew2\n    .text:0040369D\n    .text:0040369D                                                 loc_40369D:                             ; CODE XREF: .text:0040368Bâ†‘j\n    .text:0040369D 8B 0D 24 40 40 00                                               mov     ecx, dword_404024\n    .text:004036A3 68 E4 26 40 00                                                  push    offset dword_4026E4\n    .text:004036A8 51                                                              push    ecx\n    .text:004036A9 FF 15 70 71 40 00                                               call    ds:__vbaCastObj\n    .text:004036AF 50                                                              push    eax\n    .text:004036B0 68 60 40 40 00                                                  push    offset dword_404060\n    .text:004036B5 FF 15 08 71 40 00                                               call    ds:__vbaObjSet\n    .text:004036BB 8D 55 CC                                                        lea     edx, [ebp-34h]\n    .text:004036BE 8D 4D DC                                                        lea     ecx, [ebp-24h]\n    .text:004036C1 C7 45 D4 68 2B 40 00                                            mov     dword ptr [ebp-2Ch], offset aEndSetGformtoa ; \"END: Set gFormToActivate = FormDoDo\"\n</code></pre>\n<p>Based on this I suspected form variable might be stored at \"offset dword_404060\". Any suggestions on good next steps to work out in more detail how to get the properties of this object? In WinDbg looking a this address shows the following. I have been reviewing <a href=\"http://sandsprite.com/vb-reversing/files/Alex_Ionescu_vb_structures.pdf\" rel=\"nofollow noreferrer\">http://sandsprite.com/vb-reversing/files/Alex_Ionescu_vb_structures.pdf</a> to better understand VB structures but haven't worked out a solution yet</p>\n</div>",
    "votes": "2",
    "answers": 0,
    "views": "49",
    "tags": [
        "windbg",
        "vb6"
    ],
    "user": "chentiangemalc",
    "time": "May 26, 2020 at 3:50",
    "comments": [],
    "answers_data": []
}