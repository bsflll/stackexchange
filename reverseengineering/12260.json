{
    "title": "How to log all memory accesses (read and write) including the memory content in a binary execution trace?",
    "link": "https://reverseengineering.stackexchange.com/questions/12260/how-to-log-all-memory-accesses-read-and-write-including-the-memory-content-in",
    "content": "<div class=\"s-prose js-post-body\" itemprop=\"text\">\n<p>I would like to create an execution trace of a binary. To be precise, I would like to record every executed assembly instruction, together with possible memory accesses. By memory accesses I mean reading from, or writing to, memory. For these accesses I would like to record <em>where</em> the instruction reads from (resp. writes to) and <em>what</em> value it reads (resp. what value it writes).</p>\n<p>If possible, I would prefer a solution which works on Windows and Linux, as well as for different kinds of CPUs.</p>\n<p>The performance does not matter for the moment, i.e. a debugger script would be okay. </p>\n<p>I tried several things, but I did not manage to get what I wanted:</p>\n<ul>\n<li>IDA: I could not find a straight forward way of getting the memory accesses with content (there are obscure functions such as <code>idc.GetTevRegMem</code> (<a href=\"https://github.com/idapython/src/blob/master/python/idc.py#L8325\" rel=\"noreferrer\">see here</a>) but to reach my goal things get very very complex.</li>\n<li>Valgrind: <code>valgrind --tool=lackey --trace-mem=yes</code> gave me the accesses, but not the content, <a href=\"http://valgrind.org/docs/manual/lk-manual.html\" rel=\"noreferrer\">see here</a> for lackey</li>\n<li>GDB: Using watchpoints is not an option as their number is restricted</li>\n</ul>\n<p>For the moment, <a href=\"https://github.com/moyix/panda/blob/master/docs/manual.md\" rel=\"noreferrer\">PANDA</a> seems to be the most promising choice (<a href=\"https://reverseengineering.stackexchange.com/a/4779/11830\">see comment of PANDA author here</a>). Yet, I don't know PANDA and thus cannot tell how complex the creation of a suitable PANDA plugin will get.</p>\n<p>As my goal seems not very exotic to me, I figured there must exist something already or there must be an easy way. For example, some lines of debugger script code, a PIN tool (yet Intel only), or a qemu argument or the like. Does it?</p>\n</div>",
    "votes": "6",
    "answers": 1,
    "views": "5k",
    "tags": [
        "ida",
        "debugging",
        "qemu",
        "tracing"
    ],
    "user": "langlauf.io",
    "time": "Apr 13, 2017 at 12:49",
    "comments": [
        {
            "user": "Neitsa",
            "text": "<span class=\"comment-copy\">I'd definitely go with a DBI framework. PIN can do that easily (although you'll be restricted to x86 / x64). Check the <a href=\"https://software.intel.com/sites/landingpage/pintool/docs/71313/Pin/html/index.html#MAddressTrace\" rel=\"nofollow noreferrer\">pinatrace</a> example <a href=\"https://github.com/jingpu/pintools/blob/master/source/tools/SimpleExamples/pinatrace.cpp\" rel=\"nofollow noreferrer\">source</a>. Use <code>PIN_SafeCopy</code> (not used in the example) to access the memory, and you're done.</span>",
            "time": null
        },
        {
            "user": "Ta Thanh Dinh",
            "text": "<span class=\"comment-copy\">I think of DBI also, but PIN (and DynamoRIO) cannot trace kernel space accesses.</span>",
            "time": null
        },
        {
            "user": "0xec",
            "text": "<span class=\"comment-copy\">You can consult <b><a href=\"http://essay.utwente.nl/67522/1/Scrinzi_MA_SCS.pdf\" rel=\"nofollow noreferrer\">this (PDF)</a></b> thesis report, specifically chapter 3</span>",
            "time": null
        },
        {
            "user": "langlauf.io",
            "text": "<span class=\"comment-copy\">@ExtremeCoders thanks, they are also using PANDA. Really seems like the way to go if one wants everything: different CPUs, kernel+userspace, different OSes.</span>",
            "time": null
        },
        {
            "user": "Guntram Blohm",
            "text": "<span class=\"comment-copy\">As valgrind is open source, i'd guess it can't be <i>too</i> hard to add memory content to the --trace-mem=yes output.</span>",
            "time": null
        }
    ],
    "answers_data": [
        {
            "content": "<div class=\"s-prose js-post-body\" itemprop=\"text\">\n<p>I know that this question was asked some time ago, but here comes the solution working on Windows. </p>\n<p><strong>Note:</strong> <em>See the last section of this answer to get the solution for other systems and architectures.</em></p>\n<h1>x86 32 bit files</h1>\n<p><a href=\"http://www.ollydbg.de/version2.html\" rel=\"nofollow noreferrer\">OllyDbg2</a> is the tool that can be used for logging every single assembly instruction along with memory reads and writes. A short guide how to log it is presented below:</p>\n<ol>\n<li>Run OllyDbg.</li>\n<li>Select <code>Options</code>-&gt;<code>Options...</code> (or use <code>Alt</code>+<code>o</code> shortcut). The options window will show up.</li>\n<li>Search for <code>Run trace</code> section and select options specified on image below:\n<a href=\"https://i.sstatic.net/QiUcw.png\" rel=\"nofollow noreferrer\"><img alt=\"olly_options_run_trace\" src=\"https://i.sstatic.net/QiUcw.png\"/></a></li>\n</ol>\n<p>Of course, if you don't want Olly to log all string instructions or code in system DLLs, you may just select two relevant boxes. Additionally, you may choose smaller trace buffer size if you want to dump the log to a file.</p>\n<ol start=\"4\">\n<li>Now, open your target application, but don't start it yet.</li>\n<li>Select <code>View</code>-&gt;<code>Run trace</code>.</li>\n<li>Right click on a window that appeared and select memory and register options you want to have in the trace.<a href=\"https://i.sstatic.net/DmddN.png\" rel=\"nofollow noreferrer\"><img alt=\"Olly_run_trace_options\" src=\"https://i.sstatic.net/DmddN.png\"/></a></li>\n<li>Right click on that window once again and select <code>Log to file...</code> option and choose the file where you want to write entire run trace.</li>\n<li>Press <code>Ctrl</code>+<code>F11</code> to start tracing.</li>\n<li>When you want it to stop, click pause button (or <code>F12</code>) to pause execution.</li>\n<li>You will see the instructions logged in <code>Run trace</code> window.</li>\n<li>Right click on <code>Run trace</code> window and select <code>Stop logging</code> option. This will close and save the trace file.</li>\n</ol>\n<p>That's it! You may now open and analyse the file (it will be probably huge nonetheless).</p>\n<p>The small excerpt of such a file is presented below (it shows only modified registers and doesn't enter system DLLs):</p>\n<pre><code>main  &lt;ModuleEntryPoint&gt;          JMP SHORT 00401012\nmain  00401012                    MOV EAX,[DWORD DS:4F61EF]               [004F61EF]=0                EAX=00000000\nmain  00401017                    SHL EAX,2\nmain  0040101A                    MOV [DWORD DS:4F61F3],EAX               [004F61F3]=0\nmain  0040101F                    PUSH EDX                                [0019FF80]=0                ESP=0019FF80\nmain  00401020                    PUSH 0                                  [0019FF7C]=0                ESP=0019FF7C\nmain  00401022                    CALL &lt;JMP.&amp;KERNEL32.GetModuleHandleA&gt;                               EAX=00400000, ECX=DC5CD787, ESP=0019FF80\nmain  00401027                    MOV EDX,EAX                                                         EDX=00400000\nmain  00401029                    CALL 004E7210                                                       ESP=0019FF7C\nmain  004E7210                    MOV EAX,EDX\nmain  004E7212                    CMP [BYTE DS:4F61E0],0                  [004F61E0]=00\nmain  004E7219                    JNE SHORT 004E7240\nmain  004E721B                    CMP [BYTE DS:4F61E1],0                  [004F61E1]=00\nmain  004E7222                    JE SHORT 004E7238\nmain  004E7238                    MOV ECX,[DWORD DS:57D7D4]               [0057D7D4]=ollydbg.0061B108 ECX=0061B108\nmain  004E723E                    MOV [DWORD DS:ECX],EAX                  [0061B108]=0\nmain  004E7240                    MOV EAX,[DWORD DS:57D7D8]               [0057D7D8]=ollydbg.0061B131 EAX=0061B131\nmain  004E7245                    MOV [BYTE DS:EAX],1                     [0061B131]=00\n</code></pre>\n<h1>DOS executables</h1>\n<p><a href=\"https://www.codejuggle.dj/unpack-dos-binaries-dosbox-debugger/\" rel=\"nofollow noreferrer\">DOSBox Debugger</a> will log everything you want when you are analysing DOS executable.</p>\n<ol>\n<li>Download it from <a href=\"https://www.vogons.org/viewtopic.php?t=7323\" rel=\"nofollow noreferrer\">here</a> for example.</li>\n<li>Start application by dragging and dropping the executable on DOSBox Debugger icon.</li>\n<li>Press <code>Alt</code>+<code>Pause</code> at the moment you want to start logging the execution trace - application will freeze.</li>\n<li>Switch to debugger window. You will see something like this:\n<a href=\"https://i.sstatic.net/Gg0rz.png\" rel=\"nofollow noreferrer\"><img alt=\"DOSBoxDebugger\" src=\"https://i.sstatic.net/Gg0rz.png\"/></a></li>\n<li>Type <code>logl n</code>, where <code>n</code> is a (hexadecimal) number of instructions to log; for example: <code>logl ffff</code>.</li>\n<li>The log file has been created and should be located in the same directory as DOSBox debugger - it will have <code>LOGCPU.txt</code> name.</li>\n</ol>\n<p>Several lines of resulting file are given below:</p>\n<pre><code>01A2:00004654  mov  ax,si                                              8B C6                 EAX:0000002A EBX:0000002A ECX:00000A00 EDX:00000000 ESI:00000004 EDI:00000004 EBP:0000FFE2 ESP:0000FFDE DS:26EF ES:A000 FS:0000 GS:0000 SS:26EF CF:1 ZF:0 SF:1 OF:0 AF:1 PF:1 IF:1 TF:0 VM:0 FLG:00007293 CR0:00000000\n01A2:00004656  mov  dx,000E                                            BA 0E 00              EAX:00000004 EBX:0000002A ECX:00000A00 EDX:00000000 ESI:00000004 EDI:00000004 EBP:0000FFE2 ESP:0000FFDE DS:26EF ES:A000 FS:0000 GS:0000 SS:26EF CF:1 ZF:0 SF:1 OF:0 AF:1 PF:1 IF:1 TF:0 VM:0 FLG:00007293 CR0:00000000\n01A2:00004659  imul dx                                                 F7 EA                 EAX:00000004 EBX:0000002A ECX:00000A00 EDX:0000000E ESI:00000004 EDI:00000004 EBP:0000FFE2 ESP:0000FFDE DS:26EF ES:A000 FS:0000 GS:0000 SS:26EF CF:1 ZF:0 SF:1 OF:0 AF:1 PF:1 IF:1 TF:0 VM:0 FLG:00007293 CR0:00000000\n01A2:0000465B  mov  bx,ax                                              8B D8                 EAX:00000038 EBX:0000002A ECX:00000A00 EDX:00000000 ESI:00000004 EDI:00000004 EBP:0000FFE2 ESP:0000FFDE DS:26EF ES:A000 FS:0000 GS:0000 SS:26EF CF:0 ZF:0 SF:1 OF:0 AF:1 PF:1 IF:1 TF:0 VM:0 FLG:00007296 CR0:00000000\n01A2:0000465D  cmp  word [bx+56F6],0001        ds:[572E]=0000          83 BF F6 56 01        EAX:00000038 EBX:00000038 ECX:00000A00 EDX:00000000 ESI:00000004 EDI:00000004 EBP:0000FFE2 ESP:0000FFDE DS:26EF ES:A000 FS:0000 GS:0000 SS:26EF CF:0 ZF:0 SF:1 OF:0 AF:1 PF:1 IF:1 TF:0 VM:0 FLG:00007296 CR0:00000000\n01A2:00004662  jne  00004678 ($+14)            (down)                  75 14                 EAX:00000038 EBX:00000038 ECX:00000A00 EDX:00000000 ESI:00000004 EDI:00000004 EBP:0000FFE2 ESP:0000FFDE DS:26EF ES:A000 FS:0000 GS:0000 SS:26EF CF:1 ZF:0 SF:1 OF:0 AF:1 PF:1 IF:1 TF:0 VM:0 FLG:00007296 CR0:00000000\n01A2:00004678  inc  si                                                 46                    EAX:00000038 EBX:00000038 ECX:00000A00 EDX:00000000 ESI:00000004 EDI:00000004 EBP:0000FFE2 ESP:0000FFDE DS:26EF ES:A000 FS:0000 GS:0000 SS:26EF CF:1 ZF:0 SF:1 OF:0 AF:1 PF:1 IF:1 TF:0 VM:0 FLG:00007296 CR0:00000000\n</code></pre>\n<h1>Every or almost every architectures and systems</h1>\n<p><a href=\"https://github.com/radare/radare2\" rel=\"nofollow noreferrer\">radare2</a> is the tool that may be used for your purpose regardless the system and architecture (complete list of them is given <a href=\"https://github.com/radare/radare2/blob/master/README.md\" rel=\"nofollow noreferrer\">here</a>).</p>\n<ol>\n<li>Run <code>r2 -c aei -d programToDebug</code>.</li>\n<li>Put a breakpoint at the address where you want to start tracing (using <code>db address_in_hex</code> for example).</li>\n<li>Run <code>dc</code> to continue until the breakpoint is hit.</li>\n<li>Type <code>e dbg.trace=1</code> and press enter.</li>\n<li>Run <code>des N</code> to step <code>N</code> instructions (for example <code>des 10</code>).</li>\n<li>Use <code>dtd &gt; log1</code> to print instructions traced to <code>log1</code> file.</li>\n<li>Use <code>dte &gt; log2</code> to print all memory and register accesses to <code>log2</code> file.\nSample contents of these files are given below:</li>\n</ol>\n<p>Instructions:\n<a href=\"https://i.sstatic.net/kORBt.jpg\" rel=\"nofollow noreferrer\"><img alt=\"r2TraceInstructions\" src=\"https://i.sstatic.net/kORBt.jpg\"/></a>\nAnd some corresponding memory accesses:\n<a href=\"https://i.sstatic.net/z4PtD.jpg\" rel=\"nofollow noreferrer\"><img alt=\"r2TraceMemory\" src=\"https://i.sstatic.net/z4PtD.jpg\"/></a></p>\n<p>Of course, it will be nicer to have these outputs listed in such a way as OllyDbg does, for example, but it just requires to write a script that links these two files together and displays the information in more convenient way. Like so, for instance:\n<a href=\"https://i.sstatic.net/7k3Y9.jpg\" rel=\"nofollow noreferrer\"><img alt=\"r2PrettyLog\" src=\"https://i.sstatic.net/7k3Y9.jpg\"/></a></p>\n<p>Python script for creating such an output from these files is available <a href=\"https://gist.github.com/bart1e/e0586af82dea3c638d090997df353007\" rel=\"nofollow noreferrer\">here</a>. Usage:</p>\n<pre><code>./prettyTraceLog.py file1 file2\n</code></pre>\n<p>, where <code>log1</code> and <code>log2</code> are default values. If you find any bug, or want to modify it for some other reason, feel free to do it.</p>\n<p>Thanks @pancake for telling me how to do tracing in <code>radare2</code>.</p>\n</div>",
            "votes": "4",
            "user": "bart1e",
            "time": "Jun 13, 2019 at 13:47",
            "is_accepted": false,
            "comments": []
        }
    ]
}