{
    "title": "GetWindowLongPtr with undocumented nIndex of -1",
    "link": "https://reverseengineering.stackexchange.com/questions/21133/getwindowlongptr-with-undocumented-nindex-of-1",
    "content": "<div class=\"s-prose js-post-body\" itemprop=\"text\">\n<p>I'm trying to reverse functionality of scrollbars in <code>comctrl32.dll</code> and I keep witnessing them calling <a href=\"https://docs.microsoft.com/en-us/windows/desktop/api/winuser/nf-winuser-getwindowlongptrw\" rel=\"nofollow noreferrer\"><code>GetWindowLongPtr</code></a> function with undocumented index <code>-1</code> as such:</p>\n<p><a href=\"https://i.sstatic.net/nwKov.png\" rel=\"nofollow noreferrer\"><img alt=\"enter image description here\" src=\"https://i.sstatic.net/nwKov.png\"/></a></p>\n<p>Does anybody know what that function returns in that case?</p>\n</div>",
    "votes": "3",
    "answers": 1,
    "views": "266",
    "tags": [
        "windows",
        "c",
        "winapi"
    ],
    "user": "c00000fd",
    "time": "Apr 12, 2019 at 20:27",
    "comments": [],
    "answers_data": [
        {
            "content": "<div class=\"s-prose js-post-body\" itemprop=\"text\">\n<p>I think I got it. <code>GetWindowLongPtr(hWnd, -1)</code> returns a pointer to a nested <code>struct</code> that is a part of the <a href=\"https://www.geoffchappell.com/studies/windows/win32/user32/structs/wnd/index.htm\" rel=\"noreferrer\"><code>WND</code></a> struct (that contains main information about a window.) There's really no official name for it, but judging by this function name in <code>comctrl32</code>:</p>\n<p><a href=\"https://i.sstatic.net/jM77Q.png\" rel=\"noreferrer\"><img alt=\"enter image description here\" src=\"https://i.sstatic.net/jM77Q.png\"/></a></p>\n<p>I'd define it as such:</p>\n<pre><code>struct WF{\n    WF_STATE state;\n    WF_STATE2 state2;\n    DWORD ExStyles;     //With additional bits\n    DWORD Styles;\n    HMODULE hModule;\n    USHORT reserved;\n    USHORT fnid;        // ?\n};\n</code></pre>\n<p>So we can do:</p>\n<pre><code>WF* p_wf = (WF*)::GetWindowLongPtr(hWnd, -1);\n</code></pre>\n<p>Where <a href=\"https://www.geoffchappell.com/studies/windows/win32/user32/structs/wnd/state.htm\" rel=\"noreferrer\"><code>WF_STATE</code></a> is a <a href=\"https://doxygen.reactos.org/dd/d79/include_2ntuser_8h_source.html#l00572\" rel=\"noreferrer\">bitfield</a>:</p>\n<pre><code>enum WF_STATE{\n    WNDS_HASMENU                 = 0x00000001,\n    WNDS_HASVERTICALSCROOLLBAR   = 0x00000002,\n    WNDS_HASHORIZONTALSCROLLBAR  = 0x00000004,\n    WNDS_HASCAPTION              = 0x00000008,\n    WNDS_SENDSIZEMOVEMSGS        = 0x00000010,\n    WNDS_MSGBOX                  = 0x00000020,\n    WNDS_ACTIVEFRAME             = 0x00000040,\n    WNDS_HASSPB                  = 0x00000080,\n    WNDS_NONCPAINT               = 0x00000100,\n    WNDS_SENDERASEBACKGROUND     = 0x00000200,\n    WNDS_ERASEBACKGROUND         = 0x00000400,\n    WNDS_SENDNCPAINT             = 0x00000800,\n    WNDS_INTERNALPAINT           = 0x00001000,\n    WNDS_UPDATEDIRTY             = 0x00002000,\n    WNDS_HIDDENPOPUP             = 0x00004000,\n    WNDS_FORCEMENUDRAW           = 0x00008000,\n    WNDS_DIALOGWINDOW            = 0x00010000,\n    WNDS_HASCREATESTRUCTNAME     = 0x00020000,\n    WNDS_SERVERSIDEWINDOWPROC    = 0x00040000,      //WndProc is in win32k.sys\n    WNDS_ANSIWINDOWPROC          = 0x00080000,\n    WNDS_BEINGACTIVATED          = 0x00100000,\n    WNDS_HASPALETTE              = 0x00200000,\n    WNDS_PAINTNOTPROCESSED       = 0x00400000,\n    WNDS_SYNCPAINTPENDING        = 0x00800000,\n    WNDS_RECEIVEDQUERYSUSPENDMSG = 0x01000000,\n    WNDS_RECEIVEDSUSPENDMSG      = 0x02000000,\n    WNDS_TOGGLETOPMOST           = 0x04000000,\n    WNDS_REDRAWIFHUNG            = 0x08000000,\n    WNDS_REDRAWFRAMEIFHUNG       = 0x10000000,\n    WNDS_ANSICREATOR             = 0x20000000,\n    WNDS_MAXIMIZESTOMONITOR      = 0x40000000,\n    WNDS_DESTROYED               = 0x80000000,\n};\n</code></pre>\n<p>and <a href=\"https://www.geoffchappell.com/studies/windows/win32/user32/structs/wnd/state2.htm\" rel=\"noreferrer\"><code>WF_STATE2</code></a> is another <a href=\"https://doxygen.reactos.org/dd/d79/include_2ntuser_8h_source.html#l00608\" rel=\"noreferrer\">bitfield</a>:</p>\n<pre><code>enum WF_STATE2{\n    WNDS2_WMPAINTSENT               = 0x00000001,\n    WNDS2_ENDPAINTINVALIDATE        = 0x00000002,\n    WNDS2_STARTPAINT                = 0x00000004,\n    WNDS2_OLDUI                     = 0x00000008,\n    WNDS2_HASCLIENTEDGE             = 0x00000010,\n    WNDS2_BOTTOMMOST                = 0x00000020,\n    WNDS2_FULLSCREEN                = 0x00000040,\n    WNDS2_INDESTROY                 = 0x00000080,\n    WNDS2_WIN31COMPAT               = 0x00000100,\n    WNDS2_WIN40COMPAT               = 0x00000200,\n    WNDS2_WIN50COMPAT               = 0x00000400,\n    WNDS2_MAXIMIZEDMONITORREGION    = 0x00000800,\n    WNDS2_CLOSEBUTTONDOWN           = 0x00001000,\n    WNDS2_MAXIMIZEBUTTONDOWN        = 0x00002000,\n    WNDS2_MINIMIZEBUTTONDOWN        = 0x00004000,\n    WNDS2_HELPBUTTONDOWN            = 0x00008000,\n    WNDS2_SCROLLBARLINEUPBTNDOWN    = 0x00010000,\n    WNDS2_SCROLLBARPAGEUPBTNDOWN    = 0x00020000,\n    WNDS2_SCROLLBARPAGEDOWNBTNDOWN  = 0x00040000,\n    WNDS2_SCROLLBARLINEDOWNBTNDOWN  = 0x00080000,\n    WNDS2_ANYSCROLLBUTTONDOWN       = 0x00100000,\n    WNDS2_SCROLLBARVERTICALTRACKING = 0x00200000,\n    WNDS2_FORCENCPAINT              = 0x00400000,\n    WNDS2_FORCEFULLNCPAINTCLIPRGN   = 0x00800000,\n    WNDS2_FULLSCREENMODE            = 0x01000000,\n    WNDS2_CAPTIONTEXTTRUNCATED      = 0x08000000,\n    WNDS2_NOMINMAXANIMATERECTS      = 0x10000000,\n    WNDS2_SMALLICONFROMWMQUERYDRAG  = 0x20000000,\n    WNDS2_SHELLHOOKREGISTERED       = 0x40000000,\n    WNDS2_WMCREATEMSGPROCESSED      = 0x80000000,\n};\n</code></pre>\n<p>The <a href=\"https://www.geoffchappell.com/studies/windows/win32/user32/structs/wnd/style.htm\" rel=\"noreferrer\"><code>Styles</code></a> and <a href=\"https://www.geoffchappell.com/studies/windows/win32/user32/structs/wnd/exstyle.htm\" rel=\"noreferrer\"><code>ExStyles</code></a> members seem to closely resemble documented <a href=\"https://docs.microsoft.com/en-us/windows/desktop/winmsg/window-styles\" rel=\"noreferrer\">window styles</a> (and <a href=\"https://docs.microsoft.com/en-us/windows/desktop/winmsg/extended-window-styles\" rel=\"noreferrer\">extended styles</a>) but have their own undocumented bits as well.</p>\n<p><code>fnid</code> might be <a href=\"https://github.com/tinysec/public/blob/master/win32k/fnID.md\" rel=\"noreferrer\">this</a>, but I could not verify it.</p>\n</div>",
            "votes": "5",
            "user": "c00000fd",
            "time": "Apr 13, 2019 at 7:53",
            "is_accepted": false,
            "comments": []
        }
    ]
}