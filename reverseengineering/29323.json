{
    "title": "Not Understanding the FU540 Boot Process",
    "link": "https://reverseengineering.stackexchange.com/questions/29323/not-understanding-the-fu540-boot-process",
    "content": "<div class=\"s-prose js-post-body\" itemprop=\"text\">\n<p>I'm reading the <a href=\"https://starfivetech.com/uploads/fu540-c000-manual-v1p4.pdf\" rel=\"nofollow noreferrer\">manual</a> for the SiFive FU540-C000 trying to understand the boot process, and I'm not making sense of the initial steps after power on.</p>\n<p>I'm using <code>MSEL = 1111</code> based on the recommendation for the <a href=\"https://docs.sel4.systems/Hardware/hifive.html\" rel=\"nofollow noreferrer\">software I'm booting</a> from SD card.</p>\n<blockquote>\n<p>On power-on, all cores jump to 0x1004 while running directly off of the external clock input,\nexpected to be 33.3 MHz. The memory at this location contains:</p>\n<p>Table 8: Reset vector ROM</p>\n<div class=\"s-table-container\">\n<table class=\"s-table\">\n<thead>\n<tr>\n<th style=\"text-align: center;\">Address</th>\n<th style=\"text-align: center;\">Contents</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align: center;\">0x1000</td>\n<td style=\"text-align: center;\">The MSEL pin state</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">0x1004</td>\n<td style=\"text-align: center;\">auipc t0, 0</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">0x1008</td>\n<td style=\"text-align: center;\">lw t1, -4(t0)</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">0x100C</td>\n<td style=\"text-align: center;\">slli t1, t1, 0x3</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">0x1010</td>\n<td style=\"text-align: center;\">add t0, t0, t1</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">0x1014</td>\n<td style=\"text-align: center;\">lw t0, 252(t0)</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">0x1018</td>\n<td style=\"text-align: center;\">jr t0</td>\n</tr>\n</tbody>\n</table>\n</div></blockquote>\n<p>This is how I've decoded the instructions.</p>\n<ol>\n<li><code>0x1004 = auipc t0, 0</code>\n<ul>\n<li>AUIPC uses the top 20 bits of the immediate, extends 0 to the low 12, then adds the PC value of the auipc instruction. Store in t0</li>\n<li>t0 = 0x0 &lt;&lt; 12 = 0x0 + 0x1004</li>\n</ul>\n</li>\n</ol>\n<div class=\"s-table-container\">\n<table class=\"s-table\">\n<thead>\n<tr>\n<th style=\"text-align: center;\">Register</th>\n<th style=\"text-align: center;\">Value</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align: center;\">t0</td>\n<td style=\"text-align: center;\">0x1004</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">t1</td>\n<td style=\"text-align: center;\">UNDEF</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">PC (next)</td>\n<td style=\"text-align: center;\">0x1008</td>\n</tr>\n</tbody>\n</table>\n</div>\n<ol start=\"2\">\n<li><code>0x1008 = lw t1, -4(t0)</code>\n<ul>\n<li>Load value in memory address <code>(t0 - 4)</code>, store in t1</li>\n<li>t1 = Mem[0x1004 - 4] = Mem[0x1000] = MSEL = 0b1111 = 0xF</li>\n</ul>\n</li>\n</ol>\n<div class=\"s-table-container\">\n<table class=\"s-table\">\n<thead>\n<tr>\n<th style=\"text-align: center;\">Register</th>\n<th style=\"text-align: center;\">Value</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align: center;\">t0</td>\n<td style=\"text-align: center;\">0x1004</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">t1</td>\n<td style=\"text-align: center;\">0x000F</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">PC (next)</td>\n<td style=\"text-align: center;\">0x100C</td>\n</tr>\n</tbody>\n</table>\n</div>\n<ol start=\"3\">\n<li><code>0x100C = slli t1, t1, 0x3</code>\n<ul>\n<li>t1 is left shifted 3, store in t1</li>\n<li>t1 = 0b1111 &lt;&lt; 3 = 0b1111000 = 0x78</li>\n</ul>\n</li>\n</ol>\n<div class=\"s-table-container\">\n<table class=\"s-table\">\n<thead>\n<tr>\n<th style=\"text-align: center;\">Register</th>\n<th style=\"text-align: center;\">Value</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align: center;\">t0</td>\n<td style=\"text-align: center;\">0x1004</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">t1</td>\n<td style=\"text-align: center;\">0x0078</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">PC (next)</td>\n<td style=\"text-align: center;\">0x1010</td>\n</tr>\n</tbody>\n</table>\n</div>\n<ol start=\"4\">\n<li><code>0x1010 = add t0, t0, t1</code>\n<ul>\n<li>t1 is added to t0, store in t0</li>\n<li>t0 = 0x1004 + 0x0078 = 0x107C</li>\n</ul>\n</li>\n</ol>\n<div class=\"s-table-container\">\n<table class=\"s-table\">\n<thead>\n<tr>\n<th style=\"text-align: center;\">Register</th>\n<th style=\"text-align: center;\">Value</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align: center;\">t0</td>\n<td style=\"text-align: center;\">0x107C</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">t1</td>\n<td style=\"text-align: center;\">0x0078</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">PC (next)</td>\n<td style=\"text-align: center;\">0x1014</td>\n</tr>\n</tbody>\n</table>\n</div>\n<ol start=\"5\">\n<li><code>0x1014 = lw t0, 252(t0)</code>\n<ul>\n<li>Load value in memory address <code>t0 +  252</code>, store in t0</li>\n<li>t0 = Mem[0x107C + 0xFC] = Mem[0x1178] = 0x????</li>\n</ul>\n</li>\n</ol>\n<div class=\"s-table-container\">\n<table class=\"s-table\">\n<thead>\n<tr>\n<th style=\"text-align: center;\">Register</th>\n<th style=\"text-align: center;\">Value</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align: center;\">t0</td>\n<td style=\"text-align: center;\">0x????</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">t1</td>\n<td style=\"text-align: center;\">0x0078</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">PC (next)</td>\n<td style=\"text-align: center;\">0x1018</td>\n</tr>\n</tbody>\n</table>\n</div>\n<ol start=\"6\">\n<li><code>0x1018 = jr t0</code>\n<ul>\n<li>jump directly to address in t0</li>\n<li>PC = 0x????</li>\n</ul>\n</li>\n</ol>\n<div class=\"s-table-container\">\n<table class=\"s-table\">\n<thead>\n<tr>\n<th style=\"text-align: center;\">Register</th>\n<th style=\"text-align: center;\">Value</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align: center;\">t0</td>\n<td style=\"text-align: center;\">0x????</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">t1</td>\n<td style=\"text-align: center;\">0x0788</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">PC (next)</td>\n<td style=\"text-align: center;\">0x????</td>\n</tr>\n</tbody>\n</table>\n</div>\n<p>The problem is that, according to the manual, MSEL = 0b1111 should jump to 0x0001_0000, doesn't mention anything about what's at 0x1178</p>\n<div class=\"s-table-container\">\n<table class=\"s-table\">\n<thead>\n<tr>\n<th style=\"text-align: center;\">Base</th>\n<th style=\"text-align: center;\">Top</th>\n<th style=\"text-align: center;\">Attr.</th>\n<th style=\"text-align: left;\">Description Notes</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align: center;\">0x0000_0000</td>\n<td style=\"text-align: center;\">0x0000_00FF</td>\n<td style=\"text-align: center;\"></td>\n<td style=\"text-align: left;\">Reserved</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">0x0000_0100</td>\n<td style=\"text-align: center;\">0x0000_0FFF</td>\n<td style=\"text-align: center;\">RWX A</td>\n<td style=\"text-align: left;\">Debug</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">0x0000_1000</td>\n<td style=\"text-align: center;\">0x0000_1FFF</td>\n<td style=\"text-align: center;\">R X</td>\n<td style=\"text-align: left;\">Mode Select</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">0x0000_2000</td>\n<td style=\"text-align: center;\">0x0000_FFFF</td>\n<td style=\"text-align: center;\"></td>\n<td style=\"text-align: left;\">Reserved</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">0x0001_0000</td>\n<td style=\"text-align: center;\">0x0001_7FFF</td>\n<td style=\"text-align: center;\">R X</td>\n<td style=\"text-align: left;\">Mask ROM (32 KiB)</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">0x0001_8000</td>\n<td style=\"text-align: center;\">0x00FF_FFFF</td>\n<td style=\"text-align: center;\"></td>\n<td style=\"text-align: left;\">Reserved</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">0x0100_0000</td>\n<td style=\"text-align: center;\">0x0100_1FFF</td>\n<td style=\"text-align: center;\">RWX A</td>\n<td style=\"text-align: left;\">S51 DTIM (8 KiB)</td>\n</tr>\n</tbody>\n</table>\n</div>\n<p>Did I interpret something wrong, or is there something else going on in this boot sequence that I'm not getting?</p>\n<p>--EDIT 1--</p>\n<p>In my original math I shifted the hex values left instead of binary. Going to attribute that to brain tired. It still isn't any more clear what's happening after the jump instruction.</p>\n<p>--EDIT 2--</p>\n<p>It was <a href=\"https://forums.sifive.com/t/whats-the-fu540-boot-sequence/5206\" rel=\"nofollow noreferrer\">pointed out</a> that I was using LW incorrectly, loading the value in the register instead of the value in memory indicated by the address in register. Updated the math and still no more clear.</p>\n<p>--EDIT 3--</p>\n<p>Thanks to mumbel for pointing out my incorrect use of the MSEL value. I treated as 0x1111 instead 0f 0b1111 = 0xF. I swear I know hex and binary.</p>\n</div>",
    "votes": "0",
    "answers": 2,
    "views": "107",
    "tags": [
        "assembly",
        "firmware",
        "memory",
        "static-analysis",
        "risc-v"
    ],
    "user": "Jonathon Anderson",
    "time": "Sep 24, 2021 at 22:22",
    "comments": [
        {
            "user": "mumbel",
            "text": "<span class=\"comment-copy\">I would use the tag risc-v not risc for this question</span>",
            "time": null
        },
        {
            "user": "Jonathon Anderson",
            "text": "<span class=\"comment-copy\">@mumbel oddly, I don't see a risc-v tag</span>",
            "time": null
        }
    ],
    "answers_data": [
        {
            "content": "<div class=\"s-prose js-post-body\" itemprop=\"text\">\n<p>MSEL is 4 pins, as in 4 bits.  This means <code>1111</code> is not 0x1111, but 0b1111 or 0xf.  So your math is correct everywhere but the 0x8888 would be 0x78 instead.</p>\n<pre><code>auipc t0, 0       &lt;- t0 = pc + 0 =&gt; 0x1004\nlw t1, -4(t0)     &lt;- t1 = -4(0x1004) =&gt; 0xf\nslli t1, t1, 0x3  &lt;- t1 = 0xf &lt;&lt; 3 == 0xf * 8 =&gt; 0x78\nadd t0, t0, t1    &lt;- t0 = 0x1004 + 0x78 =&gt; 0x107c\nlw t0, 252(t0)    &lt;- t0 = 252(0x107c) == 0(0x1178) =&gt; ???\njr t0             &lt;- goto ???\n</code></pre>\n</div>",
            "votes": "0",
            "user": "mumbel",
            "time": "Sep 24, 2021 at 3:25",
            "is_accepted": false,
            "comments": [
                {
                    "user": "Jonathon Anderson",
                    "text": "<span class=\"comment-copy\">Well that leaves me equally as confused 😂</span>",
                    "time": null
                },
                {
                    "user": "mumbel",
                    "text": "<span class=\"comment-copy\">Heh, at least 0x1178 is mapped.  Which part is confusing or just no clue what's in memory at 0x1178?</span>",
                    "time": null
                },
                {
                    "user": "Jonathon Anderson",
                    "text": "<span class=\"comment-copy\">@mumble no clue what's at that address, and the pin select guide suggests 0b1111 should jump to 0x0001_0000 for ZSBL</span>",
                    "time": null
                }
            ]
        },
        {
            "content": "<div class=\"s-prose js-post-body\" itemprop=\"text\">\n<p>I can't find the full memory map, but I've been told that this table can be interpreted similarly. Basically, whatever address is calculated using MSEL will have the value in the \"Reset address\" field. So, it's not an address to value mapping, but since it's the only variable in the algorithm, it alone determines what address will be jumped to in the final instruction, so the mapping is still valid.</p>\n<p>Another way to look at it is that MSEL is an index into a jump table, and the base is calculated in the rest of the algorithm.</p>\n<blockquote>\n<p>Table 9: Target of the reset vector</p>\n<div class=\"s-table-container\">\n<table class=\"s-table\">\n<thead>\n<tr>\n<th style=\"text-align: center;\">MSEL</th>\n<th style=\"text-align: center;\">Reset address</th>\n<th style=\"text-align: center;\">Purpose</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align: center;\">0000</td>\n<td style=\"text-align: center;\">0x0000_1004</td>\n<td style=\"text-align: center;\">loops forever waiting for debugger</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">0001</td>\n<td style=\"text-align: center;\">0x2000_0000</td>\n<td style=\"text-align: center;\">memory-mapped QSPI0</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">0010</td>\n<td style=\"text-align: center;\">0x3000_0000</td>\n<td style=\"text-align: center;\">memory-mapped QSPI1</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">0011</td>\n<td style=\"text-align: center;\">0x4000_0000</td>\n<td style=\"text-align: center;\">uncached ChipLink</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">0100</td>\n<td style=\"text-align: center;\">0x6000_0000</td>\n<td style=\"text-align: center;\">cached ChipLink</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">0101</td>\n<td style=\"text-align: center;\">0x0001_0000</td>\n<td style=\"text-align: center;\">ZSBL</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">0110</td>\n<td style=\"text-align: center;\">0x0001_0000</td>\n<td style=\"text-align: center;\">ZSBL</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">0111</td>\n<td style=\"text-align: center;\">0x0001_0000</td>\n<td style=\"text-align: center;\">ZSBL</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">1000</td>\n<td style=\"text-align: center;\">0x0001_0000</td>\n<td style=\"text-align: center;\">ZSBL</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">1001</td>\n<td style=\"text-align: center;\">0x0001_0000</td>\n<td style=\"text-align: center;\">ZSBL</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">1010</td>\n<td style=\"text-align: center;\">0x0001_0000</td>\n<td style=\"text-align: center;\">ZSBL</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">1011</td>\n<td style=\"text-align: center;\">0x0001_0000</td>\n<td style=\"text-align: center;\">ZSBL</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">1100</td>\n<td style=\"text-align: center;\">0x0001_0000</td>\n<td style=\"text-align: center;\">ZSBL</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">1101</td>\n<td style=\"text-align: center;\">0x0001_0000</td>\n<td style=\"text-align: center;\">ZSBL</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">1110</td>\n<td style=\"text-align: center;\">0x0001_0000</td>\n<td style=\"text-align: center;\">ZSBL</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">1111</td>\n<td style=\"text-align: center;\">0x0001_0000</td>\n<td style=\"text-align: center;\">ZSBL</td>\n</tr>\n</tbody>\n</table>\n</div></blockquote>\n</div>",
            "votes": "0",
            "user": "Jonathon Anderson",
            "time": "Sep 25, 2021 at 17:56",
            "is_accepted": true,
            "comments": []
        }
    ]
}