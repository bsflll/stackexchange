{
    "title": "What does the instructions sequence call/cdqe/ret do?",
    "link": "https://reverseengineering.stackexchange.com/questions/29449/what-does-the-instructions-sequence-call-cdqe-ret-do",
    "content": "<div class=\"s-prose js-post-body\" itemprop=\"text\">\n<p>I'm trying to reverse a Linux module. In the <code>ioctl</code> routine, I have the following sequence of instructions (generated by <code>objdump -M intel -d test.ko</code>):</p>\n<pre><code> 3f9:   74 3b                   je     436 &lt;device_ioctl+0x46&gt;\n...\n 436:   e8 00 00 00 00          call   43b &lt;device_ioctl+0x4b&gt;\n 43b:   48 98                   cdqe   \n 43d:   c3                      ret\n</code></pre>\n<p>I'm not sure to understand what happens here after the jump is done.</p>\n<p>First, we have a <a href=\"https://www.felixcloutier.com/x86/call\" rel=\"nofollow noreferrer\"><code>call</code></a> instruction. The opcode is <code>E8 00</code> so it is a near call to the next instruction. The EIP register (which contain the address of the next instruction) is also pushed on the stack.</p>\n<p>Then, we continue with the <a href=\"https://www.felixcloutier.com/x86/cbw:cwde:cdqe\" rel=\"nofollow noreferrer\"><code>cdqe</code></a> instruction. It extends the sign of the EAX register into RAX. In other words, it does nothing. Just to mention, EAX/RAX register has not been modified from the beginning of the routine.</p>\n<p>Finally, the <a href=\"https://www.felixcloutier.com/x86/ret\" rel=\"nofollow noreferrer\"><code>ret</code></a> instruction is executed. It pops the stack into EIP which corresponds to the previous instruction and we continue the execution of the routine from that point.</p>\n<p>Therefore, <code>cdqe</code> is executed again (to do nothing) and the <code>ret</code> instruction is called again. This time, we leave the <code>ioctl</code> routine and return to the callee.</p>\n<p>Am I right saying this does nothing? If so, what is the point of that code?</p>\n<hr/>\n<p>Here is the full routine:</p>\n<pre><code>00000000000003f0 &lt;device_ioctl&gt;:\n 3f0:   48 89 d7                mov    rdi,rdx\n 3f3:   81 fe 03 b0 fe ca       cmp    esi,0xcafeb003\n 3f9:   74 3b                   je     436 &lt;device_ioctl+0x46&gt;\n 3fb:   77 18                   ja     415 &lt;device_ioctl+0x25&gt;\n 3fd:   81 fe 01 b0 fe ca       cmp    esi,0xcafeb001\n 403:   74 39                   je     43e &lt;device_ioctl+0x4e&gt;\n 405:   81 fe 02 b0 fe ca       cmp    esi,0xcafeb002\n 40b:   75 39                   jne    446 &lt;device_ioctl+0x56&gt;\n 40d:   e8 00 00 00 00          call   412 &lt;device_ioctl+0x22&gt;\n 412:   48 98                   cdqe   \n 414:   c3                      ret    \n 415:   48 c7 c0 00 00 00 00    mov    rax,0x0\n 41c:   48 c7 c2 ff ff ff ff    mov    rdx,0xffffffffffffffff\n 423:   48 2d 00 00 00 00       sub    rax,0x0\n 429:   81 fe 04 b0 fe ca       cmp    esi,0xcafeb004\n 42f:   89 c0                   mov    eax,eax\n 431:   48 0f 45 c2             cmovne rax,rdx\n 435:   c3                      ret    \n 436:   e8 00 00 00 00          call   43b &lt;device_ioctl+0x4b&gt;\n 43b:   48 98                   cdqe   \n 43d:   c3                      ret    \n 43e:   e8 00 00 00 00          call   443 &lt;device_ioctl+0x53&gt;\n 443:   48 98                   cdqe   \n 445:   c3                      ret    \n 446:   48 83 c8 ff             or     rax,0xffffffffffffffff\n 44a:   c3                      ret    \n</code></pre>\n<p>This is from the nightclub challenge of the <a href=\"https://ctf.perfect.blue/\" rel=\"nofollow noreferrer\">pbctf 2021</a>.</p>\n<hr/>\n</div>",
    "votes": "1",
    "answers": 1,
    "views": "357",
    "tags": [
        "kernel",
        "assembly"
    ],
    "user": "Pierre",
    "time": "Oct 23, 2021 at 8:52",
    "comments": [],
    "answers_data": [
        {
            "content": "<div class=\"s-prose js-post-body\" itemprop=\"text\">\n<p>cdqe does this RAX ‚Üê sign-extend of EAX.<br/>\napplicable only in x64<br/>\nshown below is a demo of x86 cdq which instead of using rax uses eax,edx combo\nedx gets the sign extension  in x86</p>\n<p>for cdqe register rax will become <code>0xffffffff&lt;eax&gt; or 0x00000000&lt;eax&gt;</code></p>\n<p><a href=\"https://i.sstatic.net/B0b8e.gif\" rel=\"nofollow noreferrer\"><img alt=\"enter image description here\" src=\"https://i.sstatic.net/B0b8e.gif\"/></a></p>\n<p>maybe ctf is checking the sign</p>\n</div>",
            "votes": "1",
            "user": "blabb",
            "time": "Oct 23, 2021 at 10:49",
            "is_accepted": false,
            "comments": []
        }
    ]
}