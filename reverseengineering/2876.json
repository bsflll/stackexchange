{
    "title": "Why is there in a nop in the while loop",
    "link": "https://reverseengineering.stackexchange.com/questions/2876/why-is-there-in-a-nop-in-the-while-loop",
    "content": "<div class=\"s-prose js-post-body\" itemprop=\"text\">\n<p>So I have the following C code I wrote:</p>\n<pre><code>#include &lt;stdio.h&gt;\n\n\nint main() {\n    int i = 1;\n\n    while(i) {\n        printf(\"in loop\\n\");\n        i++;\n\n        if(i == 10) {\n            break;\n        }\n    }\n\n    return 0;\n}\n</code></pre>\n<p>Compiled with gcc (Ubuntu/Linaro 4.7.2-2ubuntu1) 4.7.2 it disassembles to this:</p>\n<pre><code>   0x000000000040051c &lt;+0&gt;: push   %rbp\n   0x000000000040051d &lt;+1&gt;: mov    %rsp,%rbp\n   0x0000000000400520 &lt;+4&gt;: sub    $0x10,%rsp\n   0x0000000000400524 &lt;+8&gt;: movl   $0x1,-0x4(%rbp)\n   0x000000000040052b &lt;+15&gt;:    jmp    0x400541 &lt;main+37&gt;\n   0x000000000040052d &lt;+17&gt;:    mov    $0x400604,%edi\n   0x0000000000400532 &lt;+22&gt;:    callq  0x4003f0 &lt;puts@plt&gt;\n   0x0000000000400537 &lt;+27&gt;:    addl   $0x1,-0x4(%rbp)\n   0x000000000040053b &lt;+31&gt;:    cmpl   $0xa,-0x4(%rbp)\n   0x000000000040053f &lt;+35&gt;:    je     0x400549 &lt;main+45&gt;\n   0x0000000000400541 &lt;+37&gt;:    cmpl   $0x0,-0x4(%rbp)\n   0x0000000000400545 &lt;+41&gt;:    jne    0x40052d &lt;main+17&gt;\n   0x0000000000400547 &lt;+43&gt;:    jmp    0x40054a &lt;main+46&gt;\n   0x0000000000400549 &lt;+45&gt;:    nop\n   0x000000000040054a &lt;+46&gt;:    mov    $0x0,%eax\n   0x000000000040054f &lt;+51&gt;:    leaveq \n   0x0000000000400550 &lt;+52&gt;:    retq  \n</code></pre>\n<p>Why is there a <code>nop</code> on +45? And why does not <code>je</code> on +35 just jump right to +46?</p>\n</div>",
    "votes": "12",
    "answers": 3,
    "views": "2k",
    "tags": [
        "disassembly"
    ],
    "user": "Sindre Smistad",
    "time": "Oct 3, 2013 at 22:28",
    "comments": [],
    "answers_data": [
        {
            "content": "<div class=\"s-prose js-post-body\" itemprop=\"text\">\n<p>It might be for function alignment. As it is now it returns on <code>0x400550</code>, which can be divided by 8. If it returned on <code>0x40054f</code> it isn't aligned. Just a speculation, though.</p>\n</div>",
            "votes": "15",
            "user": "perror",
            "time": "Oct 13, 2013 at 8:54",
            "is_accepted": true,
            "comments": [
                {
                    "user": "Sindre Smistad",
                    "text": "<span class=\"comment-copy\">I Googled function alignment and found <a href=\"http://stackoverflow.com/questions/7912464/why-does-gcc-pad-functions-with-nops\">this</a> post on SO, and it seems to answer my question in some more detail. Thank you for your help.</span>",
                    "time": null
                },
                {
                    "user": "Jongware",
                    "text": "<span class=\"comment-copy\">Sorry, I'm not convinced this is <i>function</i> alignment. This only applies to function starts, not ends. It's not <code>-falign-labels</code> either (there is a <code>nop</code> inserted as per <a href=\"http://gcc.gnu.org/onlinedocs/gcc/Optimize-Options.html#Optimize-Options\" rel=\"nofollow noreferrer\">description of <code>falign-labels</code></a> but the adjusted address is not used). I rather think this is caused by the compiler reserving some bytes for longer representation of opcodes and not cleaned up.</span>",
                    "time": null
                },
                {
                    "user": "microtherion",
                    "text": "<span class=\"comment-copy\">Yes, this just appears to be unoptimized code. Try comparing the code generated by <code>-O3</code> or <code>-Os</code> to the code generated by <code>-O0</code>.</span>",
                    "time": null
                }
            ]
        },
        {
            "content": "<div class=\"s-prose js-post-body\" itemprop=\"text\">\n<blockquote>\n<p>Most microprocessors fetch code in aligned 16-byte or 32-byte blocks.\n  If an important subroutine entry or jump label happens to be near the\n  end of a 16-byte block then the microprocessor will only get a few\n  useful bytes of code when fetching that block of code. It may have to\n  fetch the next 16 bytes too before it can decode the first\n  instructions after the label. This can be avoided by aligning\n  important subroutine entries and loop entries by 16. Aligning by 8\n  will assure that at least 8 bytes of code can be loaded with the first\n  instruction fetch, which may be sufficient if the instructions are\n  small.</p>\n</blockquote>\n<p>via Optimizing subroutines in assembly language by Agner Fog. <a href=\"http://www.agner.org/optimize/optimizing_assembly.pdf\" rel=\"nofollow\">PDF</a></p>\n</div>",
            "votes": "3",
            "user": "alexanderh",
            "time": "Oct 18, 2013 at 22:33",
            "is_accepted": false,
            "comments": [
                {
                    "user": "Jongware",
                    "text": "<span class=\"comment-copy\">Can you point out this better alignment in the OP's disassembly? I don't get why the <code>nop</code>s place would be an improvement.</span>",
                    "time": null
                }
            ]
        },
        {
            "content": "<div class=\"s-prose js-post-body\" itemprop=\"text\">\n<p>Another reason for NOP insertion is due to pipeline scheduling. If it takes a cycle for branch prediction to determine whether it was correct or not (and if not to flush the pipe), then you'd need a cycle delay before results are committed to registers.</p>\n<p>Regarding the specific example where the jump equal goes to a NOP, it appears to me that the processor needs a cycle to determine whether it got the right answer or not and adjust the pipe as necessary. </p>\n<p>Great job digging in to the code and understanding what is going on. :)</p>\n</div>",
            "votes": "0",
            "user": "bitsdanceforme",
            "time": "Mar 19, 2014 at 16:14",
            "is_accepted": false,
            "comments": []
        }
    ]
}