{
    "title": "Impossible to execute a program with radare2 : TO DO continue",
    "link": "https://reverseengineering.stackexchange.com/questions/20187/impossible-to-execute-a-program-with-radare2-to-do-continue",
    "content": "<html><body><div class=\"s-prose js-post-body\" itemprop=\"text\">\n <p>\n  I am trying to crack a crackme. I already catch the flag because I seen the string variable which represants flag. I would like to catch the flag on an other way, I want to set a breakpoint when there is a comparison of the string. I want to use radare2.\n </p>\n <p>\n  When I use the\n  <em>\n   dc\n  </em>\n  command to run the program which should stop to breakpoint I set up, I have the message\n  <em>\n   TO DO continue\n  </em>\n  . I don't know why. I expected a message in the form :\n </p>\n <pre><code>string 1 : TheStringIEnter string 2 : TheFlagOfTheChallenge\n</code></pre>\n <p>\n  This is the commands I execute :\n </p>\n <pre><code>radare 2 -d ch1.bin\ns sym.main\naaa\npdf\nVV\n:\n:> db 0x08048705\n:> dc\nTODO continue\n:> \n</code></pre>\n <p>\n  This is the output of pdf command :\n </p>\n <pre><code>[0x0804869d]> pdf\n/ (fcn) main 155\n|   main (int argc, char **argv, char **envp);\n|           ; var int local_ch @ ebp-0xc\n|           ; var int local_8h @ ebp-0x8\n|           ; var int local_4h @ esp+0x4\n|           ; DATA XREF from entry0 (0x8048507)\n|           0x0804869d      8d4c2404       lea ecx, [local_4h]         ; 4\n|           0x080486a1      83e4f0         and esp, 0xfffffff0\n|           0x080486a4      ff71fc         push dword [ecx - 4]\n|           0x080486a7      55             push ebp\n|           0x080486a8      89e5           mov ebp, esp\n|           0x080486aa      51             push ecx\n|           0x080486ab      83ec24         sub esp, 0x24               ; '$'\n|           0x080486ae      c745f8418804.  mov dword [local_8h], str.123456789 ; 0x8048841 ; \"123456789\"\n|           0x080486b5      c704244c8804.  mov dword [esp], str.       ; [0x804884c:4]=0x23232323 ; \"############################################################\"\n|           0x080486bc      e807feffff     call sym.imp.puts           ; int puts(const char *s)\n|           0x080486c1      c704248c8804.  mov dword [esp], str.welcome_to_challenge ; [0x804888c:4]=0x20202323 ; \"##        Welcome to this challenge        ##\"\n|           0x080486c8      e8fbfdffff     call sym.imp.puts           ; int puts(const char *s)\n|           0x080486cd      c70424cc8804.  mov dword [esp], str.       ; [0x80488cc:4]=0x23232323 ; \"############################################################\n\"\n|           0x080486d4      e8effdffff     call sym.imp.puts           ; int puts(const char *s)\n|           0x080486d9      c704240c8904.  mov dword [esp], str.please_enter_pass: ; [0x804890c:4]=0x69756556 ; \"Please enter the password : \"\n|           0x080486e0      e8b3fdffff     call sym.imp.printf         ; int printf(const char *format)\n|           0x080486e5      8b45f4         mov eax, dword [local_ch]\n|           0x080486e8      890424         mov dword [esp], eax\n|           0x080486eb      e80effffff     call sym.getString\n|           0x080486f0      8945f4         mov dword [local_ch], eax\n|           0x080486f3      8b45f8         mov eax, dword [local_8h]\n|           0x080486f6      89442404       mov dword [local_4h], eax\n|           0x080486fa      8b45f4         mov eax, dword [local_ch]\n|           0x080486fd      890424         mov dword [esp], eax\n|           0x08048700      e8d3fdffff     call sym.imp.strcmp         ; int strcmp(const char *s1, const char *s2)\n|           0x08048705      85c0           test eax, eax\n|       ,=< 0x08048707      7515           jne 0x804871e\n|       |   0x08048709      8b45f8         mov eax, dword [local_8h]\n|       |   0x0804870c      89442404       mov dword [local_4h], eax\n|       |   0x08048710      c70424308904.  mov dword [esp], str.good_job:__s ; [0x8048930:4]=0x6e656942 ; \"Good job ! You just pass the challenge with the pass : %s!\n\"\n|       |   0x08048717      e87cfdffff     call sym.imp.printf         ; int printf(const char *format)\n|      ,==< 0x0804871c      eb0c           jmp 0x804872a\n|      ||   ; CODE XREF from main (0x8048707)\n|      |`-> 0x0804871e      c70424708904.  mov dword [esp], str.bad__password. ; [0x8048970:4]=0x6d6d6f44 ; \"Bad password.\"\n|      |    0x08048725      e89efdffff     call sym.imp.puts           ; int puts(const char *s)\n|      |    ; CODE XREF from main (0x804871c)\n|      `--> 0x0804872a      b800000000     mov eax, 0\n|           0x0804872f      83c424         add esp, 0x24               ; '$'\n|           0x08048732      59             pop ecx\n|           0x08048733      5d             pop ebp\n|           0x08048734      8d61fc         lea esp, [ecx - 4]\n\\           0x08048737      c3             ret\n[0x0804869d]> \n</code></pre>\n</div>\n</body></html>",
    "votes": "1",
    "answers": 1,
    "views": "6k",
    "tags": [
        "binary-analysis",
        "decompilation",
        "radare2",
        "breakpoint"
    ],
    "user": null,
    "time": "Dec 24, 2018 at 13:41",
    "comments": [
        {
            "user": "sudhackar",
            "text": "<html><body><span class=\"comment-copy\">\n I think there are issues already open for this. Disable ESIL emulation and don't open in debug mode. Use\n <code>\n  doo\n </code>\n in normal mode for\n <code>\n  dc\n </code>\n to work\n</span>\n</body></html>",
            "time": null
        },
        {
            "user": "user26834",
            "text": "<html><body><span class=\"comment-copy\">\n Ok, I executed the doo command and it works : radare2 ch1.bin\n <code>\n  aaa s sym.main pdf ood db 0x08048705 dc\n </code>\n Now, radare2 show me this message :\n <code>\n  hit breakpoint at: 8048705\n </code>\n . How can I print the two strings which are compared.\n</span>\n</body></html>",
            "time": null
        },
        {
            "user": "sudhackar",
            "text": "<html><body><span class=\"comment-copy\">\n Can you share the binary?\n</span>\n</body></html>",
            "time": null
        },
        {
            "user": "user26834",
            "text": "<html><body><span class=\"comment-copy\">\n Sure, this is the link of the challenge :\n <a href=\"https://www.root-me.org/fr/Challenges/Cracking/ELF-0-protection\" rel=\"nofollow noreferrer\">\n  root-me.org/fr/Challenges/Cracking/ELF-0-protection\n </a>\n</span>\n</body></html>",
            "time": null
        }
    ],
    "answers_data": [
        {
            "content": "<html><body><div class=\"s-prose js-post-body\" itemprop=\"text\">\n <p>\n  Here's how you do it with debugging.\n </p>\n <pre><code>$ r2 ch1.bin\n[0x080484f0]> aaa\n[x] Analyze all flags starting with sym. and entry0 (aa)\n[x] Analyze function calls (aac)\n[x] Analyze len bytes of instructions for references (aar)\n[x] Constructing a function name for fcn.* and sym.func.* functions (aan)\n[x] Type matching analysis for all functions (afta)\n[x] Use -AA or aaaa to perform additional experimental analysis.\n[0x080484f0]> doo\nProcess with PID 18337 started...\nFile dbg:///tmp/ch1.bin  reopened in read-write mode\n= attach 18337 18337\n18337\n[0xf7f6fc70]> pdf @ sym.main ~strcmp\nâ”‚           0x08048700      e8d3fdffff     call sym.imp.strcmp         ; int strcmp(const char *s1, const char *s2)\n</code></pre>\n <p>\n  Set a breakpoint at the\n  <code>\n   strcmp\n  </code>\n  call and continue execution.\n </p>\n <pre><code>[0xf7f6fc70]> s 0x08048700\n[0x08048700]> db 0x08048700\n[0x08048700]> dc\n############################################################\n##        Bienvennue dans ce challenge de cracking        ##\n############################################################\n\nVeuillez entrer le mot de passe : test\nhit breakpoint at: 8048700\n</code></pre>\n <p>\n  Use\n  <code>\n   pxr\n  </code>\n  to dump\n  <code>\n   esp\n  </code>\n  with flags and information about addresses.\n </p>\n <pre><code>[0x08048700]> pxr@esp~:0..5\n0xfff45270  0x09075570  pU.. @esp eax (test)\n0xfff45274  0x08048841  A... (.rodata) (/tmp/ch1.bin) str.123456789 program R X 'xor dword [edx], esi' 'ch1.bin' (123456789)\n0xfff45278  0xfff452a8  .R.. stack R W 0x0 -->  edi\n0xfff4527c  0x08048769  i... (.text) (/tmp/ch1.bin) sym.__libc_csu_init program R X 'lea eax, [ebx - 0xe8]' 'ch1.bin'\n0xfff45280  0x00000000  .... edi\n[0x08048700]>\n</code></pre>\n <p>\n  Stack top points to our input\n  <code>\n   test\n  </code>\n  passed as first param to\n  <code>\n   strcmp\n  </code>\n  . The next\n  <code>\n   dword\n  </code>\n  points to the second param at\n  <code>\n   0x08048841\n  </code>\n  string 123456789.\n </p>\n <p>\n  Since\n  <code>\n   strcmp\n  </code>\n  is a library function you can use\n  <code>\n   ltrace\n  </code>\n  to do the same.\n </p>\n <pre><code>$ ltrace ./ch1.bin\n__libc_start_main(0x804869d, 1, 0xffbe8304, 0x8048750 <unfinished ...>\nputs(\"################################\"...############################################################\n)                                               = 61\nputs(\"##        Bienvennue dans ce cha\"...##        Bienvennue dans ce challenge de cracking        ##\n)                                               = 61\nputs(\"################################\"...############################################################\n\n)                                               = 62\nprintf(\"Veuillez entrer le mot de passe \"...)                                             = 34\nmalloc(2)                                                                                 = 0x9352570\ngetchar(2, 0, 0xffbe8258, 0xf7d792f6Veuillez entrer le mot de passe : test\n)                                                     = 116\nrealloc(0x9352570, 2)                                                                     = 0x9352570\ngetchar(0x9352570, 2, 0xffbe8258, 0xf7d792f6)                                             = 101\nrealloc(0x9352570, 3)                                                                     = 0x9352570\ngetchar(0x9352570, 3, 0xffbe8258, 0xf7d792f6)                                             = 115\nrealloc(0x9352570, 4)                                                                     = 0x9352570\ngetchar(0x9352570, 4, 0xffbe8258, 0xf7d792f6)                                             = 116\nrealloc(0x9352570, 5)                                                                     = 0x9352570\ngetchar(0x9352570, 5, 0xffbe8258, 0xf7d792f6)                                             = 10\nstrcmp(\"test\", \"123456789\")                                                               = 1\nputs(\"Dommage, essaye encore une fois.\"...Dommage, essaye encore une fois.\n)                                               = 33\n+++ exited (status 0) +++\n</code></pre>\n <p>\n  TBF you don't need to debug it at all and just static analysis would do.\n </p>\n <pre><code>[0x080484f0]> pdf @ sym.main~strcmp\nâ”‚           0x08048700      e8d3fdffff     call sym.imp.strcmp         ; int strcmp(const char *s1, const char *s2)\n[0x080484f0]> s 0x08048700\n[0x08048700]> pd-10\nâ”‚           0x080486d9      c704240c8904.  mov dword [esp], str.Veuillez_entrer_le_mot_de_passe_: ; [0x804890c:4]=0x69756556 ; \"Veuillez entrer le mot de passe : \" ; const char *format\nâ”‚           0x080486e0      e8b3fdffff     call sym.imp.printf         ; int printf(const char *format)\nâ”‚           0x080486e5      8b45f4         mov eax, dword [s1]\nâ”‚           0x080486e8      890424         mov dword [esp], eax\nâ”‚           0x080486eb      e80effffff     call sym.getString\nâ”‚           0x080486f0      8945f4         mov dword [s1], eax\nâ”‚           0x080486f3      8b45f8         mov eax, dword [local_8h]\nâ”‚           0x080486f6      89442404       mov dword [s2], eax         ; const char *s2\nâ”‚           0x080486fa      8b45f4         mov eax, dword [s1]\nâ”‚           0x080486fd      890424         mov dword [esp], eax        ; const char *s1\n[0x08048700]>\n</code></pre>\n <p>\n  Now we know the arguments to\n  <code>\n   strcmp\n  </code>\n  :\n  <code>\n   s1\n  </code>\n  and\n  <code>\n   local_8h\n  </code>\n  .\n  <code>\n   s1\n  </code>\n  was populated with a call to\n  <code>\n   sym.getString\n  </code>\n  , so thats probably our input and hence\n  <code>\n   local_8h\n  </code>\n  is the string we need to find to match.\n </p>\n <p>\n  We'll see where it was used//modified (read/write) in the function. Use afv(R/W)\n </p>\n <pre><code>[0x08048700]> afv?\nUsage: afv  [rbs]\n| afvr[?]                       manipulate register based arguments\n| afvb[?]                       manipulate bp based arguments/locals\n| afvs[?]                       manipulate sp based arguments/locals\n| afv*                          output r2 command to add args/locals to flagspace\n| afvR [varname]                list addresses where vars are accessed (READ)\n| afvW [varname]                list addresses where vars are accessed (WRITE)\n| afva                          analyze function arguments/locals\n| afvd name                     output r2 command for displaying the value of args/locals in the debugger\n| afvn [new_name] ([old_name])  rename argument/local\n| afvt [name] [new_type]        change type for given argument/local\n| afv-([name])                  remove all or given var\n</code></pre>\n <p>\n  Use this on\n  <code>\n   local_8h\n  </code>\n </p>\n <pre><code>[0x08048700]> afvR local_8h\n  local_8h  0x80486f3,0x8048709\n[0x08048700]> afvW local_8h\n  local_8h  0x80486ae\n</code></pre>\n <p>\n  At 0x80486ae it was written to or initialized.\n </p>\n <pre><code>[0x08048700]> pd3 @ 0x80486ae \nâ”‚           0x080486ae      c745f8418804.  mov dword [local_8h], str.123456789 ; 0x8048841 ; \"123456789\"\nâ”‚           0x080486b5      c704244c8804.  mov dword [esp], str.       ; [0x804884c:4]=0x23232323 ; \"############################################################\" ; const char *s\nâ”‚           0x080486bc      e807feffff     call sym.imp.puts           ; int puts(const char *s)\n[0x08048700]> \n</code></pre>\n <p>\n  Here r2 resolved the address 0x8048841 to a string 123456789\n </p>\n</div>\n</body></html>",
            "votes": "3",
            "user": "sudhackar",
            "time": "Dec 27, 2018 at 11:29",
            "is_accepted": true,
            "comments": []
        }
    ]
}