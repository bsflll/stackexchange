{
    "title": "Is it possible to get python bytecode without using co_code?",
    "link": "https://reverseengineering.stackexchange.com/questions/1934/is-it-possible-to-get-python-bytecode-without-using-co-code",
    "content": "<html><body><div class=\"s-prose js-post-body\" itemprop=\"text\">\n <p>\n  I posted this a while back on\n  <a href=\"https://stackoverflow.com/questions/12513901/is-it-possible-to-get-python-bytecode-without-using-co-code\">\n   stackoverflow\n  </a>\n  (too old to migrate though).\n </p>\n <p>\n  Say I am in the python interpreter and define a function as follows:\n </p>\n <pre><code>def h(a):\n  return a\n</code></pre>\n <p>\n  If I want to look at the bytecode (not a disassembly using dis), I can typically use\n  <code>\n   h.func_code.co_code\n  </code>\n  . Is there any other way to look at the bytecode? This particular application was packaged with a custom python interpreter (using py2exe probably) which removed access to co_code. I can't just look at the pyc file as they are encrypted.\n </p>\n <p>\n  For example, in the interpreter, if I just type\n  <code>\n   h\n  </code>\n  without making it a function call, I get the address of the function. Can I use that address to get the bytecode? Is there some other way?\n </p>\n <p>\n  P.S. My original goal in doing this at the time was to use pyREtic (which calls co_code) to decompile. Since it called co_code, it would fail to work. I figured out one way to do it which I will post as an answer eventually. Wanted to see what others have done or come up with.\n </p>\n</div>\n</body></html>",
    "votes": "18",
    "answers": 2,
    "views": "8k",
    "tags": [
        "python"
    ],
    "user": "mikeazo",
    "time": "May 23, 2017 at 12:37",
    "comments": [
        {
            "user": "Avery3R",
            "text": "<html><body><span class=\"comment-copy\">\n Don't have access to a computer right now, but have you tried digging into the python source code to see what co_code does?\n</span>\n</body></html>",
            "time": null
        },
        {
            "user": "mikeazo",
            "text": "<html><body><span class=\"comment-copy\">\n yeah, co_code is just a buffer that stores the bytecode of the given function.\n</span>\n</body></html>",
            "time": null
        }
    ],
    "answers_data": [
        {
            "content": "<html><body><div class=\"s-prose js-post-body\" itemprop=\"text\">\n <p>\n  First, just a small reminder about \"what is\n  <code>\n   co_code\n  </code>\n  \".\n </p>\n <p>\n  In Python, every element of the language (functions, methods, classes, ...) is defined and stored in an object. The\n  <code>\n   co_code\n  </code>\n  is one of the fields attached to the class used to represent a function or a method.  Lets practice a bit with Python 2.7.\n </p>\n <pre><code>$> python2.7\nPython 2.7.3 (default, Mar  4 2013, 14:57:34) \n[GCC 4.7.2] on linux2\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> def foo():\n...     print('Hello World!')\n... \n>>> dir(foo.__code__)\n\n['__class__', '__cmp__', '__delattr__', '__doc__', '__eq__', '__format__', '__ge__', \n '__getattribute__', '__gt__', '__hash__', '__init__', '__le__', '__lt__', '__ne__', \n '__new__',  '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', \n '__str__', '__subclasshook__', 'co_argcount', 'co_cellvars', 'co_code', 'co_consts', \n 'co_filename', 'co_firstlineno', 'co_flags', 'co_freevars', 'co_lnotab', 'co_name', \n 'co_names', 'co_nlocals', 'co_stacksize', 'co_varnames']\n>>> foo.__code__.co_code\n'd\\x01\\x00GHd\\x00\\x00S'\n</code></pre>\n <p>\n  So, you can see that the\n  <code>\n   co_code\n  </code>\n  field contain the compiled bytecode of the function we just defined previously. In fact, it seems that\n  <code>\n   co_code\n  </code>\n  is just a buffer to store the compiled bytecode in a lazy manner. It is compiled only when it is accessed for the first time.\n </p>\n <p>\n  Assuming this, the\n  <code>\n   co_code\n  </code>\n  is just a unified helper to access the bytecode which might be stored in several forms. One form are the\n  <code>\n   *.pyc\n  </code>\n  files which are storing the compiled Python bytecode of a whole file. Another form is just the on-the-fly compilation of the function/method.\n </p>\n <p>\n  Nevertheless, there is a way to access directly the function/method definition and, thus, to the bytecode. The point is to intercept the Python process with\n  <code>\n   gdb\n  </code>\n  and analyze it. A few tutorials exists in the web about this (see\n  <a href=\"http://grapsus.net/blog/post/Low-level-Python-debugging-with-GDB\">\n   here\n  </a>\n  ,\n  <a href=\"http://docs.python.org/devguide/gdb.html\">\n   here\n  </a>\n  ,\n  <a href=\"http://www.jmcneil.net/2012/04/debugging-your-python-with-gdb-ftw/\">\n   here\n  </a>\n  or\n  <a href=\"http://chrismiles.livejournal.com/20226.html\">\n   here\n  </a>\n  ). But, here is a quick example (you need to install the\n  <code>\n   python-gdb\n  </code>\n  package first):\n </p>\n <pre><code>$> python2.7-dbg\nPython 2.7.3 (default, Mar  4 2013, 14:27:19) \n[GCC 4.7.2] on linux2\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> def foo():\n...     print('Hello World!')\n... \n[40809 refs]\n>>> foo\n<function foo at 0x1a5e1b0>\n[40811 refs]\n>>> foo.__code__.co_code\n'd\\x01\\x00GHd\\x00\\x00S'\n[40811 refs]\n>>> \n[1]+  Stopped                 python2.7-dbg\n</code></pre>\n <p>\n  Then, you need to get the PID of the Python process and attach\n  <code>\n   gdb\n  </code>\n  on it.\n </p>\n <pre><code>$ gdb -p 5164\nGNU gdb (GDB) 7.4.1-debian\n...\nAttaching to process 5164\nProgram received signal SIGTSTP, Stopped (user).\nReading symbols from /usr/bin/python2.7-dbg...done.\nReading symbols from /lib/x86_64-linux-gnu/libpthread.so.0...\nReading symbols from /usr/lib/debug/lib/x86_64-linux-gnu/libpthread-2.13.so...done.\n[Thread debugging using libthread_db enabled]\nUsing host libthread_db library \"/lib/x86_64-linux-gnu/libthread_db.so.1\".done.\n...\n(gdb) print *(PyFunctionObject*)0x1a5e1b0\n$1 = {_ob_next = 0x187aca0, _ob_prev = 0x189dd08, ob_refcnt = 2, \n      ob_type = 0x87ce00, func_code = <code at remote 0x187aca0>, \n      func_globals = {'__builtins__': <module at remote 0x7f5ebcb5e470>,\n      '__name__': '__main__', 'foo': <function at remote 0x1a5e1b0>, '__doc__': None, \n      '__package__': None}, func_defaults = 0x0, func_closure = 0x0, func_doc = None, \n      func_name = 'foo', func_dict = 0x0, func_weakreflist = 0x0, \n      func_module = '__main__'}\n(gdb) print  (*(PyFunctionObject*)0x1a5e1b0)->func_name\n$2 = 'foo'\n(gdb) print (*(PyCodeObject*)0x187aca0)\n$3 = {_ob_next = 0x18983a8, _ob_prev = 0x1a5e1b0, ob_refcnt = 1, ob_type = 0x872680, \n      co_argcount = 0, co_nlocals = 0, co_stacksize = 1, co_flags = 67,\n      co_code = 'd\\x01\\x00GHd\\x00\\x00S', co_consts = (None, 'Hello World!'),\n      co_names = (), co_varnames = (), co_freevars = (), co_cellvars = (),\n      co_filename = '<stdin>', co_name = 'foo', co_firstlineno = 1,\n      co_lnotab = '\\x00\\x01', co_zombieframe = 0x0, co_weakreflist = 0x0}\n(gdb) print (*(PyCodeObject*)0x187aca0)->co_code\n$4 = 'd\\x01\\x00GHd\\x00\\x00S'\n</code></pre>\n <p>\n  So, here is the way to access directly the bytecode, given the address of the function.\n </p>\n <p>\n  Just to try to  be complete, the best documentation I found on Python bytecode (and how to access it), is the Python code itself and especially the\n  <code>\n   inspect\n  </code>\n  module (\n  <a href=\"http://hg.python.org/cpython/file/2.7/Lib/inspect.py\">\n   2.7\n  </a>\n  ,\n  <a href=\"http://hg.python.org/cpython/file/3.2/Lib/inspect.py\">\n   3.2\n  </a>\n  ). Try to look at it, it is quite instructive.\n </p>\n <p>\n  Another help you can use is the\n  <a href=\"http://docs.python.org/2/library/dis.html\">\n   <code>\n    dis\n   </code>\n   module\n  </a>\n  that provide a disassembler for the Python bytecode. Here is an example of what can do this disassembler.\n </p>\n <pre><code>$> python2.7\nPython 2.7.3 (default, Mar  4 2013, 14:57:34) \n[GCC 4.7.2] on linux2\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> def foo():\n...     print(\"Hello World!\")\n... \n>>> import dis\n>>> dis.dis(foo)\n  2           0 LOAD_CONST               1 ('Hello World!')\n              3 PRINT_ITEM          \n              4 PRINT_NEWLINE       \n              5 LOAD_CONST               0 (None)\n              8 RETURN_VALUE \n</code></pre>\n</div>\n</body></html>",
            "votes": "20",
            "user": "perror",
            "time": "Apr 27, 2013 at 18:13",
            "is_accepted": true,
            "comments": [
                {
                    "user": "mikeazo",
                    "text": "<span class=\"comment-copy\">That's pretty cool! I'm not 100% sure this would have worked in the particular project I was working on as it had a custom python interpreter that I probably couldn't install the gdb bindings for. Still a great technique nonetheless. Thanks for sharing!</span>",
                    "time": null
                }
            ]
        },
        {
            "content": "<html><body><div class=\"s-prose js-post-body\" itemprop=\"text\">\n <p>\n  perror's answer I think is the correct way to do it. I wanted to post the way I ended up doing this for other's sake just in case the issue I mentioned in my comment to perror's answer is correct. I don't have all my notes with me right now and will update if necessary.\n </p>\n <p>\n  Basically I ran the program in gdb, set a break point in PyObject_New (or possibly PyObject_Init). I set the break point near the end of the function so that the object would be created. From there I was able to look into the object in memory to extract the byte code.\n </p>\n <p>\n  To get this info back to pyREtic, I dumped function names and bytecode to a file from within GDB, modified pyREtic so that instead of calling co_code to get the bytecode, it would extract it from the file.\n </p>\n <p>\n  Like I said, it has been a while now (the stackoverflow question was from Sept 2012). I'll look back over my notes and fill in the details.\n </p>\n</div>\n</body></html>",
            "votes": "2",
            "user": "mikeazo",
            "time": "Apr 27, 2013 at 19:21",
            "is_accepted": false,
            "comments": []
        }
    ]
}