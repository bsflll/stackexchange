{
    "title": "ResumeThread doesn't work after attaching to the process using vTrace",
    "link": "https://reverseengineering.stackexchange.com/questions/4322/resumethread-doesnt-work-after-attaching-to-the-process-using-vtrace",
    "content": "<html><body><div class=\"s-prose js-post-body\" itemprop=\"text\">\n <p>\n  In an effort to learn vtrace I've been trying to attach to a process and hook the import address table and then resume the main thread of a process.  When I don't attach to the process the ResumeThread() call works fine.  But when I do it spins up a thread then the call to ResumeThread() doesn't work and the main thread never runs.  Below is the code...\n </p>\n <pre><code>from ctypes import *\nfrom ctypes import wintypes\nfrom defines import *\nimport vdb\nimport vtrace\nimport sys\nfrom iathook import *\n\nclass PROCESS_INFORMATION(ctypes.Structure):\n    _fields_ = [\n            (\"hProcess\",    HANDLE),\n            (\"hThread\",     HANDLE),\n            (\"dwProcessId\", DWORD),\n            (\"dwThreadId\",  DWORD),\n            ]    \n\nprocess_info    = PROCESS_INFORMATION()\n\nkernel32 = ctypes.WinDLL('kernel32.dll')\n\nbCreateProcessW = kernel32.CreateProcessA(\n                                path_to_binary,\n                                None,\n                                None,\n                                None,\n                                True,\n                                creation_flags,\n                                None,\n                                None,\n                                byref(startupinfo),\n                                byref(process_info))\n\n#launched the process in a suspended state and patch it using DLL injection\n#but this code doesn't effect the following code\n\napptrace = vtrace.getTrace()              \napptrace.attach(process_info.dwProcessId)     #1\nhookSomeStuff = hookIat(apptrace, 'MSVCR110') #2\n#apptrace.resumeThread(process_info.hThread)  #3\ndwPrevSuspendCount = kernel32.ResumeThread(process_info.hThread)\n</code></pre>\n <p>\n  As I mentioned above when I remove the\n  <code>\n   vtrace attach\n  </code>\n  and and\n  <code>\n   hookIat\n  </code>\n  stuff (line #1 & #2).  The ResumeThread() call works fine and the main thread runs.  I also tried resuming the thread using the vtrace method (line #3) but it tells me that the thread is not suspended.  The main thread doesn't actually run so I wonder how it could not be suspended or what happened to it.  I also check the events of the binary using procmon and when it attaches it spins up another thread and that seems to throw things off.  This may seem awkward and I understand there are many other ways to do this but I'm using it as a learning exercise and now I'm interested why it's not working.  Any help is appreciated and thanks in advance for any help.\n </p>\n</div>\n</body></html>",
    "votes": "2",
    "answers": 0,
    "views": "231",
    "tags": [
        "python"
    ],
    "user": "user2743",
    "time": "May 13, 2014 at 4:35",
    "comments": [],
    "answers_data": []
}