{
    "title": "Dealing with instructions that are accessed by multiple pieces of data",
    "link": "https://reverseengineering.stackexchange.com/questions/16714/dealing-with-instructions-that-are-accessed-by-multiple-pieces-of-data",
    "content": "<html><body><div class=\"s-prose js-post-body\" itemprop=\"text\">\n <p>\n  So to gain more experience with reversing, I am currently trying to write an external hack for a video game called Borderlands 2. I've been using cheat engine to scan for addresses of instructions that modify values such as ammo and health. I found an instruction that seems to be used for loss of health, and total ammo for all entities in the game. (i.e filling it with NOPs doesn't help me, because it puts me, as well as all of the enemies in godmode and gives everything inf. ammo). My goal is to have one command put me in god mode and a different one to give me inf. ammo and not affect any of the other creatures. Does anyone know how I can NOP this shared instruction only for my health when I use a godmode command and only for my ammo when I use an inf. ammo command? I imagine I need to somehow figure out if the instruction is being used to update my player values (probably by comparing some other offset from the base address to the enemy values at that offset), but I also need to figure out how to determine if the instruction is trying to modify my health or ammo so that I can NOP it only when it is modifying the one corresponding to whichever command I currently have active. Any ideas are welcome!\n </p>\n</div>\n</body></html>",
    "votes": "4",
    "answers": 2,
    "views": "3k",
    "tags": [
        "assembly",
        "memory",
        "dynamic-analysis"
    ],
    "user": "3asssains",
    "time": "Nov 5, 2017 at 2:47",
    "comments": [],
    "answers_data": [
        {
            "content": "<html><body><div class=\"s-prose js-post-body\" itemprop=\"text\">\n <p>\n  The joy of shared instructions! Here are a couple of ideas for you to consider, both of which I'm going to be using Cheat Engine to demonstrate, because it's fast becoming the superior dynamic analysis tool\n  <em>\n   for game-hacking\n  </em>\n  .\n </p>\n <p>\n  <strong>\n   1\n  </strong>\n  . Instead of looking for the instruction that writes to the address, right-click on it and look for instructions that\n  <em>\n   access\n  </em>\n  the address. There, you will find instructions that read the value from the address, as well as instructions that write to it. An example of an instruction that reads the value might be for the HUD representation of health. To know how far up to show your health bar being filled, it reads the value from your health address.\n </p>\n <p>\n  What that means is if you find an address that\n  <em>\n   reads\n  </em>\n  your health value, that may be the only thing that instruction does. You can then create a code injection just before that instruction and move a custom value into the address that's being referenced or pointed at.\n </p>\n <p>\n  For example, let's say this is an instruction that reads from your health address:\n </p>\n <p>\n  <strong>\n   mov eax,[ecx+0C]\n  </strong>\n </p>\n <p>\n  In that case, your health address is being pointed to by [ecx+0C]. The value there is being moved into the eax register. What you could do is create a code injection at that instruction with which to write a custom health value to [ecx+0C] before the mov instruction runs. That would change the actual value of health, and thus that custom value is then read from the address. This is easy to do with Cheat Engine (via its native code injection functionality), but otherwise requires you to look into\n  <strong>\n   <a href=\"https://www.codeproject.com/Articles/20240/The-Beginners-Guide-to-Codecaves\" rel=\"nofollow noreferrer\">\n    code-caving\n   </a>\n  </strong>\n  .\n </p>\n <p>\n  <strong>\n   2.\n  </strong>\n  To use a shared instruction like the one you've found, you have to find a way to differentiate what you want to influence, from the rest of the addresses being written to. This can look like a daunting task, especially when you find a shared instruction like\n  <a href=\"https://www.youtube.com/watch?v=5fJFSOPGZyQ\" rel=\"nofollow noreferrer\">\n   in GameMaker games\n  </a>\n  where HUNDREDS of addresses are all being written to through one instruction, but fear not!\n </p>\n <p>\n  Your options are to find differences in the following places:\n </p>\n <pre><code>A) Memory addresses (Including the stack)\nB) Registers (General purpose, FPU/XMM, special purpose, etc.)\n</code></pre>\n <p>\n  Right-click on the shared instruction and choose \"Find out what addresses this instruction accesses.\" A new window will pop up showing addresses that instruction is writing to. From that window, you can do a whole lot of neat things.\n </p>\n <p>\n  First, Cheat Engine provides a handy Data/Structure Dissect tool that you can use to compare values between multiple memory addresses. If you select all the addresses (Shift-click, or Ctrl-click the ones you're interested in), then right-click, you'll see an option to open the data dissect tool. There, you can compare values to find differences in the same offsets!\n </p>\n <p>\n  Something else you can do from that list of addresses is hit Ctrl + R to view the contents of registers. There, you can usually find a register containing a different value between all addresses (you'll want to look for a differing value that's NOT a dynamic memory address, because that value will change when restarting the game).\n </p>\n <p>\n  Finally, when viewing the contents of registers, there are two little buttons on that window: 'S' and 'F'.\n </p>\n <p>\n  'S' lets you view the stack. There, you can look for values to differentiate. 'F' lets you view the contents of the FPU, and XMM registers. Sometimes, the latter can be helpful because, say, the FPU might have been used ONLY for health and not for any other values that shared instruction is writing to.\n </p>\n <p>\n  Bringing it all together, you'll use whatever unique value(s) you find to write a custom code injection that will allow you to single out the value you're interested in. Let's say your instruction is this:\n </p>\n <p>\n  <strong>\n   mov [edx+0C],eax\n  </strong>\n </p>\n <p>\n  And let's say that, in register ebx, you found a unique value of 2B.\n </p>\n <p>\n  Your injected code might look something like this:\n </p>\n <pre><code>label(customCode)\nlabel(restoreFlags)\nlabel(originalCode)\nlabel(return)\n\ncustomCode:\n  pushf //Preserve flags register by pushing onto the stack\n  cmp ebx,2B //Does ebx contain the value you're interested in?\n  jne restoreFlags //If not, restore flags register and resume normal execution\n  mov eax,(float)100 //If so, move a custom health value into eax for originalCode\n  //Execution flow from here moves to restoreFlags\n\nrestoreFlags:\n  popf //Restore flags register\n  //Execution flow from here moves to originalCode\n\noriginalCode:\n  mov [edx+0C],eax //eax contains either value from normal execution, or custom health\n  jmp return //Return to the point we injected and resume normal execution\n</code></pre>\n <p>\n  I don't mean this as shameless self-promotion, but I've been running a YouTube channel for the better part of 3 years that teaches reversing via game-hacking. If games are your medium and you enjoy learning via videos, I think you'd really learn a lot from\n  <strong>\n   <a href=\"https://www.youtube.com/watch?v=m7yaYoc-ils&list=PLNffuWEygffbbT9Vz-Y1NXQxv2m6mrmHr&index=18\" rel=\"nofollow noreferrer\">\n    my CE tutorial series\n   </a>\n  </strong>\n  , specifically. I also teach game-specific hacks, like Cuphead, ELEX, etc.\n </p>\n <p>\n  Good luck!\n </p>\n</div>\n</body></html>",
            "votes": "6",
            "user": "dsasmblr",
            "time": "Nov 6, 2017 at 22:51",
            "is_accepted": true,
            "comments": []
        },
        {
            "content": "<html><body><div class=\"s-prose js-post-body\" itemprop=\"text\">\n <p>\n  Kind of a shot into the blue here, but here are some thoughts which may help you and that won't fit into the comments:\n </p>\n <p>\n  3D Engines often work with entity-Objects in flexible inheritance hierarchies. I assume something like the following:\n </p>\n <pre><code>class GameObject(x, y, z)\n...\nclass GameEntity(x, y, z, health) : GameObject\n    void takeDamage(x)\n    void decreaseAmmo(x)\n...\nclass Player() : GameEntity\n</code></pre>\n <p>\n  In most common languages (like C++), each class will have a separate function table pointing at the implementations of all class methods. For example, when we call\n  <code>\n   takeDamage\n  </code>\n  on a\n  <code>\n   Player\n  </code>\n  -Object, we would expect the method implemented for all\n  <code>\n   GameEntities\n  </code>\n  to be executed. Therefore NOP'ing out the function will have the effects you described before.\n </p>\n <p>\n  <strong>\n   tl;dr\n  </strong>\n </p>\n <p>\n  It seems you have two valid options: Find the right function pointer to manipulate or check the identity of the\n  <code>\n   this\n  </code>\n  -pointer which is often passed as the first parameter to a member function.\n </p>\n</div>\n</body></html>",
            "votes": "3",
            "user": "Nordwald",
            "time": "Nov 6, 2017 at 7:57",
            "is_accepted": false,
            "comments": [
                {
                    "user": "Mugen",
                    "text": "<span class=\"comment-copy\">I think there's something more going on here to do with the coded value. If they're directly manipulating the data then it should be easy to find the correct one directly using the \"exact search\" feature. However, the reason that they're not able to find it makes me feel that the value is somehow being coded by one of these functions and that function is called for coding/decoding every value that the game uses. Hence, the right memory spot isn't found by searching. The spot that's found is at the wrong end of the decoding function.</span>",
                    "time": null
                }
            ]
        }
    ]
}