{
    "title": "Bypassing Enigma loader",
    "link": "https://reverseengineering.stackexchange.com/questions/8236/bypassing-enigma-loader",
    "content": "<html><body><div class=\"s-prose js-post-body\" itemprop=\"text\">\n <p>\n  Currently I'm trying to get past Enigma's loader, which asks you for a name & key, as an excercise.\n </p>\n <p>\n  I have very little progress, as I haven't worked too much with packers.\n </p>\n <p>\n  What I did was breakpoint on\n  <code>\n   CreateWindowExA\n  </code>\n  , and then I put random data at key / name, and then click\n  <code>\n   Register\n  </code>\n  , which effectively breaks at\n  <code>\n   CreateWindowExA\n  </code>\n  .\n </p>\n <p>\n  From there, I'm able to check the stack and go back a few calls, but I'm really lost as there's a lot of bloat code (short functions with x87 instructions), and I don't know where to continue.\n </p>\n <p>\n  I also know that the routine that checks the serial is virtualized, so I should patch the places which check the return of the function that checks the serial instead of the function itself, but then again, I get lost when looking at the stack.\n </p>\n <p>\n  Here's my progress so far:\n </p>\n <p>\n  The breakpoint on\n  <code>\n   CreateWindowExA\n  </code>\n  , which gets called when you input an invalid serial\n  <img alt=\"enter image description here\" src=\"https://i.sstatic.net/eA0gF.png\"/>\n </p>\n <p>\n  The function that calls it:\n  <a href=\"http://screenshotuploader.com/i/1502/t_q0c.png\" rel=\"nofollow noreferrer\">\n   http://screenshotuploader.com/i/1502/t_q0c.png\n  </a>\n </p>\n <p>\n  And that function, before and after calling\n  <code>\n   CreateWindowExA\n  </code>\n  , calls these two weird x87 functions:\n </p>\n <p>\n  <img alt=\"enter image description here\" src=\"https://i.sstatic.net/2ZgUw.png\"/>\n </p>\n <p>\n  <em>\n   the function that is marked in the previous screenshot\n  </em>\n </p>\n <p>\n  <img alt=\"enter image description here\" src=\"https://i.sstatic.net/d5G5N.png\"/>\n </p>\n <p>\n  <em>\n   this one gets called a few instructions after\n   <code>\n    CreateWindowExA\n   </code>\n  </em>\n </p>\n <p>\n  After going one more function back, I see:\n </p>\n <p>\n  <img alt=\"enter image description here\" src=\"https://i.sstatic.net/yOBsE.png\"/>\n </p>\n <p>\n  The problem with that function is that it's using some tricks to change the return address (I guess), like this:\n </p>\n <p>\n  <img alt=\"enter image description here\" src=\"https://i.sstatic.net/LoWvz.png\"/>\n </p>\n <p>\n  Which then leads to weird code which expects a function pointer in\n  <code>\n   edx\n  </code>\n  returned by a funtion that is dereferencing a pointer to a\n  <code>\n   word\n  </code>\n  (2 bytes)!\n </p>\n <p>\n  Here's the code that calls the function that returns a pointer to a function:\n  <img alt=\"enter image description here\" src=\"https://i.sstatic.net/CxzoC.png\"/>\n </p>\n <p>\n  And here's the function that returns a pointer in\n  <code>\n   edx\n  </code>\n  :\n  <img alt=\"enter image description here\" src=\"https://i.sstatic.net/43Cm7.png\"/>\n </p>\n <p>\n  It is really weird, as it 1) derefs a\n  <code>\n   word\n  </code>\n  (2 bytes, not enough for a function pointer!), and 2)\n  <code>\n   FLDCW\n  </code>\n  loads a x87 FPU control word... what's happening here?!\n </p>\n <p>\n  Also, that's the last return I can see in the stack, as the rest of the values are zeroed, and there's no branch which checks the serial at this depth, so I don't know where to continue looking at.\n </p>\n <hr/>\n <p>\n  And if not enough, the program closes each time I input an invalid serial, which makes it harder, because the next time the offsets are totally different and I can't find the code so I breakpoint a bit before, so I'm really lost!\n </p>\n <p>\n  Dumping the executable at runtime does absolutely nothing, as it's still packed as it was before, it just makes it 4x bigger (50MB -> 200MB), and doesn't help at all.\n </p>\n <p>\n  Any help would be great, even a simple idea, like a hint on what to do next, where to breakpoint, where to look at, or whatever you can think of, would help a lot.\n </p>\n</div>\n</body></html>",
    "votes": "4",
    "answers": 0,
    "views": "2k",
    "tags": [
        "debugging",
        "unpacking",
        "crackme"
    ],
    "user": "rev",
    "time": "Feb 13, 2015 at 19:05",
    "comments": [
        {
            "user": "qnet Ug",
            "text": "<html><body><span class=\"comment-copy\">\n I also have a problem with my files, if you were able to figure out please help me too.\n <a href=\"https://workupload.com/file/TQ9LCnExkdj\" rel=\"nofollow noreferrer\">\n  workupload.com/file/TQ9LCnExkdj\n </a>\n thats the link to my files\n</span>\n</body></html>",
            "time": null
        },
        {
            "user": "Yotamz",
            "text": "<html><body><span class=\"comment-copy\">\n This does not really answer the question. If you have a different question, you can ask it by clicking\n <a href=\"https://reverseengineering.stackexchange.com/questions/ask\">\n  Ask Question\n </a>\n . To get notified when this question gets new answers, you can\n <a href=\"https://meta.stackexchange.com/q/345661\">\n  follow this question\n </a>\n . Once you have enough\n <a href=\"https://reverseengineering.stackexchange.com/help/whats-reputation\">\n  reputation\n </a>\n , you can also\n <a href=\"https://reverseengineering.stackexchange.com/help/privileges/set-bounties\">\n  add a bounty\n </a>\n to draw more attention to this question. -\n <a href=\"/review/late-answers/24665\">\n  From Review\n </a>\n</span>\n</body></html>",
            "time": null
        }
    ],
    "answers_data": []
}