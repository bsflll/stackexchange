{
    "title": "What does the instructions sequence call/cdqe/ret do?",
    "link": "https://reverseengineering.stackexchange.com/questions/29449/what-does-the-instructions-sequence-call-cdqe-ret-do",
    "content": "<html><body><div class=\"s-prose js-post-body\" itemprop=\"text\">\n <p>\n  I'm trying to reverse a Linux module. In the\n  <code>\n   ioctl\n  </code>\n  routine, I have the following sequence of instructions (generated by\n  <code>\n   objdump -M intel -d test.ko\n  </code>\n  ):\n </p>\n <pre><code> 3f9:   74 3b                   je     436 <device_ioctl+0x46>\n...\n 436:   e8 00 00 00 00          call   43b <device_ioctl+0x4b>\n 43b:   48 98                   cdqe   \n 43d:   c3                      ret\n</code></pre>\n <p>\n  I'm not sure to understand what happens here after the jump is done.\n </p>\n <p>\n  First, we have a\n  <a href=\"https://www.felixcloutier.com/x86/call\" rel=\"nofollow noreferrer\">\n   <code>\n    call\n   </code>\n  </a>\n  instruction. The opcode is\n  <code>\n   E8 00\n  </code>\n  so it is a near call to the next instruction. The EIP register (which contain the address of the next instruction) is also pushed on the stack.\n </p>\n <p>\n  Then, we continue with the\n  <a href=\"https://www.felixcloutier.com/x86/cbw:cwde:cdqe\" rel=\"nofollow noreferrer\">\n   <code>\n    cdqe\n   </code>\n  </a>\n  instruction. It extends the sign of the EAX register into RAX. In other words, it does nothing. Just to mention, EAX/RAX register has not been modified from the beginning of the routine.\n </p>\n <p>\n  Finally, the\n  <a href=\"https://www.felixcloutier.com/x86/ret\" rel=\"nofollow noreferrer\">\n   <code>\n    ret\n   </code>\n  </a>\n  instruction is executed. It pops the stack into EIP which corresponds to the previous instruction and we continue the execution of the routine from that point.\n </p>\n <p>\n  Therefore,\n  <code>\n   cdqe\n  </code>\n  is executed again (to do nothing) and the\n  <code>\n   ret\n  </code>\n  instruction is called again. This time, we leave the\n  <code>\n   ioctl\n  </code>\n  routine and return to the callee.\n </p>\n <p>\n  Am I right saying this does nothing? If so, what is the point of that code?\n </p>\n <hr/>\n <p>\n  Here is the full routine:\n </p>\n <pre><code>00000000000003f0 <device_ioctl>:\n 3f0:   48 89 d7                mov    rdi,rdx\n 3f3:   81 fe 03 b0 fe ca       cmp    esi,0xcafeb003\n 3f9:   74 3b                   je     436 <device_ioctl+0x46>\n 3fb:   77 18                   ja     415 <device_ioctl+0x25>\n 3fd:   81 fe 01 b0 fe ca       cmp    esi,0xcafeb001\n 403:   74 39                   je     43e <device_ioctl+0x4e>\n 405:   81 fe 02 b0 fe ca       cmp    esi,0xcafeb002\n 40b:   75 39                   jne    446 <device_ioctl+0x56>\n 40d:   e8 00 00 00 00          call   412 <device_ioctl+0x22>\n 412:   48 98                   cdqe   \n 414:   c3                      ret    \n 415:   48 c7 c0 00 00 00 00    mov    rax,0x0\n 41c:   48 c7 c2 ff ff ff ff    mov    rdx,0xffffffffffffffff\n 423:   48 2d 00 00 00 00       sub    rax,0x0\n 429:   81 fe 04 b0 fe ca       cmp    esi,0xcafeb004\n 42f:   89 c0                   mov    eax,eax\n 431:   48 0f 45 c2             cmovne rax,rdx\n 435:   c3                      ret    \n 436:   e8 00 00 00 00          call   43b <device_ioctl+0x4b>\n 43b:   48 98                   cdqe   \n 43d:   c3                      ret    \n 43e:   e8 00 00 00 00          call   443 <device_ioctl+0x53>\n 443:   48 98                   cdqe   \n 445:   c3                      ret    \n 446:   48 83 c8 ff             or     rax,0xffffffffffffffff\n 44a:   c3                      ret    \n</code></pre>\n <p>\n  This is from the nightclub challenge of the\n  <a href=\"https://ctf.perfect.blue/\" rel=\"nofollow noreferrer\">\n   pbctf 2021\n  </a>\n  .\n </p>\n <hr/>\n</div>\n</body></html>",
    "votes": "1",
    "answers": 1,
    "views": "357",
    "tags": [
        "kernel",
        "assembly"
    ],
    "user": "Pierre",
    "time": "Oct 23, 2021 at 8:52",
    "comments": [],
    "answers_data": [
        {
            "content": "<html><body><div class=\"s-prose js-post-body\" itemprop=\"text\">\n <p>\n  cdqe does this RAX ‚Üê sign-extend of EAX.\n  \n\n  applicable only in x64\n  \n\n  shown below is a demo of x86 cdq which instead of using rax uses eax,edx combo\nedx gets the sign extension  in x86\n </p>\n <p>\n  for cdqe register rax will become\n  <code>\n   0xffffffff<eax> or 0x00000000<eax>\n  </code>\n </p>\n <p>\n  <a href=\"https://i.sstatic.net/B0b8e.gif\" rel=\"nofollow noreferrer\">\n   <img alt=\"enter image description here\" src=\"https://i.sstatic.net/B0b8e.gif\"/>\n  </a>\n </p>\n <p>\n  maybe ctf is checking the sign\n </p>\n</div>\n</body></html>",
            "votes": "1",
            "user": "blabb",
            "time": "Oct 23, 2021 at 10:49",
            "is_accepted": false,
            "comments": []
        }
    ]
}