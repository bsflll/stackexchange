{
    "title": "POC for appleScript injection method",
    "link": "https://reverseengineering.stackexchange.com/questions/16725/poc-for-applescript-injection-method",
    "content": "<html><body><div class=\"s-prose js-post-body\" itemprop=\"text\">\n <p>\n  I am trying to make a POC of code injection using applescript injection technic which is used in GitHub project\n  <code>\n   EasySIMBL\n  </code>\n  .\n </p>\n <p>\n  The method also described\n  <a href=\"https://papers.put.as/papers/macosx/2014/ShakaCon6-FuckYouHackingTeam.pdf\" rel=\"nofollow noreferrer\">\n   here\n  </a>\n  .\n(It's basically a huge article, just search for AppleScript at bundle injection, and you’ll get there)\n </p>\n <p>\n  The steps I've done :\n </p>\n <ol>\n  <li>\n   I made a bundle suffix\n   <code>\n    osax\n   </code>\n   file that creates a file at\n   <code>\n    /tmp/test.txt\n   </code>\n   . The bundle contains the following items:\n  </li>\n </ol>\n <p>\n  1.1 Info.plist:\n </p>\n <pre><code><?xml version=“1.0” encoding=“UTF-8\"?>\n<!DOCTYPE plist PUBLIC “-//Apple//DTD PLIST 1.0//EN” “http://www.apple.com/DTDs/PropertyList-1.0.dtd“>\n<plist version=“1.0”>\n<dict>\n    <key>CFBundleDevelopmentRegion</key>\n    <string>English</string>\n    <key>CFBundleExecutable</key>\n    <string>OsaxLoaded</string>\n    <key>CFBundleIdentifier</key>\n    <string>com.yourcompany.OsaxLoaded</string>\n    <key>CFBundleInfoDictionaryVersion</key>\n    <string>6.0</string>\n    <key>CFBundleName</key>\n    <string>OsaxLoaded</string>\n    <key>CFBundlePackageType</key>\n    <string>osax</string>\n    <key>CFBundleShortVersionString</key>\n    <string>1.0</string>\n    <key>CFBundleSignature</key>\n    <string>ascr</string>\n    <key>CFBundleVersion</key>\n    <string>1</string>\n    <key>OSAScriptingDefinition</key>\n    <string>app.sdef</string>\n    <key>OSAXHandlers</key>\n    <dict>\n        <key>Events</key>\n        <dict>\n            <key>OPNeopen</key>\n            <dict>\n                <key>Context</key>\n                <string>Process</string>\n                <key>Handler</key>\n                <string>InjectEventHandler</string>\n                <key>ThreadSafe</key>\n                <true/>\n            </dict>\n        </dict>\n    </dict>\n</dict>\n</plist>\n</code></pre>\n <p>\n  1.2 The code to be injected (\n  <code>\n   osax\n  </code>\n  bundle):\n </p>\n <pre><code>//  main.m\n//  OsaxLoaded\n//\n//\n\n#import <Foundation/Foundation.h>\n\n__attribute__((visibility(“default”)))\nOSErr InjectEventHandler(const AppleEvent *ev, AppleEvent *reply, long refcon)\n{\n    OSErr resultCode = noErr;\n    [[NSFileManager defaultManager] createFileAtPath:@“/tmp/test.txt” contents:nil attributes:nil];\n    return resultCode;\n}\n</code></pre>\n <p>\n  Here's the structure of my\n  <code>\n   osax\n  </code>\n  bundle :\n </p>\n <pre><code>sh-3.2# ls /Library/ScriptingAdditions/OsaxLoaded.osax/Contents/\nInfo.plist    MacOS        _CodeSignature\n</code></pre>\n <p>\n  Now I put the\n  <code>\n   osax\n  </code>\n  bundle at /Library/ScriptingAdditions/\n </p>\n <p>\n  Then I wrote a templated Cocoa App (injection target) that does nothing (didn't add any additional code)\n </p>\n <p>\n  In addition I wrote a Mach-o that should make the app I wrote previously to load the script addition (osax bundle).\nAfter that it sends the event that corresponds to the event in info.plist and should execute the handler I wrote in the osax bundle Mach-o.\n </p>\n <p>\n  The injector code:\n </p>\n <pre><code>//  main.m\n//  OsaxInjector\n//\n//\n\n#import <Foundation/Foundation.h>\n#import <Carbon/Carbon.h>\n#import <ScriptingBridge/ScriptingBridge.h>\n\nint main(int argc, const char * argv[]) {\n    @autoreleasepool {\n        if (argc != 2)\n        {\n            printf(“USAGE: injector pid\n”);\n            return 1;\n        }\n        TEST *test = [[TEST alloc] init];\n        pid_t pid = atoi(argv[1]);\n        SBApplication* sbApp = [SBApplication applicationWithProcessIdentifier:pid];\n        [sbApp setSendMode:kAENoReply | kAENeverInteract | kAEDontRecord];\n        [sbApp sendEvent:kASAppleScriptSuite id:kGetAEUT parameters:0];\n\n        // Inject!\n        [sbApp setSendMode:kAENoReply | kAENeverInteract | kAEDontRecord];\n        id injectReply = [sbApp sendEvent:‘OPNe’ id:‘open’ parameters:0];\n        if (injectReply != nil) {\n            NSLog(@“unexpected injectReply: %@“, injectReply);\n        }\n        [[NSProcessInfo processInfo]disableSuddenTermination];\n    }\n    return 0;\n}\n</code></pre>\n <p>\n  When tested using the pid provided by\n  <code>\n   lsappinfo info “ToInjectApp”\n  </code>\n  , it seems like the code wasn't injected and\n  <code>\n   /tmp/test.txt\n  </code>\n  wasn't created.\n </p>\n <p>\n  any idea what I am doing wrong?\n </p>\n <p>\n  OS Version: Sierra\n </p>\n</div>\n</body></html>",
    "votes": "2",
    "answers": 0,
    "views": "317",
    "tags": [
        "osx",
        "injection"
    ],
    "user": "Zohar81",
    "time": "Nov 6, 2017 at 16:10",
    "comments": [],
    "answers_data": []
}