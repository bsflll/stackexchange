{
    "title": "How to do Global DLL injection",
    "link": "https://reverseengineering.stackexchange.com/questions/16319/how-to-do-global-dll-injection",
    "content": "<html><body><div class=\"s-prose js-post-body\" itemprop=\"text\">\n <p>\n  How can one go about injection of a DLL into every process? Can\n  <code>\n   SetwindowsHookEx()\n  </code>\n  do the trick? Does\n  <code>\n   AppInit_DLLs\n  </code>\n  work as it used to?\n </p>\n</div>\n</body></html>",
    "votes": "4",
    "answers": 2,
    "views": "4k",
    "tags": [
        "windows",
        "dll"
    ],
    "user": "Todd",
    "time": "Jun 5, 2018 at 13:47",
    "comments": [],
    "answers_data": [
        {
            "content": "<html><body><div class=\"s-prose js-post-body\" itemprop=\"text\">\n <p>\n  TLDR: No, no and no.\n </p>\n <p>\n  You have several questions hiding there in your post:\n </p>\n <ol>\n  <li>\n   Is is possible to inject a DLL into each and every process?\n  </li>\n  <li>\n   If it is possible, can the following methods do that:\n   <ol>\n    <li>\n     <code>\n      SetWindowsHookEx\n     </code>\n     ?\n    </li>\n    <li>\n     <code>\n      AppInit_Dlls\n     </code>\n     ?\n    </li>\n   </ol>\n  </li>\n </ol>\n <p>\n  The answer to the first question is \"no\".\n  \n\n  The answer to both parts of the second question is \"no, even if the answer to the first question had been yes\".\n </p>\n <h2>\n  <code>\n   SetWindowsHookEx\n  </code>\n  and\n  <code>\n   AppInit_Dlls\n  </code>\n </h2>\n <p>\n  Let's start from the second question. Both methods only apply to processes that load\n  <code>\n   user32.dll\n  </code>\n  . So that's already not \"every process\" which is what you asked.\n </p>\n <p>\n  On top of that is everything I mentioned in the comments to NirIzr's answer:\n </p>\n <ul>\n  <li>\n   <a href=\"https://msdn.microsoft.com/en-us/library/windows/desktop/dn280412(v=vs.85).aspx\" rel=\"nofollow noreferrer\">\n    Starting with Windows 8\n    <code>\n     AppInit_Dlls\n    </code>\n    are disabled\n   </a>\n   by default on machines with Secure Boot enabled (i.e. all real-world machines).\n  </li>\n  <li>\n   A process can opt-out from both methods by setting the\n   <a href=\"https://msdn.microsoft.com/en-us/library/windows/desktop/hh769088(v=vs.85).aspx\" rel=\"nofollow noreferrer\">\n    <code>\n     ProcessExtensionPointDisablePolicy\n    </code>\n   </a>\n   mitigation policy.\n  </li>\n </ul>\n <p>\n  Process that have\n  <code>\n   ProcessExtensionPointDisablePolicy\n  </code>\n  set include most Chrome processes (renderer, gpu, ppapi) and a few system processes (like\n  <code>\n   RuntimeBroker.exe\n  </code>\n  ), for example.\n </p>\n <p>\n  I don't think that this is merely a caveat. The question is can you inject into all processes, and the answer is no.\n </p>\n <h2>\n  DLL injection and loading in general\n </h2>\n <p>\n  But there are other ways to do DLL injection. What about them?\n  \n\n  This brings us back to the first question.\n </p>\n <p>\n  Since Windows Vista, some processes are \"protected processes\" for DRM reasons. See:\n </p>\n <ul>\n  <li>\n   <a href=\"https://www.microsoftpressstore.com/articles/article.aspx?p=2233328&seqNum=2\" rel=\"nofollow noreferrer\">\n    Protected Processes\n   </a>\n   (from Windows Internals 5th edition)\n  </li>\n  <li>\n   <a href=\"https://technet.microsoft.com/en-us/library/46ed60f1-e02c-48db-9eba-eddbd106d54f\" rel=\"nofollow noreferrer\">\n    Inside the Windows Vista Kernel: Part 3\n   </a>\n   (scroll to \"Protected Processes\")\n  </li>\n </ul>\n <p>\n  To load into these process you must be signed with a special certificate, which you probably don't have.\n </p>\n <p>\n  Since then Microsoft has expanded the protected process infrastructure more and more to include more processes and to allow third-party processes to be protected. See\n  <a href=\"https://msdn.microsoft.com/en-us/library/windows/desktop/dn313124(v=vs.85).aspx\" rel=\"nofollow noreferrer\">\n   Protecting Anti-Malware Services\n  </a>\n  .\n </p>\n <p>\n  There are different levels of protection, but to load into some of these processes you also have to be signed with a special certificate that you also don't have, and to load into the rest of them you need a certificate that you can't have (since Microsoft doesn't supply it to any third party).\n </p>\n <p>\n  Processes protected in that way are\n  <code>\n   smss.exe\n  </code>\n  ,\n  <code>\n   csrss.exe\n  </code>\n  ,\n  <code>\n   services.exe\n  </code>\n  , some instances of\n  <code>\n   svchost.exe\n  </code>\n  as well the processes for any AV that respects itself. You can't inject into those either,\n  <em>\n   regardless of method\n  </em>\n  (\n  <code>\n   SetWindowsHookEx\n  </code>\n  ,\n  <code>\n   AppInit_Dlls\n  </code>\n  , or something more robust that doesn't depend on\n  <code>\n   user32.dll\n  </code>\n  ).\n </p>\n <p>\n  Additionally, another mitigation policy,\n  <code>\n   ProcessSignaturePolicy\n  </code>\n  , available starting with Windows 10 can prevent loading of DLLs not signed by Microsoft, WHQL or the Windows Store. And unlike being a protected process which requires a certificate from Microsoft, any process can opt-in to\n  <code>\n   ProcessSignaturePolicy\n  </code>\n  .\n </p>\n <p>\n  Process that have this mitigation enabled include\n  <code>\n   WinStore.App.exe\n  </code>\n  (the Windows Store app itself, obviously),\n  <code>\n   MicrosoftEdgeCP.exe\n  </code>\n  (Store only),\n  <code>\n   csrss.exe\n  </code>\n  (Microsoft only),\n  <code>\n   wininit.exe\n  </code>\n  (Microsoft only) and\n  <code>\n   services.exe\n  </code>\n  (Microsoft only).\n </p>\n <p>\n  In summary: You can't\n  <em>\n   load\n  </em>\n  arbitrary DLLs into many processes, including by calling\n  <code>\n   LoadLibrary\n  </code>\n  from the program's own legitimate code. You can't inject DLLs into these processes, regardless of the method you use.\n </p>\n <p>\n  If you find a way to do this it would be a major subversion of the Windows 10 security mechanisms and such novelty is more likely to be presented in a professional conference rather than on the SE network.\n </p>\n <hr/>\n <p>\n  More links on Windows 8.1 Protected Processes, from Alex Ionescu's blog:\n </p>\n <ul>\n  <li>\n   <a href=\"https://www.alex-ionescu.com/?p=97\" rel=\"nofollow noreferrer\">\n    The Evolution of Protected Processes Part 1: Pass-the-Hash Mitigations in Windows 8.1\n   </a>\n  </li>\n  <li>\n   <a href=\"https://www.alex-ionescu.com/?p=116\" rel=\"nofollow noreferrer\">\n    The Evolution of Protected Processes Part 2: Exploit/Jailbreak Mitigations, Unkillable Processes and Protected Services\n   </a>\n  </li>\n  <li>\n   <a href=\"https://www.alex-ionescu.com/?p=146\" rel=\"nofollow noreferrer\">\n    Protected Processes Part 3 : Windows PKI Internals (Signing Levels, Scenarios, Root Keys, EKUs & Runtime Signers)\n   </a>\n  </li>\n </ul>\n</div>\n</body></html>",
            "votes": "7",
            "user": "Paul",
            "time": "Apr 8, 2022 at 17:56",
            "is_accepted": false,
            "comments": []
        },
        {
            "content": "<html><body><div class=\"s-prose js-post-body\" itemprop=\"text\">\n <p>\n  DLL injections is a big subject, but to answer your two specific questions:\n </p>\n <ol>\n  <li>\n   Yes,\n   <code>\n    SetwindowsHookEx\n   </code>\n   can inject to all\n   <em>\n    currently\n   </em>\n   running processes. This is done by providing the value of zero (\n   <code>\n    0\n   </code>\n   )  to the\n   <code>\n    dwThreadId\n   </code>\n   parameter.\n  </li>\n  <li>\n   Yes, generally\n   <code>\n    AppInit_DLLs\n   </code>\n   works on recent windows versions, however microsoft are working their way towards disabling and heavily limiting its usage. For example, since Windows 7, a registry value called\n   <code>\n    RequireSignedAppInit_DLLs\n   </code>\n   controls whether only code-signed DLLs are allowed to load. While the value is set to\n   <code>\n    0\n   </code>\n   (turned off) for Windows 7, it is on by default on windows 10. Furthermore, in Windows 8 (and above)\n   <code>\n    AppInit_DLLs\n   </code>\n   is automatically disabled (enable with  the\n   <code>\n    LoadAppInit_DLLs\n   </code>\n   registry value) on machines with secure boot.\n  </li>\n </ol>\n <p>\n  <strong>\n   EDIT:\n  </strong>\n </p>\n <p>\n  Both of these techniques are being phased out (or completely blocked) by multiple counter-measure features in Windows versions. They're not recommended (actually they are often discouraged by Microsoft itself) for legitimate software (or malware). Users are piling up caveats and restrictions in the comments, but for the sake of clarity and simplicity (and because there're numerous caveats here) I chose to only include a few.\n </p>\n</div>\n</body></html>",
            "votes": "4",
            "user": "0xC0000022L",
            "time": "Jun 5, 2018 at 13:50",
            "is_accepted": false,
            "comments": [
                {
                    "user": "Igor Skochinsky",
                    "text": "<span class=\"comment-copy\">BTW, <code>AppInit_DLLs</code> only works if the process loads <code>user32.dll</code>.</span>",
                    "time": null
                },
                {
                    "user": "conio",
                    "text": "<span class=\"comment-copy\">The <code>PROCESS_CREATION_MITIGATION_POLICY_EXTENSION_POINT_DISABLE_ALWAYS_ON</code> mitigation policy disables both <code>AppInit_Dlls</code> and global hooks.</span>",
                    "time": null
                },
                {
                    "user": "conio",
                    "text": "<span class=\"comment-copy\">Also, starting with Windows 8, <code>AppInit_Dlls</code> are disabled by default, regardless of signing, when secure boot is enabled. See <a href=\"https://msdn.microsoft.com/en-us/library/windows/desktop/dn280412(v=vs.85).aspx\" rel=\"nofollow noreferrer\">AppInit DLLs and Secure Boot</a>. You probably don't see this on VMs (unless you use Hyper-V), but real machines have Secure Boot enabled by default.</span>",
                    "time": null
                },
                {
                    "user": "NirIzr",
                    "text": "<span class=\"comment-copy\">Thanks, Added a paragraph to note there are many caveats, that those techniques are discouraged and refer to the comments for additional forewarnings.</span>",
                    "time": null
                }
            ]
        }
    ]
}