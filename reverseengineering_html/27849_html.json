{
    "title": "Checksum verification of an apk does not the same as my java program",
    "link": "https://reverseengineering.stackexchange.com/questions/27849/checksum-verification-of-an-apk-does-not-the-same-as-my-java-program",
    "content": "<html><body><div class=\"s-prose js-post-body\" itemprop=\"text\">\n <p>\n  I'm from the sysadmin side of the IT and have not much experience in programing.\n </p>\n <p>\n  I have an app that lets me screen share Android apps on my car's display.\nSadly there is a whitelist baked into the app, which prevents other apps (e.g. NewPipe) from running.\nI tought I would try reversing it. The modification of the whitelist is easy (.json) but there is some checksuming of the whitelist involved.\n </p>\n <p>\n  I did a decompilation with jadx-gui and backsmali, tried to modify the smali code and recompile it again.\nI did not know what exactly to change in the smali code, because I am not really familiar with it.\nThe method was try and error, but I always got errors.\nSo I thought I could alter the checksum for my modifyed whitelist, but that also did not work as intended.\n </p>\n <p>\n  I have extracted the code to run locally but the hash of the original file does not match the one, compiled into the apk and I'm not shure why\n </p>\n <p>\n  This is the jadx-gui reversed code snipped (exceptions removed):\n </p>\n <pre><code>    private boolean j() {\n    InputStream inputStream = null;\n    try {\n        if (!\"whitelist/whitelist\".equals(\"whitelist/whitelist\")) {\n            throw new IllegalArgumentException(\"the whitelist path has to be \\\"whitelist/whitelist\\\", to access the dexguard encrypted file.\");\n        }\n        InputStream open = this.b.getAssets().open(\"whitelist/whitelist\");\n        byte[] bArr = new byte[ACRAConstants.DEFAULT_BUFFER_SIZE_IN_BYTES];\n        MessageDigest instance = MessageDigest.getInstance(\"SHA-256\");\n        while (true) {\n            int read = open.read(bArr);\n            if (read <= 0) {\n                break;\n            }\n            instance.update(bArr, 0, read);\n        }\n        if (!String.format(\"%64s\", new BigInteger(1, instance.digest()).toString(16)).replace(' ', '0').equals(this.b.getString(o.h.whitelist_checksum))) {\n            Log.e(\"MS-LL:LiveServiceFact.\", \"Invalid whitelist!\");\n            if (open != null) {\n                try {\n                    open.close();\n                } catch (IOException e2) {\n                }\n            }\n            return false;\n        } else if (open == null) {\n            return true;\n        } else {\n            try {\n                open.close();\n                return true;\n            } catch (IOException e3) {\n                return true;\n            }\n        }\n</code></pre>\n <p>\n  The\n  <code>\n   ACRAConstants.DEFAULT_BUFFER_SIZE_IN_BYTES\n  </code>\n  is\n  <code>\n   8192\n  </code>\n  and the\n  <code>\n   o.h.whitelist_checksum\n  </code>\n  is\n  <code>\n   2131689879\n  </code>\n  , which is not a SHA-256 string.\n  \n\n  My checksum checker looks like this:\n </p>\n <pre><code>import java.io.File;\nimport java.io.IOException;\nimport java.io.FileInputStream;\nimport java.io.FileNotFoundException;\nimport java.io.InputStream;\nimport java.math.BigInteger;\nimport java.security.MessageDigest;\nimport java.security.NoSuchAlgorithmException;\n\nclass checksum {\n\npublic static void main(String[] args) {\n    try {\n        InputStream inputStream = null;\n        File file = new File(\"whitelist\");\n        int DEFAULT_BUFFER_SIZE_IN_BYTES = 8192;\n        int whitelist_checksum = 2131689879;\n\n        if (!\"whitelist/whitelist\".equals(\"whitelist/whitelist\")) {\n            throw new IllegalArgumentException(\"the whitelist path has to be \\\"whitelist/whitelist\\\", to access the dexguard encrypted file.\");\n        }\n        InputStream open = new FileInputStream(file);\n        byte[] bArr = new byte[DEFAULT_BUFFER_SIZE_IN_BYTES];\n        MessageDigest instance = MessageDigest.getInstance(\"SHA-256\");\n        while (true) {\n            int read = open.read(bArr);\n            if (read <= 0) {\n                break;\n            }\n            instance.update(bArr, 0, read);\n        }\n        System.out.println(String.format(\"%64s\", new BigInteger(1, instance.digest()).toString(16)).replace(' ', '0'));\n        if (!String.format(\"%64s\", new BigInteger(1, instance.digest()).toString(16)).replace(' ', '0').equals(Integer.toString(whitelist_checksum))) {\n            System.out.println(\"Invalid whitelist!\");\n        } else {\n            System.out.println(\"correct whitelist!\");\n        }\n    }\n    catch (FileNotFoundException ex){System.out.println(\"File not found\");}\n    catch (NoSuchAlgorithmException ex){System.out.println(\"Algorythm not found\");}\n    catch (IOException ex){System.out.println(\"IOException\");}\n}\n}\n</code></pre>\n <p>\n  But gives me\n  <code>\n   d9821f5190db1b21aabc58da45a802b529148bb8a952760c0ca4a6330817f174\n  </code>\n  as checksum of the extracted whitelist and not\n  <code>\n   2131689879\n  </code>\n  .\nWhere am I missing something?\n </p>\n <p>\n  Thanks in advance, Simon\n </p>\n</div>\n</body></html>",
    "votes": "0",
    "answers": 0,
    "views": "319",
    "tags": [
        "android",
        "java",
        "apk"
    ],
    "user": "Simon Sutter",
    "time": "Jun 15, 2021 at 18:24",
    "comments": [
        {
            "user": "Andrew T.",
            "text": "<html><body><span class=\"comment-copy\">\n <code>\n  this.b.getString(o.h.whitelist_checksum)\n </code>\n hints on\n <a href=\"https://developer.android.com/reference/android/content/Context#getString(int)\" rel=\"nofollow noreferrer\">\n  <code>\n   getString(int)\n  </code>\n </a>\n . Look for\n <a href=\"https://developer.android.com/guide/topics/resources/string-resource#String\" rel=\"nofollow noreferrer\">\n  String resources\n </a>\n instead.\n</span>\n</body></html>",
            "time": null
        },
        {
            "user": "Robert",
            "text": "<html><body><span class=\"comment-copy\">\n Smali code may be a bit \"bloated\" compared to Java but modifying it is easy. You just have to identify the\n <code>\n  if\n </code>\n statement that branches on the result of the equals comparison. Usually this should be an\n <code>\n  if-nez\n </code>\n or\n <code>\n  if-eqz\n </code>\n . Depending on if you want to keep the if or the else part just comment out that line or replace it with an\n <code>\n  goto\n </code>\n and delete the parameter from the if (only leave the jump target). That disables the SHA-checking of the whitelist.\n</span>\n</body></html>",
            "time": null
        },
        {
            "user": "Simon Sutter",
            "text": "<html><body><span class=\"comment-copy\">\n @AndrewT. I was able to find the checksum sting in the resources. Sadly I have used text search to find it and was not able to find out how\n <code>\n  2131689879\n </code>\n leads to resource.arsc/res/values/strings.xml. But I get the Idea of it. @Robert I did try to remove every\n <code>\n  if\n </code>\n in the smali\n <code>\n  j()\n </code>\n method one after another, but it did not work. Would be cool to remove the checksumming, but replace the string also works.\n</span>\n</body></html>",
            "time": null
        },
        {
            "user": "Robert",
            "text": "<html><body><span class=\"comment-copy\">\n Do not just remove all if commands, only remove the one you want to skip. Jadx provides both Java and Smali view, switch between them and map Java code to Smali code do identify which if statement to modify (remove or replace with permanent branch). The\n <code>\n  BigInteger\n </code>\n usage should be a good place to start as it is close to the conditional branch and it is only used right before that point.\n</span>\n</body></html>",
            "time": null
        }
    ],
    "answers_data": []
}