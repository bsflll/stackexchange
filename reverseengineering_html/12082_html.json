{
    "title": "Trying to call function in process via DLL injection, need help in IDA if possible",
    "link": "https://reverseengineering.stackexchange.com/questions/12082/trying-to-call-function-in-process-via-dll-injection-need-help-in-ida-if-possib",
    "content": "<html><body><div class=\"s-prose js-post-body\" itemprop=\"text\">\n <p>\n  I'm trying to create a bot for a game called \"\n  <a href=\"http://mwomercs.com/\" rel=\"nofollow noreferrer\">\n   Mech Warrior Online\n  </a>\n  \". I've just completed my DLL injector which I want to use as mean to call function from the MWO client such as (fire, move, look around, etc...).\n </p>\n <p>\n  My problem is that I'm not great at reverse engineering, I'm trying hard to learn with tutorials, but I haven't found a particular one which addresses my problem.\n </p>\n <p>\n  So here goes, by using IDA and looking at strings, I've found this:\n  <a href=\"https://i.sstatic.net/daQb7.png\" rel=\"nofollow noreferrer\">\n   <img alt=\"Strings window\" src=\"https://i.sstatic.net/daQb7.png\"/>\n  </a>\n </p>\n <p>\n  Fire1 through Fire6 are most likely related to shooting weapons group 1-6. So if I click on it I get this;\n  <a href=\"https://i.sstatic.net/I7QDS.png\" rel=\"nofollow noreferrer\">\n   <img alt=\"The function responsible for a bunch of stuff !\" src=\"https://i.sstatic.net/I7QDS.png\"/>\n  </a>\n </p>\n <p>\n  Now this function looks very interesting, seems to control the power on/off of the mech, jumpjets, turning, throttle, weapons firing etc.\n </p>\n <p>\n  My problem is that I'd like to call this function to fire the weapons, but I can't seem to figure out how. I did some tutorials where I was able to inject my dll and call functions remotely via exports. But this function is very complex (in my opinion). Here's a look inside:\n </p>\n <pre><code>int __stdcall sub_37FC7C90(int a1)\n{\n  int result; // eax@5\n  int v2; // edx@5\n  int v3; // [sp+14h] [bp-4h]@2\n\n  int result; // eax@5\n\n  int v2; // edx@5\n  int v3; // [sp+14h] [bp-4h]@2\n\n  if ( !(dword_38CB3580 & 1) )\n  {\n    dword_38CB3580 |= 1u;\n    dword_38CB33F8 = (unsigned int)&unk_389BAE80 | 1;\n    LOBYTE(v3) = 1;\n    dword_38CB33E8 = (int)\"Enabled\";\n    dword_38CB33EC = 0;\n    dword_38CB33F0 = (int)szAgent;\n    dword_38CB33F4 = 0;\n\n\n(*(void (__cdecl **)(_UNKNOWN *, int *))((((unsigned int)&unk_389BAE80 | 1) & 0xFFFFFFFC) + 0xC))(\n      &unk_38CB33FC,\n      &v3);\n\n\n(*(void (__cdecl **)(int *))((((unsigned int)&unk_389BAE80 | 1) & 0xFFFFFFFC) + 4))(&v3);\n    dword_38CB3410 = (unsigned int)&unk_389BAF54 | 1;\n    v3 = 0;\n    dword_38CB3400 = (int)\"Throttle\";\n    dword_38CB3404 = 0;\n    dword_38CB3408 = (int)szAgent;\n    dword_38CB340C = 0;\n(*(void (__cdecl **)(_UNKNOWN *, int *))((((unsigned int)&unk_389BAF54 | 1) & 0xFFFFFFFC) + 0xC))(\n      &unk_38CB3414,\n      &v3);\n(*(void (__cdecl **)(int *))((((unsigned int)&unk_389BAF54 | 1) & 0xFFFFFFFC) + 4))(&v3);\n    dword_38CB3428 = (unsigned int)&unk_389BAF54 | 1;\n    v3 = 0;\n    dword_38CB3418 = (int)\"Turn\";\n    dword_38CB341C = 0;\n    dword_38CB3420 = (int)szAgent;\n    dword_38CB3424 = 0;\n(*(void (__cdecl **)(_UNKNOWN *, int *))((((unsigned int)&unk_389BAF54 | 1) & 0xFFFFFFFC) + 0xC))(\n      &unk_38CB342C,\n      &v3);\n(*(void (__cdecl **)(int *))((((unsigned int)&unk_389BAF54 | 1) & 0xFFFFFFFC) + 4))(&v3);\n    dword_38CB3440 = (unsigned int)&unk_389BB168 | 1;\n    v3 = 0;\n    dword_38CB3430 = (int)\"TurnTarget\";\n    dword_38CB3434 = 0;\n    dword_38CB3438 = (int)szAgent;\n    dword_38CB343C = 0;\n(*(void (__cdecl **)(_UNKNOWN *, int *))((((unsigned int)&unk_389BB168 | 1) & 0xFFFFFFFC) + 0xC))(\n      &unk_38CB3444,\n      &v3);\n(*(void (__cdecl **)(int *))((((unsigned int)&unk_389BB168 | 1) & 0xFFFFFFFC) + 4))(&v3);\n    dword_38CB3458 = (unsigned int)&unk_389BB168 | 1;\n    v3 = 0;\n    dword_38CB3448 = (int)\"LookTarget\";\n    dword_38CB344C = 0;\n    dword_38CB3450 = (int)szAgent;\n    dword_38CB3454 = 0;\n(*(void (__cdecl **)(_UNKNOWN *, int *))((((unsigned int)&unk_389BB168 | 1) & 0xFFFFFFFC) + 0xC))(\n      &unk_38CB345C,\n      &v3);\n(*(void (__cdecl **)(int *))((((unsigned int)&unk_389BB168 | 1) & 0xFFFFFFFC) + 4))(&v3);\n    dword_38CB3470 = (unsigned int)&unk_389BAE80 | 1;\n    LOBYTE(v3) = 0;\n    dword_38CB3460 = (int)\"JumpJet\";\n    dword_38CB3464 = 0;\n    dword_38CB3468 = (int)szAgent;\n    dword_38CB346C = 0;\n(*(void (__cdecl **)(_UNKNOWN *, int *))((((unsigned int)&unk_389BAE80 | 1) & 0xFFFFFFFC) + 0xC))(\n      &unk_38CB3474,\n      &v3);\n(*(void (__cdecl **)(int *))((((unsigned int)&unk_389BAE80 | 1) & 0xFFFFFFFC) + 4))(&v3);\n    dword_38CB3488 = (int)&unk_389BAE60;\n    dword_38CB3478 = (int)\"PowerOn\";\n    dword_38CB347C = 0;\n    dword_38CB3480 = (int)szAgent;\n    dword_38CB3484 = 0;\n(*(void (__cdecl **)(_UNKNOWN *, int *))(((unsigned int)&unk_389BAE60 & 0xFFFFFFFC) + 12))(&unk_38CB348C, &v3);\n(*(void (__cdecl **)(int *))(((unsigned int)&unk_389BAE60 & 0xFFFFFFFC) + 4))(&v3);\n    dword_38CB34A0 = (int)&unk_389BAE60;\n    dword_38CB3490 = (int)\"PowerOff\";\n    dword_38CB3494 = 0;\n    dword_38CB3498 = (int)szAgent;\n    dword_38CB349C = 0;\n(*(void (__cdecl **)(_UNKNOWN *, int *))(((unsigned int)&unk_389BAE60 & 0xFFFFFFFC) + 12))(&unk_38CB34A4, &v3);\n(*(void (__cdecl **)(int *))(((unsigned int)&unk_389BAE60 & 0xFFFFFFFC) + 4))(&v3);\n    dword_38CB34B8 = (int)&unk_389BAE60;\n    dword_38CB34A8 = (int)\"TogglePower\";\n    dword_38CB34AC = 0;\n    dword_38CB34B0 = (int)szAgent;\n    dword_38CB34B4 = 0;\n(*(void (__cdecl **)(_UNKNOWN *, _DWORD))(((unsigned int)&unk_389BAE60 & 0xFFFFFFFC) + 12))(&unk_38CB34BC, &v3);\n(*(void (__cdecl **)(_DWORD))(((unsigned int)&unk_389BAE60 & 0xFFFFFFFC) + 4))(&v3);\n    dword_38CB34D0 = (int)&unk_389BAE60;\n    dword_38CB34C0 = (int)\"ToggleWeaponDoors\";\n    dword_38CB34C4 = 0;\n    dword_38CB34C8 = (int)szAgent;\n    dword_38CB34CC = 0;\n(*(void (__cdecl **)(_UNKNOWN *, _DWORD))(((unsigned int)&unk_389BAE60 & 0xFFFFFFFC) + 12))(&unk_38CB34D4, &v3);\n(*(void (__cdecl **)(_DWORD))(((unsigned int)&unk_389BAE60 & 0xFFFFFFFC) + 4))(&v3);\n    dword_38CB34E8 = (unsigned int)&unk_389BAE80 | 1;\n    LOBYTE(v3) = 0;\n    dword_38CB34D8 = (int)\"Fire1\";\n    dword_38CB34DC = 0;\n    dword_38CB34E0 = (int)szAgent;\n    dword_38CB34E4 = 0;\n(*(void (__cdecl **)(_UNKNOWN *, _DWORD))((((unsigned int)&unk_389BAE80 | 1) & 0xFFFFFFFC) + 0xC))(\n      &unk_38CB34EC,\n      &v3);\n(*(void (__cdecl **)(_DWORD))((((unsigned int)&unk_389BAE80 | 1) & 0xFFFFFFFC) + 4))(&v3);\n    dword_38CB3500 = (unsigned int)&unk_389BAE80 | 1;\n    LOBYTE(v3) = 0;\n    dword_38CB34F0 = (int)\"Fire2\";\n    dword_38CB34F4 = 0;\n    dword_38CB34F8 = (int)szAgent;\n    dword_38CB34FC = 0;\n(*(void (__cdecl **)(_UNKNOWN *, _DWORD))((((unsigned int)&unk_389BAE80 | 1) & 0xFFFFFFFC) + 0xC))(\n      &unk_38CB3504,\n      &v3);\n(*(void (__cdecl **)(_DWORD))((((unsigned int)&unk_389BAE80 | 1) & 0xFFFFFFFC) + 4))(&v3);\n    dword_38CB3518 = (unsigned int)&unk_389BAE80 | 1;\n    LOBYTE(v3) = 0;\n    dword_38CB3508 = (int)\"Fire3\";\n    dword_38CB350C = 0;\n    dword_38CB3510 = (int)szAgent;\n    dword_38CB3514 = 0;\n(*(void (__cdecl **)(_UNKNOWN *, _DWORD))((((unsigned int)&unk_389BAE80 | 1) & 0xFFFFFFFC) + 0xC))(\n      &unk_38CB351C,\n      &v3);\n(*(void (__cdecl **)(_DWORD))((((unsigned int)&unk_389BAE80 | 1) & 0xFFFFFFFC) + 4))(&v3);\n    dword_38CB3530 = (unsigned int)&unk_389BAE80 | 1;\n    LOBYTE(v3) = 0;\n    dword_38CB3520 = (int)\"Fire4\";\n    dword_38CB3524 = 0;\n    dword_38CB3528 = (int)szAgent;\n    dword_38CB352C = 0;\n(*(void (__cdecl **)(_UNKNOWN *, _DWORD))((((unsigned int)&unk_389BAE80 | 1) & 0xFFFFFFFC) + 0xC))(\n      &unk_38CB3534,\n      &v3);\n(*(void (__cdecl **)(_DWORD))((((unsigned int)&unk_389BAE80 | 1) & 0xFFFFFFFC) + 4))(&v3);\n    dword_38CB3548 = (unsigned int)&unk_389BAE80 | 1;\n    LOBYTE(v3) = 0;\n    dword_38CB3538 = (int)\"Fire5\";\n    dword_38CB353C = 0;\n    dword_38CB3540 = (int)szAgent;\n    dword_38CB3544 = 0;\n(*(void (__cdecl **)(_UNKNOWN *, _DWORD))((((unsigned int)&unk_389BAE80 | 1) & 0xFFFFFFFC) + 0xC))(\n      &unk_38CB354C,\n      &v3);\n(*(void (__cdecl **)(_DWORD))((((unsigned int)&unk_389BAE80 | 1) & 0xFFFFFFFC) + 4))(&v3);\n    dword_38CB3560 = (unsigned int)&unk_389BAE80 | 1;\n    LOBYTE(v3) = 0;\n    dword_38CB3550 = (int)\"Fire6\";\n    dword_38CB3554 = 0;\n    dword_38CB3558 = (int)szAgent;\n    dword_38CB355C = 0;\n(*(void (__cdecl **)(_UNKNOWN *, _DWORD))((((unsigned int)&unk_389BAE80 | 1) & 0xFFFFFFFC) + 0xC))(\n      &unk_38CB3564,\n      &v3);\n    (*(void (__cdecl **)(_DWORD))((((unsigned int)&unk_389BAE80 | 1) & 0xFFFFFFFC) + 4))(&v3);\n    dword_38CB3568 = 0;\n    dword_38CB356C = 0;\n    dword_38CB3570 = 0;\n    dword_38CB3574 = 0;\n    dword_38CB357C = 0;\n    dword_38CB3578 = (int)&unk_389BAEA0;\n    atexit(sub_386F1FC0);\n  }\n  if ( !(dword_38CB3580 & 2) )\n  {\n    dword_38CB3580 |= 2u;\n    dword_38CB33D4 = 0;\n    dword_38CB33D8 = 0;\n    dword_38CB33DC = 0;\n    dword_38CB33E0 = 0;\n  }\n  result = a1;\n  v2 = *(_DWORD *)(a1 + 8);\n  *(_DWORD *)(a1 + 12) = szAgent;\n  *(_DWORD *)a1 = &dword_38CB33E8;\n  *(_DWORD *)(a1 + 4) = &dword_38CB33D4;\n  *(_DWORD *)(a1 + 8) = v2 & 0xFFFFF01F | 0x11;\n  return result;\n}\n</code></pre>\n <p>\n  I'm sorry, I know it's very messy, but the function is pretty big.\n </p>\n <p>\n  Anybody could tell me how to call let's say\n  <code>\n   Fire1\n  </code>\n  from my DLL? I really have no idea how to do it at this point. I know I'm totally over my head, but I'd like to learn!\n </p>\n <p>\n  Thx to anyone willing to lend a hand!\nCheers\n </p>\n</div>\n</body></html>",
    "votes": "3",
    "answers": 1,
    "views": "840",
    "tags": [
        "ida",
        "debugging",
        "c++"
    ],
    "user": "TheTurp",
    "time": "Sep 17, 2016 at 11:43",
    "comments": [
        {
            "user": "Jason Geffner",
            "text": "<html><body><span class=\"comment-copy\">\n That function is an object constructor. It doesn't\n <i>\n  \"control the power on/off of the mech, jumpjets, turning, throttle, weapons firing etc.\"\n </i>\n , nor will calling it\n <i>\n  \"fire the weapons\"\n </i>\n .\n</span>\n</body></html>",
            "time": null
        },
        {
            "user": "TheTurp",
            "text": "<html><body><span class=\"comment-copy\">\n Hey thx for the quick reply. So could I use this to find the function which triggers firing ? Or it's pretty useless. Thx again.\n</span>\n</body></html>",
            "time": null
        },
        {
            "user": "rev",
            "text": "<html><body><span class=\"comment-copy\">\n You can call a function\n <a href=\"http://reverseengineering.stackexchange.com/questions/10753/mov-ecx-arg-how-to-replicate-in-c/10754#10754\">\n  like this\n </a>\n . The answer is for\n <code>\n  __usercall\n </code>\n s, but it's very easily adaptable to\n <code>\n  __stdcall\n </code>\n s.\n</span>\n</body></html>",
            "time": null
        }
    ],
    "answers_data": [
        {
            "content": "<html><body><div class=\"s-prose js-post-body\" itemprop=\"text\">\n <p>\n  This function initializes an global object, if it's not already initialized, and returns it to the caller.\n </p>\n <p>\n  It seems that object has an array of a structure, and that structure describes what you consider actions the player can take.\nIt looks like part of the initialization is setting a callable function to each structure instance.\n </p>\n <p>\n  Here are the few things i think you can do next:\n </p>\n <ol>\n  <li>\n   <p>\n    Understand those functions initialized with each action structure. I would recommend you set a breakpoint on each of those functions and see that it's actually triggered once the player performs that action, to validate that function is indeed involved in the action.\n   </p>\n  </li>\n  <li>\n   <p>\n    Find all references to the object's range of addresses and understand the usage of that object.\n   </p>\n  </li>\n  <li>\n   <p>\n    Ditch those strings (as they're usually not easily related to the actions themselves in games) and instead follow key presses, like explained in\n    <a href=\"https://reverseengineering.stackexchange.com/a/13350/2147\">\n     this answer\n    </a>\n    .\n   </p>\n  </li>\n </ol>\n <p>\n  <a href=\"https://reverseengineering.stackexchange.com/questions/8762/finding-a-certain-function-in-gamets4/11133#11133\">\n   This question\n  </a>\n  could also be useful.\n </p>\n</div>\n</body></html>",
            "votes": "1",
            "user": "Community",
            "time": "Apr 13, 2017 at 12:49",
            "is_accepted": false,
            "comments": []
        }
    ]
}