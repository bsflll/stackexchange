{
    "title": "Multiple vendors Misfortune Cookie Router Authentication Bypass Exploit",
    "link": "https://reverseengineering.stackexchange.com/questions/12590/multiple-vendors-misfortune-cookie-router-authentication-bypass-exploit",
    "content": "<html><body><div class=\"s-prose js-post-body\" itemprop=\"text\">\n <p>\n  I am working on an exploit over a month now I have a problem and cannot go further.\n </p>\n <p>\n  here is the link of the exploit:\n </p>\n <p>\n  <a href=\"https://gist.github.com/doorbash/f454c698f192a0e5d1bf4da9c6869b67\" rel=\"nofollow noreferrer\">\n   https://gist.github.com/doorbash/f454c698f192a0e5d1bf4da9c6869b67\n  </a>\n </p>\n <p>\n  <a href=\"https://www.exploit-db.com/exploits/39739\" rel=\"nofollow noreferrer\">\n   https://www.exploit-db.com/exploits/39739\n  </a>\n </p>\n <h1>\n  Description:\n </h1>\n <p>\n  Misfortune Cookie is a critical vulnerability that allows an intruder to remotely take over an Internet router and use it to attack home and business networks.With a few magic cookies added to your request you bypass any authentication and browse the configuration interface as admin, from any open port.\n </p>\n <p>\n  ‌By sending\n  <strong>\n   <code>\n    Cxxx=yyy\n   </code>\n  </strong>\n  cookie to the router web interface\n  <strong>\n   <code>\n    yyy\n   </code>\n  </strong>\n  will be saved at memory address\n  <strong>\n   <code>\n    xxx * 0x28 + Offset\n   </code>\n  </strong>\n  .If we find\n  <strong>\n   <code>\n    Authentication Enable/Disable boolean address\n   </code>\n  </strong>\n  and\n  <strong>\n   <code>\n    offset\n   </code>\n  </strong>\n  we can add data for this firmware to the exploit's target list and bypass the authentication by sending the right cookie.\n </p>\n <h1>\n  How I analyzed the firmwares:\n </h1>\n <p>\n  The firmware I analyzed at first is\n  <strong>\n   TP-Link 8901G V3 3.0.1 Build 100901 Rel.23594\n  </strong>\n  .\n  <a href=\"http://dl.2dclp.ir/doorbash.ir/mce/3.0.1%20Build%20100901%20Rel.23594\" rel=\"nofollow noreferrer\">\n   download it here\n  </a>\n  and run\n  <code>\n   binwalk -e V3 3.0.1 Build 100901 Rel.23594\n  </code>\n  then open the largest file in extracted directory using IDA by selecting\n  <code>\n   mipsb\n  </code>\n  as the cpu architecture and\n  <code>\n   0x80020000\n  </code>\n  for base address.\n </p>\n <p>\n  If you search for\n  <strong>\n   Do not need\n  </strong>\n  string using Alt+T keys you will find a\n  <strong>\n   sb XXXX($gp)\n  </strong>\n  at the very first lines of the code you realize the\n  <strong>\n   li $gp,YYYYY\n  </strong>\n  instruction. the authentication address will be located by adding\n  <strong>\n   XXXX and YYYYY\n  </strong>\n  which in this case will be\n  <strong>\n   0x803E1829\n  </strong>\n </p>\n <p>\n  Now we must discover how\n  <code>\n   Cookie: CNNNN=MMM;\n  </code>\n  alter memory contents:\nif you search for \"soapaction\" using Alt+T you will find this:\n </p>\n <p>\n  <a href=\"https://i.sstatic.net/rDv05.jpg\" rel=\"nofollow noreferrer\">\n   <img alt=\"\" src=\"https://i.sstatic.net/rDv05.jpg\"/>\n  </a>\n </p>\n <p>\n  Go to the sub process highlighted by red color.\n </p>\n <p>\n  <a href=\"https://i.sstatic.net/bBWLw.jpg\" rel=\"nofollow noreferrer\">\n   <img alt=\"\" src=\"https://i.sstatic.net/bBWLw.jpg\"/>\n  </a>\n </p>\n <p>\n  Now consider the number 0x6b28 as\n  <strong>\n   <code>\n    A = 0x6B28\n   </code>\n  </strong>\n </p>\n <p>\n  Now back and toward up:\n </p>\n <p>\n  <a href=\"https://i.sstatic.net/7DReD.jpg\" rel=\"nofollow noreferrer\">\n   <img alt=\"\" src=\"https://i.sstatic.net/7DReD.jpg\"/>\n  </a>\n </p>\n <p>\n  Now go to the top sub process:\n </p>\n <p>\n  <a href=\"https://i.sstatic.net/99wie.jpg\" rel=\"nofollow noreferrer\">\n   <img alt=\"\" src=\"https://i.sstatic.net/99wie.jpg\"/>\n  </a>\n </p>\n <p>\n  you will find this:\n </p>\n <p>\n  <a href=\"https://i.sstatic.net/O8nNw.jpg\" rel=\"nofollow noreferrer\">\n   <img alt=\"\" src=\"https://i.sstatic.net/O8nNw.jpg\"/>\n  </a>\n </p>\n <p>\n  now\n  <strong>\n   <code>\n    B = 0xA44\n   </code>\n  </strong>\n  ,\n  <strong>\n   <code>\n    C = 0x1887C\n   </code>\n  </strong>\n  and\n  <strong>\n   <code>\n    D = 0x8041877C\n   </code>\n  </strong>\n  .\n </p>\n <p>\n  and\n  <strong>\n   <code>\n    MAGIC_NUMBER = 0x16B88\n   </code>\n  </strong>\n  (I don't have any idea why but it works)\n </p>\n <p>\n  Now\n  <strong>\n   <code>\n    OFFSET = A - B + C + D - MAGIC_NUMBER = 0x80420554\n   </code>\n  </strong>\n </p>\n <p>\n  now call\n  <strong>\n   <code>\n    info(calc(0x8041877C,0x1887c,0xa44,0x6B28,0x16b88),0x803E1829)\n   </code>\n  </strong>\n  or\n  <strong>\n   <code>\n    info(0x80420554,0x803E1829)\n   </code>\n  </strong>\n  in\n  <a href=\"http://dl.2dclp.ir/doorbash.ir/mce/util.py\" rel=\"nofollow noreferrer\">\n   util.py\n  </a>\n  I attached the output is\n  <strong>\n   <code>\n    ,107367749,13\n   </code>\n  </strong>\n  which is the data we need for this firmware in the exploit.\n </p>\n <p>\n  the process is very similar (and different and also easier in the\n  <strong>\n   TP-Link W8961ND V3 120830\n  </strong>\n  <a href=\"http://dl.2dclp.ir/doorbash.ir/mce/TD-W8961ND_V3_120830_FI\" rel=\"nofollow noreferrer\">\n   download it here\n  </a>\n </p>\n <p>\n  <a href=\"https://i.sstatic.net/iXovp.jpg\" rel=\"nofollow noreferrer\">\n   <img alt=\"\" src=\"https://i.sstatic.net/iXovp.jpg\"/>\n  </a>\n </p>\n <pre><code>AuthenticationAddress = 0x803605B4\nA = 0x6B28\nB = 0x0 (move    $a0, $s1)\nC = 0x17E38\nD = 0x804234C8\nMAGIC_NUMBER = 0x16B88\nOFFSET = A-B+C+D-MAGIC_NUMBER = 0x8042B2A0\n</code></pre>\n <p>\n  We call\n  <strong>\n   <code>\n    info(0x8042B2A0,0x803605B4)\n   </code>\n  </strong>\n  in\n  <a href=\"http://dl.2dclp.ir/doorbash.ir/mce/util.py\" rel=\"nofollow noreferrer\">\n   util.py\n  </a>\n  and output is\n  <strong>\n   <code>\n    ,107353414,36\n   </code>\n  </strong>\n  which is tested on real device and works.\n </p>\n <h1>\n  THE PROBLEM IS:\n </h1>\n <p>\n  for\n  <strong>\n   TD_W961ND_V3_140305\n  </strong>\n  <a href=\"http://dl.2dclp.ir/doorbash.ir/mce/TD-W8961ND_V3_140305\" rel=\"nofollow noreferrer\">\n   download it here\n  </a>\n  the firmware has\n  <strong>\n   \"Do not need\"\n  </strong>\n  and\n  <strong>\n   \"soapacation\"\n  </strong>\n  texts but IDA cannot find the pointing addresses to these strings.I could not find out why.\n </p>\n <p>\n  The modifications and bug fixes for this according to\n  <a href=\"http://www.tp-link.com/en/download/TD-W8961ND_V3.html#Firmware\" rel=\"nofollow noreferrer\">\n   here\n  </a>\n  is :\n </p>\n <ol>\n  <li>\n   <p>\n    <strong>\n     Add the security mechanism.\n    </strong>\n   </p>\n  </li>\n  <li>\n   <p>\n    Fixed the problem router's time can't synchronize from PC successfully.\n   </p>\n  </li>\n  <li>\n   <p>\n    Banned accessing the firmware upgrading page from WAN.\n   </p>\n  </li>\n  <li>\n   <p>\n    Fixed the problem that router failed to upload rom-0(Backup configuration).\n   </p>\n  </li>\n  <li>\n   <p>\n    Solved the problem that the login interface can't save the password correctly in Chrome and Firefox.\n   </p>\n  </li>\n  <li>\n   <p>\n    Solved the problem that we can’t visit CPE using “IP:Port” after we set up Virtual Server.\n   </p>\n  </li>\n  <li>\n   <p>\n    Forbidden access to the device through\n    <a href=\"http://wan/lan\" rel=\"nofollow noreferrer\">\n     http://wan/lan\n    </a>\n    ip/ or\n    <a href=\"http://wan/lan\" rel=\"nofollow noreferrer\">\n     http://wan/lan\n    </a>\n    ip/xxx.htm.\n   </p>\n  </li>\n  <li>\n   <p>\n    Fixed other bugs and problems.\n   </p>\n  </li>\n </ol>\n <p>\n  I am not sure if the security mechanism (#1) is what is making this issue or not.\n </p>\n <p>\n  I also tried to compare 100901, 120830 and 140305 using binwalk entropy:\n </p>\n <h1>\n  binwalk -E -J 120830 140305 100901\n </h1>\n <h1>\n  100901:\n </h1>\n <p>\n  <a href=\"https://i.sstatic.net/FEcZb.png\" rel=\"nofollow noreferrer\">\n   <img alt=\"\" src=\"https://i.sstatic.net/FEcZb.png\"/>\n  </a>\n </p>\n <h1>\n  120830:\n </h1>\n <p>\n  <a href=\"https://i.sstatic.net/XnGjQ.png\" rel=\"nofollow noreferrer\">\n   <img alt=\"\" src=\"https://i.sstatic.net/XnGjQ.png\"/>\n  </a>\n </p>\n <h1>\n  140305:\n </h1>\n <p>\n  <a href=\"https://i.sstatic.net/KRDUz.png\" rel=\"nofollow noreferrer\">\n   <img alt=\"\" src=\"https://i.sstatic.net/KRDUz.png\"/>\n  </a>\n </p>\n <p>\n  I know somethings wrong with\n  <strong>\n   140305\n  </strong>\n  (unusual wave forms at left) but could not come across any findings.\n </p>\n <h1>\n  Update 1:\n </h1>\n <p>\n  Here is how memory address\n  <code>\n   0x800D53BC\n  </code>\n  looks like in my IDA:\n </p>\n <p>\n  <a href=\"https://i.sstatic.net/WHYi9.jpg\" rel=\"nofollow noreferrer\">\n   <img alt=\"\" src=\"https://i.sstatic.net/WHYi9.jpg\"/>\n  </a>\n </p>\n <p>\n  Any idea or tip about how to fix this mess?\n </p>\n <p>\n  <a href=\"https://i.sstatic.net/hlmok.jpg\" rel=\"nofollow noreferrer\">\n   <img alt=\"\" src=\"https://i.sstatic.net/hlmok.jpg\"/>\n  </a>\n </p>\n</div>\n</body></html>",
    "votes": "4",
    "answers": 1,
    "views": "737",
    "tags": [
        "ida",
        "disassembly",
        "firmware"
    ],
    "user": "doorbash",
    "time": "Feb 25, 2018 at 9:34",
    "comments": [],
    "answers_data": [
        {
            "content": "<html><body><div class=\"s-prose js-post-body\" itemprop=\"text\">\n <p>\n  According to\n  <a href=\"http://www.tp-link.com/en/download/TD-W8961ND_V3.html#Firmware\" rel=\"nofollow noreferrer\">\n   TP-LINK\n  </a>\n  the misfortune cookie was fixed only in firmware version TD-W8961ND_V3_150707. So, the TD_W961ND_V3_140305 is also vulnerable.\n </p>\n <p>\n  Since it is a binary file you may not analyse the code part dealing with the\n  <code>\n   soapaction\n  </code>\n  string, but here is what I found for firmware 140305:\n </p>\n <p>\n  <a href=\"https://i.sstatic.net/kEFxG.png\" rel=\"nofollow noreferrer\">\n   <img alt=\"enter image description here\" src=\"https://i.sstatic.net/kEFxG.png\"/>\n  </a>\n </p>\n <p>\n  UPDATE!\n </p>\n <p>\n  You can find the \"Do not need\" string at\n  <code>\n   0x801a015a\n  </code>\n  . For some reasons it is mips16 code and was referenced only from the command table as the\n  <code>\n   pswauthen\n  </code>\n  command handler. So, you have to change the code representation to mips16 with\n  <code>\n   alt+g\n  </code>\n  at the start of the handler and then press\n  <code>\n   c\n  </code>\n  .\n </p>\n <p>\n  <a href=\"https://i.sstatic.net/swtf7.png\" rel=\"nofollow noreferrer\">\n   <img alt=\"enter image description here\" src=\"https://i.sstatic.net/swtf7.png\"/>\n  </a>\n </p>\n</div>\n</body></html>",
            "votes": "2",
            "user": "ebux",
            "time": "May 5, 2016 at 8:37",
            "is_accepted": true,
            "comments": [
                {
                    "user": "doorbash",
                    "text": "<span class=\"comment-copy\">Please see Update 1 in the question. thanks.</span>",
                    "time": null
                },
                {
                    "user": "ebux",
                    "text": "<span class=\"comment-copy\">I don't know why IDA could not found ASCII in your case, but you can use 'a' (create ASCII) to create strings or you may create a simple script, which does this job.</span>",
                    "time": null
                },
                {
                    "user": "doorbash",
                    "text": "<span class=\"comment-copy\">Thanks, what about \"Do not need\" string? any idea why there is no pointing address to it?</span>",
                    "time": null
                },
                {
                    "user": "ebux",
                    "text": "<span class=\"comment-copy\">See the update in my answer.</span>",
                    "time": null
                },
                {
                    "user": "doorbash",
                    "text": "<span class=\"comment-copy\">I saw it unfortunately I could not do what you did in update. IDA 6.8 still shows garbage, but well done I will set it as best answer when I worked on it again and managed to do it, thanks for your time. What version of IDA you got?</span>",
                    "time": null
                }
            ]
        }
    ]
}