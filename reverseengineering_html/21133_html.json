{
    "title": "GetWindowLongPtr with undocumented nIndex of -1",
    "link": "https://reverseengineering.stackexchange.com/questions/21133/getwindowlongptr-with-undocumented-nindex-of-1",
    "content": "<html><body><div class=\"s-prose js-post-body\" itemprop=\"text\">\n <p>\n  I'm trying to reverse functionality of scrollbars in\n  <code>\n   comctrl32.dll\n  </code>\n  and I keep witnessing them calling\n  <a href=\"https://docs.microsoft.com/en-us/windows/desktop/api/winuser/nf-winuser-getwindowlongptrw\" rel=\"nofollow noreferrer\">\n   <code>\n    GetWindowLongPtr\n   </code>\n  </a>\n  function with undocumented index\n  <code>\n   -1\n  </code>\n  as such:\n </p>\n <p>\n  <a href=\"https://i.sstatic.net/nwKov.png\" rel=\"nofollow noreferrer\">\n   <img alt=\"enter image description here\" src=\"https://i.sstatic.net/nwKov.png\"/>\n  </a>\n </p>\n <p>\n  Does anybody know what that function returns in that case?\n </p>\n</div>\n</body></html>",
    "votes": "3",
    "answers": 1,
    "views": "266",
    "tags": [
        "windows",
        "c",
        "winapi"
    ],
    "user": "c00000fd",
    "time": "Apr 12, 2019 at 20:27",
    "comments": [],
    "answers_data": [
        {
            "content": "<html><body><div class=\"s-prose js-post-body\" itemprop=\"text\">\n <p>\n  I think I got it.\n  <code>\n   GetWindowLongPtr(hWnd, -1)\n  </code>\n  returns a pointer to a nested\n  <code>\n   struct\n  </code>\n  that is a part of the\n  <a href=\"https://www.geoffchappell.com/studies/windows/win32/user32/structs/wnd/index.htm\" rel=\"noreferrer\">\n   <code>\n    WND\n   </code>\n  </a>\n  struct (that contains main information about a window.) There's really no official name for it, but judging by this function name in\n  <code>\n   comctrl32\n  </code>\n  :\n </p>\n <p>\n  <a href=\"https://i.sstatic.net/jM77Q.png\" rel=\"noreferrer\">\n   <img alt=\"enter image description here\" src=\"https://i.sstatic.net/jM77Q.png\"/>\n  </a>\n </p>\n <p>\n  I'd define it as such:\n </p>\n <pre><code>struct WF{\n    WF_STATE state;\n    WF_STATE2 state2;\n    DWORD ExStyles;     //With additional bits\n    DWORD Styles;\n    HMODULE hModule;\n    USHORT reserved;\n    USHORT fnid;        // ?\n};\n</code></pre>\n <p>\n  So we can do:\n </p>\n <pre><code>WF* p_wf = (WF*)::GetWindowLongPtr(hWnd, -1);\n</code></pre>\n <p>\n  Where\n  <a href=\"https://www.geoffchappell.com/studies/windows/win32/user32/structs/wnd/state.htm\" rel=\"noreferrer\">\n   <code>\n    WF_STATE\n   </code>\n  </a>\n  is a\n  <a href=\"https://doxygen.reactos.org/dd/d79/include_2ntuser_8h_source.html#l00572\" rel=\"noreferrer\">\n   bitfield\n  </a>\n  :\n </p>\n <pre><code>enum WF_STATE{\n    WNDS_HASMENU                 = 0x00000001,\n    WNDS_HASVERTICALSCROOLLBAR   = 0x00000002,\n    WNDS_HASHORIZONTALSCROLLBAR  = 0x00000004,\n    WNDS_HASCAPTION              = 0x00000008,\n    WNDS_SENDSIZEMOVEMSGS        = 0x00000010,\n    WNDS_MSGBOX                  = 0x00000020,\n    WNDS_ACTIVEFRAME             = 0x00000040,\n    WNDS_HASSPB                  = 0x00000080,\n    WNDS_NONCPAINT               = 0x00000100,\n    WNDS_SENDERASEBACKGROUND     = 0x00000200,\n    WNDS_ERASEBACKGROUND         = 0x00000400,\n    WNDS_SENDNCPAINT             = 0x00000800,\n    WNDS_INTERNALPAINT           = 0x00001000,\n    WNDS_UPDATEDIRTY             = 0x00002000,\n    WNDS_HIDDENPOPUP             = 0x00004000,\n    WNDS_FORCEMENUDRAW           = 0x00008000,\n    WNDS_DIALOGWINDOW            = 0x00010000,\n    WNDS_HASCREATESTRUCTNAME     = 0x00020000,\n    WNDS_SERVERSIDEWINDOWPROC    = 0x00040000,      //WndProc is in win32k.sys\n    WNDS_ANSIWINDOWPROC          = 0x00080000,\n    WNDS_BEINGACTIVATED          = 0x00100000,\n    WNDS_HASPALETTE              = 0x00200000,\n    WNDS_PAINTNOTPROCESSED       = 0x00400000,\n    WNDS_SYNCPAINTPENDING        = 0x00800000,\n    WNDS_RECEIVEDQUERYSUSPENDMSG = 0x01000000,\n    WNDS_RECEIVEDSUSPENDMSG      = 0x02000000,\n    WNDS_TOGGLETOPMOST           = 0x04000000,\n    WNDS_REDRAWIFHUNG            = 0x08000000,\n    WNDS_REDRAWFRAMEIFHUNG       = 0x10000000,\n    WNDS_ANSICREATOR             = 0x20000000,\n    WNDS_MAXIMIZESTOMONITOR      = 0x40000000,\n    WNDS_DESTROYED               = 0x80000000,\n};\n</code></pre>\n <p>\n  and\n  <a href=\"https://www.geoffchappell.com/studies/windows/win32/user32/structs/wnd/state2.htm\" rel=\"noreferrer\">\n   <code>\n    WF_STATE2\n   </code>\n  </a>\n  is another\n  <a href=\"https://doxygen.reactos.org/dd/d79/include_2ntuser_8h_source.html#l00608\" rel=\"noreferrer\">\n   bitfield\n  </a>\n  :\n </p>\n <pre><code>enum WF_STATE2{\n    WNDS2_WMPAINTSENT               = 0x00000001,\n    WNDS2_ENDPAINTINVALIDATE        = 0x00000002,\n    WNDS2_STARTPAINT                = 0x00000004,\n    WNDS2_OLDUI                     = 0x00000008,\n    WNDS2_HASCLIENTEDGE             = 0x00000010,\n    WNDS2_BOTTOMMOST                = 0x00000020,\n    WNDS2_FULLSCREEN                = 0x00000040,\n    WNDS2_INDESTROY                 = 0x00000080,\n    WNDS2_WIN31COMPAT               = 0x00000100,\n    WNDS2_WIN40COMPAT               = 0x00000200,\n    WNDS2_WIN50COMPAT               = 0x00000400,\n    WNDS2_MAXIMIZEDMONITORREGION    = 0x00000800,\n    WNDS2_CLOSEBUTTONDOWN           = 0x00001000,\n    WNDS2_MAXIMIZEBUTTONDOWN        = 0x00002000,\n    WNDS2_MINIMIZEBUTTONDOWN        = 0x00004000,\n    WNDS2_HELPBUTTONDOWN            = 0x00008000,\n    WNDS2_SCROLLBARLINEUPBTNDOWN    = 0x00010000,\n    WNDS2_SCROLLBARPAGEUPBTNDOWN    = 0x00020000,\n    WNDS2_SCROLLBARPAGEDOWNBTNDOWN  = 0x00040000,\n    WNDS2_SCROLLBARLINEDOWNBTNDOWN  = 0x00080000,\n    WNDS2_ANYSCROLLBUTTONDOWN       = 0x00100000,\n    WNDS2_SCROLLBARVERTICALTRACKING = 0x00200000,\n    WNDS2_FORCENCPAINT              = 0x00400000,\n    WNDS2_FORCEFULLNCPAINTCLIPRGN   = 0x00800000,\n    WNDS2_FULLSCREENMODE            = 0x01000000,\n    WNDS2_CAPTIONTEXTTRUNCATED      = 0x08000000,\n    WNDS2_NOMINMAXANIMATERECTS      = 0x10000000,\n    WNDS2_SMALLICONFROMWMQUERYDRAG  = 0x20000000,\n    WNDS2_SHELLHOOKREGISTERED       = 0x40000000,\n    WNDS2_WMCREATEMSGPROCESSED      = 0x80000000,\n};\n</code></pre>\n <p>\n  The\n  <a href=\"https://www.geoffchappell.com/studies/windows/win32/user32/structs/wnd/style.htm\" rel=\"noreferrer\">\n   <code>\n    Styles\n   </code>\n  </a>\n  and\n  <a href=\"https://www.geoffchappell.com/studies/windows/win32/user32/structs/wnd/exstyle.htm\" rel=\"noreferrer\">\n   <code>\n    ExStyles\n   </code>\n  </a>\n  members seem to closely resemble documented\n  <a href=\"https://docs.microsoft.com/en-us/windows/desktop/winmsg/window-styles\" rel=\"noreferrer\">\n   window styles\n  </a>\n  (and\n  <a href=\"https://docs.microsoft.com/en-us/windows/desktop/winmsg/extended-window-styles\" rel=\"noreferrer\">\n   extended styles\n  </a>\n  ) but have their own undocumented bits as well.\n </p>\n <p>\n  <code>\n   fnid\n  </code>\n  might be\n  <a href=\"https://github.com/tinysec/public/blob/master/win32k/fnID.md\" rel=\"noreferrer\">\n   this\n  </a>\n  , but I could not verify it.\n </p>\n</div>\n</body></html>",
            "votes": "5",
            "user": "c00000fd",
            "time": "Apr 13, 2019 at 7:53",
            "is_accepted": false,
            "comments": []
        }
    ]
}