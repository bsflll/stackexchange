{
    "title": "How can i inject xamarin smali code into another apk?",
    "link": "https://reverseengineering.stackexchange.com/questions/30458/how-can-i-inject-xamarin-smali-code-into-another-apk",
    "content": "<html><body><div class=\"s-prose js-post-body\" itemprop=\"text\">\n <p>\n  I tried to make a simple foreground service android application using xamarin... then decompile and inject it into another apk...but it always crashes.\n </p>\n <p>\n  here is adb logcat :\n </p>\n <pre><code>05-31 23:57:34.158  7680  7680 W Activity: Slow Operation: Activity com.injected.app/org.injected.cpp.AppActivity onCreate took 1440ms\n05-31 23:57:34.169  7680  7680 D injectedActivity: onResume()\n05-31 23:57:34.172  7680  7680 W AudioManager: Use of stream types is deprecated for operations other than volume control\n05-31 23:57:34.172 7680  7680 W AudioManager: See the documentation of requestAudioFocus() for what to use instead with android.media.AudioAttributes to qualify your playback use case\n05-31 23:57:34.180  7680  7680 D AudioFocusManager: requestAudioFocus succeed\n05-31 23:57:34.190  7436  7465 I ui.cloudservic: ProcessProfilingInfo new_methods=0 is saved saved_to_disk=0 resolve_classes_delay=8000\n05-31 23:57:34.196  7680  8021 I DpmTcmClient: RegisterTcmMonitor from: $Proxy0\n05-31 23:57:34.202  1617  4424 E WindowManager: App trying to use insecure INPUT_FEATURE_NO_INPUT_CHANNEL flag. Ignoring\n05-31 23:57:34.208  7680 7680 W Looper  : PerfMonitor longMsg : seq=3 plan=23:57:32.356 late=338ms wall=1514ms running=916ms runnable=174ms io=223ms h=android.app.ActivityThread$H w=159 procState=2\n05-31 23:57:34.208  7680  7680 W Looper  : PerfMonitor looperActivity : package=com.injected.app/org.injected.cpp.AppActivity time=1514ms latency=338ms running=916ms  procState=2 ClientTransaction{ callbacks=[android.app.servertransaction.LaunchActivityItem] lifecycleRequest=android.app.servertransaction.ResumeActivityItem } historyMsgCount=2 (msgIndex=2 wall=327ms seq=2 running=05ms runnable=83ms io=8ms late=20ms h=android.app.ActivityThread$H w=110)\n05-31 23:57:34.227 28 05 28517 W ocessService0:: Reducing the number of considered missed Gc histogram windows from 162 to 100\n05-31 23:57:34.232  7680  7680 W Looper  : PerfMonitor looperActivity : package=com.injected.app/org.injected.cpp.AppActivity time=0ms latency=1875ms running=0ms  procState=2 ClientTransaction{ callbacks=[android.app.servertransaction.TopResumedActivityChangeItem] } historyMsgCount=3 (msgIndex=2 wall=327ms seq=2 running=05ms runnable=83ms io=8ms late=20ms h=android.app.ActivityThread$H w=110) (msgIndex=3 wall=1514ms seq=3 running=916ms runnable=174ms io=223ms late=338ms h=android.app.ActivityThread$H w=159)\n05-31 23:57:34.233  7711  8033 I SecurityDevice: getService: sService == null. \n05-31 23:57:34.233  7711  8033 W SecurityDevice: getService: binder not alive. \n05-31 23:57:34.234  7680  7680 E m.injected.app: No implementation found for void mono.android.Runtime.register(java.lang.String, java.lang.Class, java.lang.String) (tried Java_mono_android_Runtime_register and Java_mono_android_Runtime_register__Ljava_lang_String_2Ljava_lang_Class_2Ljava_lang_String_2)\n05-31 23:57:34.241  7680  7680 D AndroidRuntime: Shutting down VM\n05-31 23:57:34.242  7680  7680 E AndroidRuntime: FATAL EXCEPTION: main\n05-31 23:57:34.242  7680  7680 E AndroidRuntime: Process: com.injected.app, PID: 7680\n05-31 23:57:34.242  7680  7680 E AndroidRuntime: java.lang.UnsatisfiedLinkError: No implementation found for void mono.android.Runtime.register(java.lang.String, java.lang.Class, java.lang.String) (tried Java_mono_android_Runtime_register and Java_mono_android_Runtime_register__Ljava_lang_String_2Ljava_lang_Class_2Ljava_lang_String_2)\n05-31 23:57:34.242  7680  7680 E AndroidRuntime:    at mono.android.Runtime.register(Native Method)\n05-31 23:57:34.242  7680  7680 E AndroidRuntime:    at crc6464567c73758a9f18.MainService.<clinit>(MainService.java:18)\n05-31 23:57:34.242  7680  7680 E AndroidRuntime:    at java.lang.Class.newInstance(Native Method)\n05-31 23:57:34.242  7680  7680 E AndroidRuntime:    at android.app.AppComponentFactory.instantiateService(AppComponentFactory.java:129)\n05-31 23:57:34.242  7680  7680 E AndroidRuntime:    at androidx.core.app.CoreComponentFactory.instantiateService(CoreComponentFactory.java:75)\n05-31 23:57:34.242  7680  7680 E AndroidRuntime:    at android.app.ActivityThread.handleCreateService(ActivityThread.java:4013)\n05-31 23:57:34.242  7680  7680 E AndroidRuntime:    at android.app.ActivityThread.access$1600(ActivityThread.java:229)\n05-31 23:57:34.242  7680  7680 E AndroidRuntime:    at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1917)\n05-31 23:57:34.242  7680  7680 E AndroidRuntime:    at android.os.Handler.dispatchMessage(Handler.java:107)\n05-31 23:57:34.242  7680  7680 E AndroidRuntime:    at android.os.Looper.loop(Looper.java:226)\n05-31 23:57:34.242  7680  7680 E AndroidRuntime:    at android.app.ActivityThread.main(ActivityThread.java:7592)\n05-31 23:57:34.242  7680  7680 E AndroidRuntime:    at java.lang.reflect.Method.invoke(Native Method)\n05-31 23:57:34.242  7680  7680 E AndroidRuntime:    at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:539)\n05-31 23:57:34.242  7680  7680 E AndroidRuntime:    at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:950)\n05-31 23:57:34.249  3690 14633 I CryptauthV2: [EnrollCryptauthFramework] SyncKeysRequest successfully completed\n05-31 23:57:34.251   634  8029 E ResolverController: No valid NAT64 prefix (109, <unspecified>/0)\n05-31 23:57:34.263  7974  7974 I FeatureParser: can't find citrus.xml in assets/device_features/,it may be in /vendor/etc/device_features\n05-31 23:57:34.266  7680  7680 D OOMEventManagerFK: checkEventAndDumpForJE: 0\n05-31 23:57:34.266  7974  7974 I SpaceUtils: owner space\n05-31 23:57:34.267  7680  7680 E m.injected.app: No implementation found for void mono.android.Runtime.propagateUncaughtException(java.lang.Thread, java.lang.Throwable) (tried Java_mono_android_Runtime_propagateUncaughtException and Java_mono_android_Runtime_propagateUncaughtException__Ljava_lang_Thread_2Ljava_lang_Throwable_2)\n05-31 23:57:34.284  7680  7680 I m.injected.app: Waiting for a blocking GC ProfileSaver\n05-31 23:57:34.314  7680  7680 I m.injected.app: WaitForGcToComplete blocked ProfileSaver on ClassLinker for 30.622ms\n</code></pre>\n</div>\n</body></html>",
    "votes": "0",
    "answers": 0,
    "views": "228",
    "tags": [
        "android",
        "apk",
        "injection",
        "dalvik"
    ],
    "user": "akunguti",
    "time": "May 31, 2022 at 20:32",
    "comments": [
        {
            "user": "Robert",
            "text": "<html><body><span class=\"comment-copy\">\n Android can not directly execute Xamarin code, that is done by the Mono execution environment which has to be included into the APK file as well. That means the .so files and all the dot net Xamarin dll files needed to be included as well. And it seems you have to properly register Mono engine on Java level. Decompile a standard Xamarin app to see what code you have to add.\n</span>\n</body></html>",
            "time": null
        },
        {
            "user": "akunguti",
            "text": "<html><body><span class=\"comment-copy\">\n what if the target apps is made with xamarin too?\n</span>\n</body></html>",
            "time": null
        },
        {
            "user": "Robert",
            "text": "<html><body><span class=\"comment-copy\">\n Then it could happen that the service uses a different code path and thus does not load the native mono libraries. Check the original APK code for\n <code>\n  System.loadLibrary\n </code>\n and similar calls where native libraries are loaded.\n</span>\n</body></html>",
            "time": null
        },
        {
            "user": "akunguti",
            "text": "<html><body><span class=\"comment-copy\">\n ok, i'll try to check the original APK code for System.loadLibrary. Thanks @Robert\n</span>\n</body></html>",
            "time": null
        }
    ],
    "answers_data": []
}