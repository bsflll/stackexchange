{
    "title": "Decrypt config.bin file from Huawei B5328 router. I have source files",
    "link": "https://reverseengineering.stackexchange.com/questions/21846/decrypt-config-bin-file-from-huawei-b5328-router-i-have-source-files",
    "content": "I need some help in decrypting the file <pre><code>config.bin</code></pre> generated by the page <pre><code>backup_setting.html</code></pre> from Huawei B5328 router.\nI have access to all files in the router, even the www files hosted on the <pre><code>www</code></pre> folder for the router. After analyzing the page <pre><code>backup_setting.html</code></pre> and checking the JavaScript <pre><code>.js</code></pre> files, I think someone who understands the JavaScript and some coding language will be able to encrypt and decrypt the config file easily.\nThe reason why I'm asking is that I want to enable telnet for this router from the WebUI, and I think it can be done through JavaScript or config file restore or maybe CGI command.\nHere is the link for all files including <pre><code>backup_setting.html</code></pre> and the whole\n<pre><code>www</code></pre> folder is posted [here][1], you can get the <pre><code>.js</code></pre> files etc.\nThanks for helping.\n\nYou were correct, analyzing the file  <pre><code>maintenance.cgi</code></pre>  gets this :\n<pre><code>DECIMAL       HEXADECIMAL     DESCRIPTION\n--------------------------------------------------------------------------------\n0             0x0             ELF, 32-bit MSB executable, ARM, version 1 (SYSV)\n67144         0x10648         Unix path: /var/tmp/update_info\n68293         0x10AC5         Unix path: /var/config/ucfg_config.xml\n68975         0x10D6F         Unix path: /var/config/ucfg_config.xml\n71140         0x115E4         XML document, version: \"1.0\"\n71741         0x1183D         HTML document header\n71804         0x1187C         HTML document header\n78624         0x13320         XML document, version: \"1.0\"\n81900         0x13FEC         PEM RSA private key\n</code></pre>\nNow, assuming I have the decrypted config file, if I encrypt this file into  <pre><code>config.bin</code></pre> file, I think it should work.\nCan someone help into decrypting or encrypting the file in the correct format? Thanks.\nAnalyzing a piece of code of <pre><code>maintenace.cgi</code></pre> gives the encrypt and decrypt cmd used :\n<pre><code> No Command [WebUpd]%s, recive file error case Parameters Abnormal.  [WebUpd]%s, Exit: %d  [WebUpd]----------------------------------------  main  write_file_form_encoded TR069_import  TR069_import  import_finish  file_check check_rsa_digest  [%02d-%02d-%02d %02d:%02d:%02d:%03ld]  ' >> /dev/console  echo '                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             [pbi] Failed to create key BIO [pbi] Failed to create RSA open file error\n  ----------------do decrypt file parse---------------\n  ----------------do encrypt file ----------------\n  %s ERROR: %s\n  Public Encrypt failed  Encrypted length =%d\n  Private Decrypt failed  Decrypted Text =%s\n Decrypted Length =%d\n  Hello this is PBI RSA test                                                                                                                   [bpi] caculate_sha_digest\n %02x  [bpi] get_sha_digest_in_image data_size=%d, privateKey size=%d\n [bpi] check_sha_digest\n caculate_sha_digest results\n  0x \n  public_encrypt\n image_buf_len =%d\n [pbi] get_sha_digest_in_image fail\n img_sha =%d\n  cal_sha =%d\n  [pbi] image SHA256 digest is wrong\n [pbi] image SHA256 digest MATCH !!!\n  [%02d-%02d-%02d %02d:%02d:%02d:%03ld]  ' >> /dev/console  echo '                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ;    %02hhx delitem_1 = %s\n del_count =  %d\n  ,  00 parment of index is wrong  <%s>  Error  Invalid index number.  </%s>\n wrong parment of del_count! [deleteNthValueMultiWithDataCheck]value:[%s],rulsCount = %d count = %d the index of content max than ruls count  the contexts are diff  11  the index is valied the contexts are diff  22  the contexts are diff  33  what about the value rec is:%s ,hashcode is :%s , and data->hashcode is:%s\n %s ;%s [utils] i=%d,rec=%s\n  [utils] num=%d\n [utils_FilterReplaceOperation] i=%d,num=%d\n br0 [utils] getLanInfoList\n /proc/net/arp  r  %19s  %hhu.%hhu.%hhu.%hhu %hhx:%hhx:%hhx:%hhx:%hhx:%hhx  0x%x  [utils] get_arp_flags arp_flags = %d\n  [utils] lan_info_count %d\n  stat_info...  \n  :  [util] getWlanMacList\n /proc/wlan0/sta_info      hwaddr [util] get wlan MAC %s \n  The public port \"%d\" is used with TCP and UDP, please use another one. The public port \"%d\"-\"%d\" is used with TCP and UDP, please use another one. The public port \"%d\" is used with TCP, please use another one. The public port \"%d\"-\"%d\" is used with TCP, please use another one. The public port \"%d\" is used with UDP, please use another one. The public port \"%d\"-\"%d\" is used with UDP, please use another one. The public port is used, please use another.  (%d)(%s)(%s)... utils.cgi.c i: %d, ignoredIdx: %d  sFromPort1: %s, sToPort1: %s, sProtocol1: %s  sFromPort: %s, sToPort: %s, sProtocol: %s  iFromPort1: %d, iToPort1: %d, Protocol1: %d TCP UDP TCP_UDP iFromPort: %d, iToPort: %d, Protocol: %d  check webs_isPublicPortUsed 1  check webs_isPublicPortUsed 2  check webs_isPublicPortUsed 3  check webs_isPublicPortUsed 4  session_stok  sess_stok  [www]cgi getSessinStok ok  RoamSetting AttachSetting  AttachManual  DeatchManual  PDNcfgSetting  DataManualConnect  SetSelectMode  SetPlmnId  SetFotaUrl JoinWps Check  DiagnosticCmd  \\B2 \\B2 \\B2, \\B2< \\B2L \\B2\\ \\B2p \\B2\\80 \\B2\\8C \\B2\\98 \\B2\\A0 \\B2\\A8[www]cgi_response_sess_stok ok Content-type: text/xml\n</code></pre>\nAlso in <pre><code>rsa.js</code></pre> file public key is displayed :\n<pre><code>encrypt: function($data, $pubkey) {\n        if (!$pubkey) return false;\n        var bytes = ($pubkey.modulus.bitLength()+7)>>3;\n        $data = this.pkcs1pad2($data,bytes);\n        if(!$data) return false;\n        $data = $data.modPowInt($pubkey.encryptionExponent, $pubkey.modulus);\n        if(!$data) return false;\n        $data = $data.toString(16);\n        while ($data.length < bytes*2)\n            $data = '0' + $data;\n        return Base64.encode(Hex.decode($data));\n    },\n    encryptByDefaultKey: function($data, ispost){\n</code></pre>\n",
    "votes": "0",
    "answers": 1,
    "views": "2k",
    "tags": [
        "decryption",
        "javascript",
        "websites"
    ],
    "user": "coolirc",
    "time": "Dec 6, 2021 at 5:16",
    "comments": [
        {
            "user": "Killua Zoldyck DK",
            "text": "Hi coolirc can you help me plz ^__^ I have the same model (From mobilis operator ) my problem that it boot and both power and Wlan showup green light but when connecting it with LAN/WIFI i don't get IP @ over DHCP i did try static ip in my desktop but seems that the router doesn't have IP @ (maybe memory problem)\n",
            "time": null
        }
    ],
    "answers_data": [
        {
            "content": "Unfortunately, knowledge of JS probably isn't going to help. The HTML passes along the uploaded file to the <pre><code>cgi-bin/maintenance.cgi</code></pre> file which is a compiled ARM BE8 binary that's a bit more work to analyze than just looking at some javascript.\nAfter a very brief look, there is an RSA public/private key pair embedded in the binary that might be useful for extracting the contents of the config. \nThat said, I'm not sure that decrypting the config will necessarily get you what you want. You might actually have everything you need already. For example, there's a ton of calls to <pre><code>system</code></pre> inside those files. There's a decent chance that you could use one of those to get command-injection on the router to enable a terminal that way.\nAnd even that might actually be overkill if the router itself listens on telnet as a part of its bootup process which is fairly common.\nFinally, there appears to be a telnet enabled config you can load from the <pre><code>backup_setting.html</code></pre> page as there is a snippet there that references a config with telnet in the name. In fact, that's the only mention of telnet in all the files, so there's not likely some default intended way to enable it via the built in binaries. \n<pre><code>        if(filename.match(\"(.*)telnet(.*).bin\") == null){\n            AlertBlock('The router will restart after you restore it to the backup settings.Are you sure you want to import the config?','preConfigImport()','refreshpage()');\n</code></pre>\n",
            "votes": "1",
            "user": "Jordan",
            "time": "Aug 6, 2019 at 4:06",
            "is_accepted": false,
            "comments": []
        }
    ]
}