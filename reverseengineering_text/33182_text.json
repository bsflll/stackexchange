{
    "title": "Gerrit send js `fetch` to post a reply to a patch",
    "link": "https://reverseengineering.stackexchange.com/questions/33182/gerrit-send-js-fetch-to-post-a-reply-to-a-patch",
    "content": "With a gerrit server at <pre><code>http://<server>/</code></pre>, I want to use javascript to POST a reply to a given patch, and that reply should be from my user account. If I manually send a reply using the gerrit UI and then use the inspector to copy a <pre><code>fetch</code></pre> command, I get something like:\n<pre><code>await fetch(\"http://builder.cubespace.co.za:8080/changes/sofia~2366/revisions/4/review\", {\n    \"credentials\": \"include\",\n    \"headers\": {\n        \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:128.0) Gecko/20100101 Firefox/128.0\",\n        \"Accept\": \"*/*\",\n        \"Accept-Language\": \"en-US,en;q=0.5\",\n        \"content-type\": \"application/json\",\n        \"x-gerrit-auth\": \"abc\",\n        \"Priority\": \"u=0\"\n    },\n    \"body\": \"{\\\"drafts\\\":\\\"PUBLISH_ALL_REVISIONS\\\",\\\"labels\\\":{\\\"Code-Review\\\":0,\\\"Verified\\\":0,\\\"MISRA\\\":0,\\\"Style\\\":0,\\\"Unit-Tests\\\":0,\\\"Doxygen\\\":0,\\\"Python\\\":0,\\\"Regression-Jig\\\":0,\\\"Regression-Jig-CC\\\":0},\\\"message\\\":\\\"Example reply for testing\\\",\\\"reviewers\\\":[]}\",\n    \"method\": \"POST\",\n    \"mode\": \"cors\"\n});\n</code></pre>\nor as a <pre><code>cURL</code></pre> request (I've replaced cookies/auth with <pre><code>abc</code></pre>, <pre><code>bcd</code></pre>, <pre><code>cde</code></pre>, etc):\n<pre><code>curl \\\n    'http://builder.cubespace.co.za:8080/changes/sofia~2366/revisions/4/review' \\\n    -X POST \\\n    -H 'User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:128.0) Gecko/20100101 Firefox/128.0' \\\n    -H 'Accept: */*' \\\n    -H 'Accept-Language: en-US,en;q=0.5' \\\n    -H 'Accept-Encoding: gzip, deflate' \\\n    -H 'content-type: application/json' \\\n    -H 'x-gerrit-auth: abc' \\\n    -H 'Origin: http://builder.cubespace.co.za:8080' \\\n    -H 'Connection: keep-alive' \\\n    -H 'Cookie: _ga_RJRD1SNY74=def; _ga=cde; GerritAccount=bcd; XSRF_TOKEN=abc' \\\n    -H 'Priority: u=0' \n    --data-raw '{\"drafts\":\"PUBLISH_ALL_REVISIONS\",\"labels\":{\"Code-Review\":0,\"Verified\":0,\"MISRA\":0,\"Style\":0,\"Unit-Tests\":0,\"Doxygen\":0,\"Python\":0,\"Regression-Jig\":0,\"Regression-Jig-CC\":0},\"message\":\"Example reply for testing\",\"reviewers\":[]}'\n</code></pre>\nI want to be able to make a JS fetch request to post custom messages (we have some CI/CD that kicks off based on certain messages being sent, and I want to automate this process a bit more).\nI can't figure out how to get the correct value for the auth headers/cookies. This is just a JS snippet for me to run via greasemonkey, so I'm not terribly worried about security just yet.\nWhat I've tried:\n\nI tried looking here, but couldn't see how to convert the Java to JS.\n\nI see here mentions that I might not need the XSRF tokens for automation, but if I omit them I get 403s.\n\nI also see this SO answer says to parse xGerritAuth out of the HTML response, although I'm not sure how I'd do that from JS running in a page that's already been loaded.\n\nThe gerrit REST API docs didn't seem to have anything about sending messages.\n\nAsking on stack overflow, although it was said that this was a better place for this sort of question since it seems like the Gerrit API doesn't explicitly have an endpoint for something like this\n\n\nHow do I make a JS fetch request to post authenticated custom messages via the gerrit API?\n",
    "votes": "0",
    "answers": 0,
    "views": "19",
    "tags": [
        "javascript",
        "api",
        "automation"
    ],
    "user": "beyarkay",
    "time": "Aug 27, 2024 at 6:12",
    "comments": [],
    "answers_data": []
}