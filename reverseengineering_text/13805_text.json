{
    "title": "Windows XP kernel debugging",
    "link": "https://reverseengineering.stackexchange.com/questions/13805/windows-xp-kernel-debugging",
    "content": "I'm trying to debug Windows XP's kernel with KD but every time I start the debugger,it seem to crash.\nSetup\nWindows 10 (host machine,running kd)\nWindows XP x86 SP3 VM (being debugged)\n\nI configured a serial port with the following parameters:\n\n\nEdited boot.ini on the target OS\n(on VMware) Use named pipe <pre><code>\\\\.\\pipe\\com_1</code></pre>\n<pre><code>This end is the server</code></pre>\n<pre><code>The other end is an application</code></pre>\n\n\nWhen I try to connect to my VM I use:\n<pre><code>kd -y srv*c:\\symbols*https://msdl.microsoft.com/download/symbols -k com:port=\\\\.\\pipe\\com_1,pipe</code></pre>\nAfter which I get this output:\n<pre><code>Copyright (c) Microsoft Corporation. All rights reserved.\n\nOpened \\\\.\\pipe\\com_1\nKernel Debug Target Status: [no_debuggee]; Retries: [0] times in last [7] seconds.\nWaiting to reconnect...\nUnable to read head of debugger data list, Win32 error 0n56\nConnected to Windows XP 2600 x86 compatible target at (Mon Oct 24 20:21:44.286 2016 (UTC + 2:00)), ptr64 FALSE\nKernel Debugger connection established.\n\n************* Symbol Path validation summary **************\nResponse                         Time (ms)     Location\nDeferred                                       srv*c:\\symbols*https://msdl.microsoft.com/download/symbols\nDeferred                                       srv*c:symbols*http://msdl.microsoft.com/download/symbols\nSymbol search path is: srv*c:\\symbols*https://msdl.microsoft.com/download/symbols;srv*c:symbols*http://msdl.microsoft.com/download/symbols\nExecutable search path is:\nWindows XP Kernel Version 2600 UP Free x86 compatible\nBuilt by: 2600.xpsp_sp3_qfe.130704-0421\nMachine Name:\nKernel base = 0x804d7000 PsLoadedModuleList = 0x805541c0\nSystem Uptime: not available\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   52: ERROR: UMRxReadDWORDFromTheRegistry/ZwQueryValueKey: NtStatus = c0000034\nERROR: DavReadRegistryValues/RegQueryValueExW(4). WStatus = 127\nERROR: DavReadRegistryValues/RegQueryValueExW(5). WStatus = 127\nERROR: DavReadRegistryValues/RegQueryValueExW(6). WStatus = 127\nwatchdog!WdUpdateRecoveryState: Recovery enabled.\nBreak instruction exception - code 80000003 (first chance)\n*******************************************************************************\n*                                                                             *\n*   You are seeing this message because you pressed either                    *\n*       CTRL+C (if you run console kernel debugger) or,                       *\n*       CTRL+BREAK (if you run GUI kernel debugger),                          *\n*   on your debugger machine's keyboard.                                      *\n*                                                                             *\n*                   THIS IS NOT A BUG OR A SYSTEM CRASH                       *\n*                                                                             *\n* If you did not intend to break into the debugger, press the \"g\" key, then   *\n* press the \"Enter\" key now.  This message might immediately reappear.  If it *\n* does, press \"g\" and \"Enter\" again.                                          *\n*                                                                             *\n*******************************************************************************\nnt+0x50d2c:\n80527d2c cc              int     3\nkd>\n</code></pre>\nProblems\n\nAccording to what I found searching around it is correct that the OS freezes as it is in debug mode. Can I actually run and stop it's execution later with breakpoints and such (I know breakpoints can be placed,but I don't know how to execute kernel code)?\nAlso, I'm trying to decompile some routines, and I would like to know if there is any command that allows me to know whether arguments are required by the function.\nTrying to use the following variable types in KD doesn't work (I guess they're not symbols). What can I do if I want to see the fields in these structures ?\n\n<pre><code>NTKERNELAPI VOID KeInitializeApc (\n\nIN PRKAPC Apc,\n\nIN PKTHREAD Thread,\n\nIN KAPC_ENVIRONMENT Environment,\n\nIN PKKERNEL_ROUTINE KernelRoutine,\n\nIN PKRUNDOWN_ROUTINE RundownRoutine OPTIONAL,\n\nIN PKNORMAL_ROUTINE NormalRoutine OPTIONAL,\n\nIN KPROCESSOR_MODE ApcMode,\n\nIN PVOID NormalContext\n\n);\n</code></pre>\n\n\nEDIT 1: whatever I had with 'g' is gone,and I can run the XP VM.\n",
    "votes": "0",
    "answers": 1,
    "views": "2k",
    "tags": [
        "windows",
        "debugging",
        "kernel"
    ],
    "user": "shxdow",
    "time": "Oct 25, 2016 at 19:06",
    "comments": [
        {
            "user": "Martin",
            "text": "<pre><code>Trying to use the following variable types in KD doesn't work</code></pre> - how are you using it? What are you trying to do? Apart from that - have you considered using other debuggers, such as WinDbg? It has a GUI and is much more friendly to beginners.\n",
            "time": null
        },
        {
            "user": "shxdow",
            "text": "I.E: kd > dt PKKERNEL_ROUTINE\n",
            "time": null
        }
    ],
    "answers_data": [
        {
            "content": "but every time I start the debugger,it seem to crash.\n\nand\n\nAccording to what I found searching around it is correct that the OS freezes as it is in debug mode.\n\nExactly. It's not crashing, it's only putting a breakpoint at system level:\n<pre><code>*******************************************************************************\n*                                                                             *\n*   You are seeing this message because you pressed either                    *\n*       CTRL+C (if you run console kernel debugger) or,                       *\n*       CTRL+BREAK (if you run GUI kernel debugger),                          *\n*   on your debugger machine's keyboard.                                      *\n*                                                                             *\n*                   THIS IS NOT A BUG OR A SYSTEM CRASH                       *\n*                                                                             *\n* If you did not intend to break into the debugger, press the \"g\" key, then   *\n* press the \"Enter\" key now.  This message might immediately reappear.  If it *\n* does, press \"g\" and \"Enter\" again.                                          *\n*                                                                             *\n*******************************************************************************\n</code></pre>\nSimply press g then Enter. Do it again if it doesn't work, and it should run properly. Press Ctrl+C (for <pre><code>kd</code></pre>) or Ctrl+Break (for <pre><code>windbg</code></pre>) to break (i.e. \"pause\" the system) again.\n\n\nAlso, I'm trying to decompile some routines, and I would like to know if there is any command that allows me to know whether arguments are required by the function.\n\nYou need to load the symbols for the module you're going to debug. To do so, you have a few handy commands:\n\n<pre><code>.symfix</code></pre> - Fix symbol path\n\nThis command sets the symbol path to point to the Microsoft symbol store, i.e. makes your debugger download necessary symbols when needed.\n\n<pre><code>.reload</code></pre> - the Reload Module\n\nThis is the command you will use to load symbols for the module you're interested in. If you were interested in e.g. <pre><code>sysaudio.sys</code></pre>, you'd run the command <pre><code>.reload /f sysaudio.sys</code></pre> - where the <pre><code>/f</code></pre> flag makes the command immediately load the symbols. For your example, <pre><code>KeInitializeApc</code></pre>, you'd need to reload <pre><code>nt</code></pre>. I explain how I found it below.\n\n<pre><code>lm</code></pre> - List Loaded Modules\n\nThis will show the currently loaded modules. Useful for finding the base address of the module you're interested in (for example, <pre><code>sysaudio.sys</code></pre>)\n\n\nTo find KeInitializeApc, you would need to use the <pre><code>x</code></pre> command, like this:\n<pre><code>0: kd> x *!KeInitializeAPC\n82aebdf3          nt!KeInitializeApc (<no parameter info>)\n</code></pre>\nAs you can see, the command shows us the offset of the function (you'll use it later with <pre><code>u</code></pre>), its module (<pre><code>nt</code></pre>), and its full, correct name (<pre><code>nt!KeInitializeApc</code></pre>).\nThe <pre><code>x</code></pre> command looks like:\n<pre><code>x module!symbol\n</code></pre>\nYou can use wildcards like in my example above, specify options, etc. More info about the command in MSDN.\nTL;DR\nTo find <pre><code>KeInitializeApc</code></pre>, you'd do:\n<pre><code>kd> .symfix # make the debugger download symbols it needs\nkd> .reload # reload symbols NOW\nkd> x *!KeInitializeAPC # find desired function\n82aebdf3          nt!KeInitializeApc (<no parameter info>)\nkd> u 82aebdf3 # unassemble (disassemble)\nnt!KeInitializeApc:\n82aebdf3 8bff            mov     edi,edi\n82aebdf5 55              push    ebp\n82aebdf6 8bec            mov     ebp,esp\n82aebdf8 8b4508          mov     eax,dword ptr [ebp+8]\n82aebdfb 8b5510          mov     edx,dword ptr [ebp+10h]\n82aebdfe 8b4d0c          mov     ecx,dword ptr [ebp+0Ch]\n82aebe01 c60012          mov     byte ptr [eax],12h\n82aebe04 c6400230        mov     byte ptr [eax+2],30h\n</code></pre>\nFrom there, the decompilation is up to you. You now have the disassembly. I used the <pre><code>u</code></pre> command, which means unassemble. You can also use <pre><code>uf</code></pre> (unassemble function) to get a more function-friendly output, like this:\n<pre><code>kd> uf 82aebdf3 # unassemble function\nnt!KeInitializeApc:\n82aebdf3 8bff            mov     edi,edi\n82aebdf5 55              push    ebp\n82aebdf6 8bec            mov     ebp,esp\n82aebdf8 8b4508          mov     eax,dword ptr [ebp+8]\n82aebdfb 8b5510          mov     edx,dword ptr [ebp+10h]\n82aebdfe 8b4d0c          mov     ecx,dword ptr [ebp+0Ch]\n82aebe01 c60012          mov     byte ptr [eax],12h\n82aebe04 c6400230        mov     byte ptr [eax+2],30h\n82aebe08 83fa02          cmp     edx,2\n82aebe0b 7506            jne     nt!KeInitializeApc+0x20 (82aebe13)  Branch\n\nnt!KeInitializeApc+0x1a:\n82aebe0d 8a9134010000    mov     dl,byte ptr [ecx+134h]\n\nnt!KeInitializeApc+0x20:\n82aebe13 894808          mov     dword ptr [eax+8],ecx\n...\n</code></pre>\n\nEdit\n\nThe part regarding parameters is exactly what I'm looking for\n\nI dumped the PDBs and found no parameter info, so I'd guess that Microsoft simply didn't release it.\nHere's what I did:\n\nFind the file where <pre><code>KeInitializeApc</code></pre> is:\n<pre><code>kd> x *!KeInitializeApc\n82abbdf3          nt!KeInitializeApc (<no parameter info>)\nkd> !address 82abbdf3\n...\n...\nModule name:            ntoskrnl.exe\nModule path:            [\\SystemRoot\\system32\ntkrnlpa.exe]\n</code></pre>\nDownload the symbols for <pre><code>ntoskrnl</code></pre>:\n<pre><code>cmd> symchk /v C:\\windows\\system32\ntoskrnl.exe\n...\n...\nPdbFilename         C:\\Windows\\SYMBOLS\ntkrnlmp.pdb\\9E22A5947A15489895CE716436B45BE02\ntkrnlmp.pdb\n...\n</code></pre>\n\n(you can find <pre><code>symchk.exe</code></pre> in the same folder as <pre><code>windbg.exe</code></pre>)\n\nUse Microsoft's <pre><code>cvdump</code></pre> tool to dump the PDB into a text file:\n<pre><code>cmd> cvdump C:\\Windows\\SYMBOLS\ntkrnlmp.pdb\\9E22A5947A15489895CE716436B45BE02\ntkrnlmp.pdb > out\n</code></pre>\nOpen the file and search for <pre><code>KeInitializeAPC</code></pre>. One hit:\n<pre><code>S_PUB32: [0001:00071654], Flags: 00000002, KeInitializeApc\n</code></pre>\nSearch for <pre><code>KeInitializeApc</code></pre> again (no results), or its ID (I guess?), <pre><code>[0001:00071654]</code></pre> -> <pre><code>71654</code></pre>. One result:\n<pre><code>  *** SECTION CONTRIBUTIONS\n\n  Imod  Address        Size      Characteristics\n  01B9  0001:00071654  00000098  60303020\n</code></pre>\nDump PDB types with <pre><code>cvdump -t</code></pre>\nNo type info available for <pre><code>01B9</code></pre>\n\nAdditionally, I downloaded checked symbols (they supposedly have more information in them) and repeated the process for those, but couldn't find anything either.\n\n\nAnd after pressing \"g\" nothing happens,for a while, to the point that I decide to break again. Is it supposed to take long ? \n\nWhen you press g, you're basically telling the debugger to run the OS. Whenever it is running, the debugger can't do anything but wait until it breaks. Since the OS is running normally, it will not stop until you manually break. Therefore, you have to break before inputting any command.\n\n\nkd > dt PKKERNEL_ROUTINE\n\nApparently, there aren't any <pre><code>Ke*</code></pre> symbols:\n<pre><code>kd> dt nt*!Ke*                             # nothing here\nkd> dt nt!LIST_ENTRY*                     # Symbols are working properly,\n          ntkrpamp!LIST_ENTRY64           # because this works\n          ntkrpamp!LIST_ENTRY32\nkd> dt nt!LIST_ENTRY64                    # dt works properly. Therefore,\n   +0x000 Flink            : Uint8B       # Ke* doesn't have any symbols\n   +0x008 Blink            : Uint8B\n</code></pre>\nYou'll have to reverse the code yourself and name the params, or find them somewhere in the internet, because apparently they aren't in the PDBs.\n",
            "votes": "1",
            "user": "Martin",
            "time": "Oct 25, 2016 at 20:33",
            "is_accepted": true,
            "comments": [
                {
                    "user": "shxdow",
                    "text": "<span class=\"comment-copy\"><code>82aebdf3          nt!KeInitializeApc (&lt;no parameter info&gt;)</code>. The part regarding parameters is exactly what I'm looking for. And after pressing \"g\" nothing happens,for a while, to the point that I decide to break again. Is it supposed to take long ?</span>",
                    "time": null
                },
                {
                    "user": "shxdow",
                    "text": "<span class=\"comment-copy\">UPDATE: what ever I had with 'g' is now gone,and I can successfully run the debugged OS.</span>",
                    "time": null
                },
                {
                    "user": "Martin",
                    "text": "<span class=\"comment-copy\">@shxdow I made an edit, please see if that answers your question.</span>",
                    "time": null
                }
            ]
        }
    ]
}