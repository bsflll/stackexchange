{
  "title": "Why does dup2(2) function has no effect here?",
  "link": "https://reverseengineering.stackexchange.com/questions/33167/why-does-dup22-function-has-no-effect-here",
  "content": "I am trying to solve The Protostar Net One task.\n\nWhen I open the net1 binary with strace -f ./net1 I get this result. In which the program clones itself, kills the parent, and dups all standard file descriptors to /dev/null.\n\n```\nexecve(\"./net1\", [\"./net1\"], [/* 15 vars */]) = 0\nbrk(0)                                  = 0x804b000\naccess(\"/etc/ld.so.nohwcap\", F_OK)      = -1 ENOENT (No such file or directory)\nmmap2(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0xb7fe0000\naccess(\"/etc/ld.so.preload\", R_OK)      = -1 ENOENT (No such file or directory)\nopen(\"/etc/ld.so.cache\", O_RDONLY)      = 3\nfstat64(3, {st_mode=S_IFREG|0644, st_size=13796, ...}) = 0\nmmap2(NULL, 13796, PROT_READ, MAP_PRIVATE, 3, 0) = 0xb7fdc000\nclose(3)                                = 0\naccess(\"/etc/ld.so.nohwcap\", F_OK)      = -1 ENOENT (No such file or directory)\nopen(\"/lib/libc.so.6\", O_RDONLY)        = 3\nread(3, \"\\177ELF\\1\\1\\1\\0\\0\\0\\0\\0\\0\\0\\0\\0\\3\\0\\3\\0\\1\\0\\0\\0\\320m\\1\\0004\\0\\0\\0\"..., 512) = 512\nfstat64(3, {st_mode=S_IFREG|0755, st_size=1319176, ...}) = 0\nmmap2(NULL, 1329480, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0xb7e97000\nmprotect(0xb7fd5000, 4096, PROT_NONE)   = 0\nmmap2(0xb7fd6000, 12288, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x13e) = 0xb7fd6000\nmmap2(0xb7fd9000, 10568, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0xb7fd9000\nclose(3)                                = 0\nmmap2(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0xb7e96000\nset_thread_area({entry_number:-1 -> 6, base_addr:0xb7e966c0, limit:1048575, seg_32bit:1, contents:0, read_exec_only:0, limit_in_pages:1, seg_not_present:0, useable:1}) = 0\nmprotect(0xb7fd6000, 8192, PROT_READ)   = 0\nmprotect(0xb7ffe000, 4096, PROT_READ)   = 0\nmunmap(0xb7fdc000, 13796)               = 0\nrt_sigaction(SIGCHLD, {0x8048e24, [CHLD], SA_RESTART}, {SIG_DFL, [], 0}, 8) = 0\nrt_sigaction(SIGPIPE, {SIG_IGN, [PIPE], SA_RESTART}, {SIG_DFL, [], 0}, 8) = 0\nopen(\"/opt/protostar/run/net1.pid\", O_RDWR|O_CREAT|O_TRUNC, 0700) = 3\nsetgroups32(1, [998])                   = 0\nsetresgid32(998, 998, 998)              = 0\nsetresuid32(998, 998, 998)              = 0\nclone(Process 2161 attached\nchild_stack=0, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD, child_tidptr=0xb7e96728) = 2161\n[pid  2160] exit_group(0)               = ?\nsetsid()                                = 2161\nchdir(\"/\")                              = 0\nopen(\"/dev/null\", O_RDWR)               = 4\nfstat64(4, {st_mode=S_IFCHR|0666, st_rdev=makedev(1, 3), ...}) = 0\ndup2(4, 0)                              = 0\ndup2(4, 1)                              = 1\ndup2(4, 2)                              = 2\nclose(4)                                = 0\nwrite(3, \"2161  \n\", 5)                   = 5\nclose(3)                                = 0\nsocket(PF_INET, SOCK_STREAM, IPPROTO_IP) = 3\nsetsockopt(3, SOL_SOCKET, SO_REUSEADDR, [1], 4) = 0\nbind(3, {sa_family=AF_INET, sin_port=htons(2998), sin_addr=inet_addr(\"0.0.0.0\")}, 16) = 0\nlisten(3, 10)                           = 0\naccept(3,\n\n```\nThe main part of interest to me are the lines which contains the function dup2. As seen, this function makes the standard input, output and error a copy of /dev/null. Which means, the program is supposed to throw everything comes in and out to the black hole (I am very suspicious I am wrong somewhere in this idea).\n\nBut when the program prints out an integer with the write syscall as below\n\n```\nwrite(0, &wanted, sizeof(wanted))\n\n```\nI can see the printed out text in my terminal. Which means the program did not throw what comes in to its standard input (file descriptor 0) to the black hole but printed it out.\n\n",
  "votes": "0",
  "answers": 0,
  "views": "25",
  "tags": [
    "binary-analysis",
    "syscall"
  ],
  "user": "Abw",
  "time": "Aug 18, 2024 at 13:57",
  "comments": [],
  "answers_data": []
}